"use strict";(function(){$.extend(pbaAPI,{log:function(n){application.isDebug&&console.log(n)},imageHelpers:{src:function(n,t,i){if(n=$(n),i=i||"",n.length){var r=n.attr("width"),u=n.attr("height");n.attr("src",this.getsrc(t,r,u,i))}},getsrc:function(n,t,i,r){return application.url.GetFiles("GetImage",{id:n,width:t,height:i,defImage:r})},getImageSrc:function(n,t,i,r,u){return n?application.url.GetFiles("GetImage",{id:n.FileID,width:t,height:i,defImage:r,type:u}):application.url.GetFiles("GetImage",{id:null,width:t,height:i,defImage:r,type:u})},getImageThumbnailSrc:function(n,t,i,r,u,f){return n?application.url.GetFiles("GetImageThumbnail",{id:n.FileID,size:t,defImage:i,type:r,scale:u,anchor:f}):application.url.GetFiles("GetImageThumbnail",{id:null,size:t,defImage:i,type:r,scale:u,anchor:f})}},getHrefFile:function(n){return application.url.GetFiles("GetFile",{fileid:n})},getFileWidget:function(n,t){$.get(application.url.GetFileData("GetWidget"),{id:n},function(n){t(n.html)})},getPrVal:function(n,t,i){for(var u,f=t.split("."),r=0;r<f.length;r++){u=f[r];try{if(u in n){if(n=n[u],!n)return i}else return i}catch(e){return n?pbaAPI.htmlEncode(n):n}}return n?pbaAPI.htmlEncode(n):n},getCollectionPrVal:function(n,t,i){var r=i,u;if(n){for(r="<ul>",u=0;u<n.length;u++)r+="<li>"+pbaAPI.getPrVal(n[u],t,"")+"<\/li>";r+="<\/ul>"}return r},replaceObjectPlaceholders:function(n,t){var i={};return $.each(t,function(r){i[r]=t[r].replace(/\[(.*?)\]/g,function(t,i){return n[i]})}),i},replaceListPlaceholders:function(n,t){var i={};return $.each(t,function(r){i[r]=t[r].replace(/\[(.*?)\]/g,function(t,i){return n[i]})}),i},extension:function(n){if(!n||typeof n!="string")return null;var t=n.toLowerCase().split(".");return t[t.length-1]},_fileTypes:{text:"txt,doc,rtf,log,tex,msg,text,wpd,wps,docx,page",table:"csv,dat,tar,xml,vcf,pps,key,ppt,pptx,sdf,gbr,ged",sound:"mp3,m4a,waw,wma,mpa,iff,aif,ra,mid,m3v",video:"e-3gp,shf,avi,asx,mp4,e-3g2,mpg,asf,vob,wmv,mov,srt,m4v,flv,rm",image:"png,psd,psp,jpg,jpeg,tif,tiff,gif,bmp,tga,thm,yuv,dds",vector:"ai,eps,ps,svg",exdoc:"pdf,pct,indd",spreadsheet:"xlr,xls,xlsx",database:"db,dbf,mdb,pdb,sql,aacd",executable:"app,exe,com,bat,apk,jar,hsf,pif,vb,cgi",code:"css,js,php,xhtml,htm,html,asp,cer,jsp,cfm,aspx,rss,csr,less",font:"otf,ttf,font,fnt,eot,woff",archive:"zip,zipx,rar,targ,sitx,deb,e-7z,pkg,rpm,cbr,gz",mount:"dmg,cue,bin,iso,hdf,vcd",system:"bak,tmp,ics,msi,cfg,ini,prf"},fileType:function(n){var i=pbaAPI.extension(n),t;if(!i)return null;for(t in pbaAPI._fileTypes)if(pbaAPI._fileTypes.hasOwnProperty(t)&&pbaAPI._fileTypes[t].split(",").indexOf(i)!==-1)return t;return null},extensionClass:function(n){var t=pbaAPI.extension(n),i;return t?(i=!!pbaAPI.fileType(t),i?"filetype filetype-"+t:"default-file"):null},replaceUrlParametr:function(n,t,i){var u="([?|&])"+t+"=.*?(&|$)",r=new RegExp(u,"i"),f=n.indexOf("?")!==-1?"&":"?";return n.match(r)?n.replace(r,"$1"+t+"="+i+"$2"):n+f+t+"="+i},getUrlParametr:function(n,t){var r="([?|&])"+t+"=.*?(&|$)",u=new RegExp(r,"i"),f=n.indexOf("?")!==-1?"&":"?",i=n.match(u);return i?i:null},addUrlParametrs:function(n,t){if(t)for(var i in t)n=pbaAPI.replaceUrlParametr(n,i,t[i]);return n},openModalDialog:function(n,t,i){application.viewModelConfigs.get(n).done(function(r){var u=$.extend({title:null,width:null,height:null,searchStr:null,filter:null,maximize:!1,initProps:null,transport:null,dialogData:{}},i),s=pbaAPI.uid("wid"),e,f,h,o;$("body").append('<div id="'+s+'" class="view-model-window wnd-loading-content"><\/div>');e=$("#"+s);f={mnemonic:n,typeDialog:"Modal"};u.searchStr!=null&&(f.searchStr=u.searchStr);u.filter!=null&&(f.filter=u.filter);h=u.title||(r?r.ListView?r.ListView.Title:r.Title:n);f.multiSelect=u.multiSelect;e.kendoWindow({width:u.width||application.getDefaultModalWidth("listview"),height:u.height||application.getDefaultModalHeight("listview"),title:h,actions:["Maximize","Close"],content:application.url.GetView("GetDialog",f),modal:!0,visible:!1,refresh:function(n){var i=n.sender.element,r=i.find(".dialog-listview").data("dialogListView");r.init({multiSelect:u.multiSelect,callbackSelect:t,dialogData:u.dialogData,initProps:u.initProps,transport:u.transport,customParams:u.customParams,close:function(){n.sender.close()}});r.resize(i.height());i.removeClass("wnd-loading-content")},close:function(){u.callbackCancel&&u.callbackCancel();e.empty()},open:function(n){u.zIndex&&$(n.sender.wrapper).css("z-index",u.zIndex)}});o=e.data("kendoWindow");o.center();o.toFront();o.open()})},wndID:function(n,t){if(typeof n=="string"&&n.indexOf("wnd_")===0)return n;if(!n)return pbaAPI.guid("wnd").replace(/\-/g,"");var i=t.split(",")[0];return"wnd_"+i.replace(/\./g,"_")+"_"+n},initViewModel:function(n,t){var u=n.Mnemonic,i=$.extend({wid:null,title:null,width:null,height:null},t),r;return i.wid=pbaAPI.wndID(i.wid,u),r=$("#"+i.wid),r.length||($("body").append('<div id="'+i.wid+'" class="view-model-window wnd-loading-content"><\/div>'),r=$("#"+i.wid)),r.data("kendoWindow")||r.kendoWindow({width:i.width||n.DetailView.Width||application.getDefaultModalWidth(),height:i.height||n.DetailView.Height||application.getDefaultModalHeight(),title:i.title||n.DetailView.Title||n.Title,actions:i.actions||["Maximize","Close"],content:application.url.GetView("GetPartialViewModel",{mnemonic:u,typeDialog:"Modal",isReadOnly:i.isReadOnly}),modal:!0,visible:!1}),r},selectSimple:function(n,t){var i=$.extend({wid:null,title:"Выбор...",width:400,height:500,template:"<li  class='list-group-item' href='\\\\#'><span class='#: Icon.Value #' style='color: #: Icon.Color #'><\/span>&nbsp#: Title || Name #<\/li>",callback:function(){},cancel:function(){},multiSelect:!1},t),u=[],r,f;if(i.wid=i.wid?"selectSimple_"+i.wid:pbaAPI.guid("selectSimple").replace(/\-/g,""),r=$("#"+i.wid),!r.length)if(f=$("body"),i.multiSelect){var o=i.wid+"_toolbar",s=i.wid+"_content",c="<div id='"+s+"'><div class='dialog'> <div class='dialog__toolbar'> <div class='kwidget kwidget--tolbar' id='"+o+"'/><\/div><ul id=\""+i.wid+'" class="view-model-window kwidget kwidget--list scrollable"><\/ul><\/div><\/div>';f.append(c);$("#"+o).kendoToolBar({items:[{attributes:{title:"Выбрать и закрыть","class":"primary",style:"float: right"},type:"button",text:"Выбрать и закрыть",spriteCssClass:"fa fa-check",showText:"overflow",click:function(){r.data("kendoWindow").destroy();i.callback(u)}}]});r=$("#"+s)}else f.append('<ul id="'+i.wid+'" class="view-model-window kwidget kwidget--list scrollable"><\/ul>'),r=$("#"+i.wid);r.data("kendoWindow")||r.kendoWindow({width:i.width,height:i.height,title:i.title,modal:!0,visible:!1,close:function(){i.cancel()}});var e=r.data("kendoWindow"),l=kendo.template(i.template),h=$("#"+i.wid);h.empty();Array.prototype.forEach.call(n,function(n){var r;r=t.template?n:$.extend({Title:"",Icon:{Value:"",Color:""}},n);h.append($(l(r)).click(function(){i.multiSelect?$(this).hasClass("active")?(u.splice(u.indexOf(n),1),$(this).removeClass("active")):(u.push(n),$(this).addClass("active")):(e.destroy(),i.callback(n))}))});e.center();e.open()},selectSimpleTreeView:function(n,t){var i=$.extend({wid:null,title:"Выбор",width:400,height:500,template:"<span data-id='#: item.ID #' class='#: item.Icon.Value #' style='color: #: item.Icon.Color #'><\/span>&nbsp#: item.Name #",children:"Items",callback:function(){},cancel:function(){}},t),u,r,o,f,s,e;for(i.wid=i.wid?"selectSimpleTreeView_"+i.wid:pbaAPI.guid("selectSimpleTreeView").replace(/\-/g,""),u=$("#"+i.wid),u.length||($("body").append('<div id="'+i.wid+'" class="view-model-window list-group"><\/div>'),u=$("#"+i.wid)),r=u.data("kendoWindow"),r||(u.kendoWindow({width:i.width,height:i.height,title:i.title,modal:!0,visible:!1,close:function(){i.cancel()}}),r=u.data("kendoWindow"),$('<div class="footer-buttons right" style="margin-top: 7px;">').append($('<button class="k-button"><span class="k-icon k-update"><\/span><\/span class="button-text">Выбрать<\/span><\/button>').click(function(){var n=r.element.find("#treeview").data("kendoTreeView"),t=n.select();t.length>0?(r.destroy(),i.callback(n.dataItem(t))):pbaAPI.errorMsg("Необходимо выбрать запись")})).append($('<button class="k-button"><span class="k-icon k-cancel"><\/span><\/span class="button-text">Отмена<\/span><\/button>').click(function(){r.close()})).appendTo(r.element),r.element.append("<div id='treeview' style='height:400px;'><\/div>"),r.element.find("#treeview").kendoTreeView({template:kendo.template(i.template)})),o=r.element.find("#treeview"),f=o.data("kendoTreeView"),f.setDataSource(new kendo.data.HierarchicalDataSource({data:n,schema:{model:{id:"ID",children:"Items",hasChildren:"HasChildren"}}})),s=function s(n){n.IsAbstract&&f.enable(o.find("[data-id='"+n.ID+"']"),!1);for(var t=0;t<n.Items.length;t++)s(n.Items[t])},e=0;e<n.length;e++)s(n[e]);f.expand(".k-item");r.center();r.open()},openDetailView:function(n,t){(n=="DuplicateRightView"||n=="RightCostView")&&(n="Right");n=="Subject"&&t.id?pbaAPI.proxyclient.corpProp.getActiveSociety({id:t.id}).done(function(n){if(n){var i=n.Mnemonic;n.Ext&&n.Ext.ObjectID&&t.id!=n.ObjectID&&(t.id=n.Ext.ObjectID)}pbaAPI.openDv(i,t,n)}):application.viewModelConfigs.get(n).done(function(i){pbaAPI.openDv(n,t,i)})},openDv:function(n,t,i){var r=$.extend({wid:null,title:null,width:null,height:null,IsMaximaze:i.DetailView.IsMaximaze||Math.min($(window).width(),$(window).height())<768,id:0,ids:null,entity:null,entities:null,toSave:null,createDefault:null,initProps:{},initNewEntity:null,beforeSave:null,callback:function(){},isReadOnly:i.IsReadOnly,parentForm:null,hideToolbar:!1,customQueryGetParams:null,customQuerySaveParams:null,link:null,onOpen:function(){},onError:function(){},isCorrectMnemonic:!1,changedProperties:{},byDate:null,parentLV:null},t),h=r.id||(r.entity?r.entity.ID||0:0),l=h===0,a,e,v,y,p,w,u,c,o,f,s,b;if(r.initProps=r.initProps||{},l&&"MnemonicCategory"in i.Ext&&(a=i.Ext.MnemonicCategory,a&&!r.initProps.CategoryID))if(r.parentForm&&r.parentForm.getPr("CategoryID")!==0)r.initProps.CategoryID=r.parentForm.getPr("CategoryID");else return pbaAPI.openModalDialog(a,function(t){if(t&&t.length>0){r.initProps.CategoryID=t[0].ID;pbaAPI.openDetailView(n,r);return}r.callback({type:"cancel"})},{showMaximize:!1,title:"Выбор категории",width:400,height:500}),!1;if(i.Ext&&i.Ext.Relations&&Object.keys(i.Ext.Relations).length>0){if(delete i.Ext.Relations.SpaceShip,l){e=[];for(v in i.Ext.Relations)i.Ext.Relations.hasOwnProperty(v)&&(y=i.Ext.Relations[v],y.IsReadOnly||e.push(y));return e.length===1?(pbaAPI.openDetailView(e[0].Mnemonic,r),!1):e.length>1?(pbaAPI.selectSimple(e,{wid:"_superclass_"+r.wid,callback:function(n){pbaAPI.openDetailView(n.Mnemonic,r)},cancel:function(){r.callback({type:"cancel"})}}),!1):(pbaAPI.errorMsg("Relations is empty"),!1)}if(!r.isCorrectMnemonic)return pbaAPI.proxyclient.viewConfig.getExtraId({mnemonic:n,id:r.id||r.entity.ID}).done(function(n){if(n.error){pbaAPI.errorMsg(n.error);r.onError(n.error)}else r.isCorrectMnemonic=!0,pbaAPI.openDetailView(n.Mnemonic,r)}),!1}if(l&&!pbaAPI.isEmpty(r.initProps)&&(p=r.initNewEntity,r.initNewEntity=function(n){for(var t in r.initProps)r.initProps.hasOwnProperty(t)&&(n[t]=r.initProps[t]);p&&p(n)}),w=i.DetailView.WizardName,l&&w)pbaAPI.openWizardViewModelEx(w,r);else{if(r.wid=pbaAPI.wndID(r.wid,n),r.toSave==null&&(r.toSave=r.entity==null),u=pbaAPI.initViewModel(i,r).data("kendoWindow"),u.unbind("close"),u.bind("close",function(n){var s=u.element.find(".dialog-vm"),t=s.data("dialogVM"),i,f,o,e;if(t){if(i=t.changeObjects,f=t.getCurrentModel(),u.__close){t.destroy();t.element().hide();return}n.preventDefault();o=function(){i.length>0?r.callback({type:"save",model:f,changeObjects:i}):r.callback({type:"cancel",model:f,changeObjects:i})};u.__close=!0;u.close();e=n.sender.element.find("form");e.data("pbaForm")&&e.data("pbaForm").onClose();o()}}),u.unbind("resize"),u.bind("resize",function(n){n.sender.element.find("form").each(function(t,i){var r=$(i);if(r.is(":visible"))r.data("pbaForm").onResize(n.sender)})}),c=u.element.find("#DialogID").val(),o={},r.id?o[r.id]={model:null,order:0}:r.entity&&("ID"in r.entity||(r.entity.ID=r.entity.uid||pbaAPI.guid()),o[r.entity.ID]={model:r.entity,order:0}),$.isArray(r.ids))for(f=0;f<r.ids.length;f++)h=r.ids[f],h&&h!==0&&(o[h]={model:null,order:f});else if(r.entities)for(f=0;f<r.entities.length;f++)s=r.entities[f],"ID"in s||(s.ID=s.uid||pbaAPI.guid()),o[s.ID]={model:s,order:f};return b={wnd:u,currentID:r.entity?r.entity.ID:r.id,entities:o,parentForm:r.parentForm,parentLV:r.parentLV,isReadOnly:r.isReadOnly,toSave:r.toSave,hideToolbar:r.hideToolbar,buttons:r.buttons,link:r.link,customQueryParams:{get:r.customQueryGetParams,save:r.customQuerySaveParams},changeProperties:r.changedProperties,createDefault:r.createDefault,events:{initNewEntity:r.initNewEntity,beforeSave:r.beforeSave,save:function(n){var t=n.sender.changeObjects[n.sender.changeObjects.length-1];r.callback&&r.callback({type:"save",model:t,changeObjects:n.sender.changeObjects});n.sender.destroy();u.unbind("close");u.close()}},byDate:r.byDate},c?window[c].initDialog(b):u.bind("refresh",function(n){var t=n.sender,i=t.element.find("#DialogID");c=i.val();window[c].initDialog(b)}),u.unbind("activate"),u.bind("activate",function(n){var t=setInterval(function(){var i=n.sender.element.find("form");i.data("pbaForm")&&(i.data("pbaForm").onActivate(),clearInterval(t))},100);r.onOpen()}),u.center(),u.pin(),u.open(),u.__close=!1,r.IsMaximaze&&u.maximize(),u.element}return!1},initWizardViewModel:function(n,t){var i=$.extend({wid:null,title:null,width:null,height:null,initProps:{}},t),u=n.Mnemonic,r;return i.wid=pbaAPI.wndID(i.wid,u),r=$("#"+i.wid),r.length||($("body").append('<div id="'+i.wid+'" class="view-model-window wnd-loading-content"><\/div>'),r=$("#"+i.wid),r.kendoWindow({width:i.width||n.DetailView.Width||application.getDefaultModalWidth(),height:i.height||n.DetailView.Height||application.getDefaultModalHeight(),title:i.title||n.DetailView.Title||n.Title,actions:["Maximize","Close"],content:application.url.GetWizard("GetViewModel",{mnemonic:u,typeDialog:"Modal"}),modal:!0,visible:!1})),r},openWizardViewModelEx:function(n,t){n=n.split(",")[0].trim();application.viewModelConfigs.get(n).done(function(i){var r=$.extend({wid:null,title:null,width:null,height:null,isMaximaze:i.DetailView.IsMaximaze,id:0,ids:null,entity:null,entities:null,toSave:null,initNewEntity:null,nextStep:null,createDefault:null,onNextStep:null,beforeSave:null,callback:function(){},isReadOnly:!1,parentForm:null,hideToolbar:!1,customQueryGetParams:null,customQuerySaveParams:null,initProps:{}},t),u,s,e,h,f,o,c;if(r.wid=pbaAPI.wndID(r.wid,n),r.toSave==null&&(r.toSave=r.entity==null),u=pbaAPI.initWizardViewModel(i,r).data("kendoWindow"),u.bind("close",function(n){var i=n.sender,u=i.element.find("#DialogID"),f=u.val(),t=window[f];t.element().hide();t.changeObjects.length>0&&(r.callback({type:"save",model:t.changeObjects[t.changeObjects.length-1],changeObjects:t.changeObjects}),t.destroy())}),u.bind("resize",function(n){n.sender.element.find("form").each(function(t,i){var r=$(i);if(r.is(":visible"))r.data("pbaForm").onResize(n.sender)})}),s=u.element.find("#DialogID").val(),e={},r.id?e[r.id]={model:null,order:0}:r.entity&&("ID"in r.entity||(r.entity.ID=r.entity.uid||pbaAPI.guid()),e[r.entity.ID]={model:r.entity,order:0}),$.isArray(r.ids))for(f=0;f<r.ids.length;f++)h=r.ids[f],h&&h!==0&&(e[h]={model:null,order:f});else if(r.entities)for(f=0;f<r.entities.length;f++)o=r.entities[f],"ID"in o||(o.ID=o.uid||pbaAPI.guid()),e[o.ID]={model:o,order:f};return c={wnd:u,currentID:r.entity?r.entity.ID:r.id,entities:e,parentForm:r.parentForm,isReadOnly:r.isReadOnly,createDefault:r.createDefault,toSave:r.toSave,hideToolbar:r.hideToolbar,customQueryParams:{get:r.customQueryGetParams,save:r.customQuerySaveParams},events:{initNewEntity:r.initNewEntity,nextStep:function(n){r.nextStep&&r.nextStep(n)},onNextStep:function(n){if(r.onNextStep)r.onNextStep(n)},beforeSave:r.beforeSave,save:function(n){r.callback&&r.callback({type:"save",model:n.sender.changeObjects[n.sender.changeObjects.length-1],changeObjects:n.sender.changeObjects});n.sender.destroy();u.close()}}},s?window[s].initDialog(c):u.bind("refresh",function(n){var t=n.sender,i=t.element.find("#DialogID");s=i.val();window[s].initDialog(c)}),u.center(),u.open(),r.isMaximaze&&u.maximize(),u.element})},getFilePreviewHtml:function(n,t,i,r,u){if(!n)return'<a href="javascript:void(0);" title="Скачать" onclick="pbaAPI.errorMsg("Файл недоступен")" ontouchstart="pbaAPI.errorMsg("Файл недоступен")"><span class="file-icon default-file"><\/span><\/a>';var f=pbaAPI.getHrefFile(n.FileID),e=pbaAPI.extensionClass(n.FileName),o=pbaAPI.fileType(n.FileName),s=u?n.FileName:"";return t=t||32,i=i||32,o?o==="image"?'<a class="imageModal" title="Открыть изображение" data-title="'+(n.Title||n.FileName)+'" href="javascript: void(0);" data-id="'+n.FileID+'" data-key="'+n.Key+'"><img class="file-icon" src="'+pbaAPI.imageHelpers.getsrc(n.FileID,t,i,r)+'" width="'+t+'" height="'+i+'" alt=""/><\/a>':'<a title="'+(e.indexOf("docx")===-1?"Скачать":"Просмотр")+'" href="'+f+'" target="_blank"><span class="file-icon '+e+'"><\/span>'+s+"<\/a>":'<a title="Скачать" href="'+f+'" target="_blank"><span class="file-icon default-file"><\/span>'+s+"<\/a>"},showImage:function(n,t){var i;if(n){var r=$('<div class="text-center"><img src="" alt="" /><div><a class="btn k-button btn-default close_button" href="javascript: void(0);"><i class="fa fa-close"><\/i>&nbsp;Закрыть<\/a><a class="btn k-button btn-default download_button" target="_blank" href="javascript: void(0);"><i class="fa fa-download"><\/i>&nbsp;Скачать<\/a><div style="clear:both"><\/div><\/div><\/div>').appendTo("body"),f=window.innerWidth*.8,u=window.innerHeight*.8,s=application.url.GetFiles("GetImage",{id:n}),h=application.url.GetFiles("GetImageThumbnail",{id:n,size:"XXL"}),e=r.find(".download_button"),o=r.find(".close_button");r.kendoWindow({title:t||"",modal:!0,resizable:!1,visible:!1,deactivate:function(){this.destroy()}});i=new Image;i.onload=function(){var s=r.getKendoWindow(),c=r.find("img")[0],t,n;i.width<=f&&i.height<=u?(t=i.width,n=i.height):(t=f,n=t/i.width*i.height,n>u&&(n=u,t=n/i.height*i.width));c.width=t;c.height=n;c.src=i.src;e.add(o).css({display:"block",width:100,margin:"0 5px",float:"right"}).parent().css("margin-top",8);e.attr("href",h);o.click(function(){s.close()});s.center();s.open()};i.src=s}},showDoc:function(n,t){if(n){var i=$("<div >").appendTo("body");i.kendoWindow({title:t||"",modal:!0,resizable:!1,visible:!1,activate:function(){},deactivate:function(){this.destroy()}});$.get("/FileData/ShowDoc/"+n,function(n){i.html(n);i.getKendoWindow().maximize().center().open()})}},openWorkflowTimelineModal:function(n,t,i,r){var u=$("<div />").kendoWindow({width:$(window).width(),height:$(window).height(),title:"История движения объекта",content:"/BusinessProcesses/TimeLine?objectType="+n+"&objectid="+t+"&implID="+i+"&showcurrentstages="+r,resizable:!1,maximize:!0,actions:["Close"],modal:!0,deactivate:function(){this.destroy()}}),f=u.data("kendoWindow");u.addClass("overflowscroll");f.center().open().maximize()},showPresentation:function(){pbaAPI.infoMsg("Не реализовано")},getGridBooleanColumn:function(n){return n==null?"<span><\/span>":n===!0?"<span class='k-icon icon-yes'><\/span>":n===!1?"<span class='k-icon fa fa-minus'><\/span>":void 0},base64ToBlob:function(n,t,i){var o,f,r,e,s,u,h;if(!window.atob||!window.Uint8Array)return null;for(t=t||"",i=i||512,o=atob(n),f=[],r=0;r<o.length;r+=i){for(e=o.slice(r,r+i),s=new Array(e.length),u=0;u<e.length;u++)s[u]=e.charCodeAt(u);h=new Uint8Array(s);f[f.length]=h}return new Blob(f,{type:t})},download:function(n,t,i){function b(n){var i=n.split(/[:;,]/),e=i[1],o=i[2]=="base64"?atob:decodeURIComponent,r=o(i.pop()),u=r.length,t=0,f=new Uint8Array(u);for(t;t<u;++t)f[t]=r.charCodeAt(t);return new c([f],{type:e})}function h(n,t){if("download"in e)return e.href=n,e.setAttribute("download",l),e.innerHTML="downloading...",s.body.appendChild(e),setTimeout(function(){e.click();s.body.removeChild(e);t===!0&&setTimeout(function(){u.URL.revokeObjectURL(e.href)},250)},66),!0;var i=s.createElement("iframe");s.body.appendChild(i);t||(n="data:"+n.replace(/^data:([\w\/\-\+]+)/,y));i.src=n;setTimeout(function(){s.body.removeChild(i)},333)}var u=window,y="application/octet-stream",o=i||y,r=n,s=document,e=s.createElement("a"),p=function(n){return String(n)},c=u.Blob||u.MozBlob||u.WebKitBlob||p,w=u.MSBlobBuilder||u.WebKitBlobBuilder||u.BlobBuilder,l=t||"download",f,a,v;if(String(this)==="true"&&(r=[r,o],o=r[0],r=r[1]),String(r).match(/^data\:[\w+\-]+\/[\w+\-]+[,;]/))return navigator.msSaveBlob?navigator.msSaveBlob(b(r),l):h(r);try{f=r instanceof c?r:new c([r],{type:o})}catch(k){w&&(a=new w,a.append([r]),f=a.getBlob(o))}if(navigator.msSaveBlob)return navigator.msSaveBlob(f,l);if(u.URL)h(u.URL.createObjectURL(f),!0);else{if(typeof f=="string"||f.constructor===p)try{return h("data:"+o+";base64,"+u.btoa(f))}catch(k){return h("data:"+o+","+encodeURIComponent(f))}v=new FileReader;v.onload=function(){h(this.result)};v.readAsDataURL(f)}return!0},getPreset:function(n,t,i){i=i||function(){};pbaAPI.proxyclient.preset.get({ownerName:t,preset:n}).done(function(n){if(!n||n.error){pbaAPI.errorMsg("Ошибка загрузки пресета"+(n&&n.error?": "+n.error:""));return}i(n)}).fail(function(n){pbaAPI.errorMsg("Ошибка загрузки пресета"+(n&&n.message?": "+n.message:""));i(null)})},savePreset:function(n,t,i){i=i||function(){};pbaAPI.proxyclient.preset.save({preset:n},t).done(function(n){if(!n||n.error){pbaAPI.errorMsg("Ошибка сохранения пресета"+(n&&n.error?": "+n.error:""));return}i()})},editPreset:function(n,t,i){pbaAPI.getPreset(n,t,function(t){pbaAPI.openDetailView(n,{isMaximaze:!1,entity:t,toSave:!1,callback:function(t){t&&t.type==="save"&&t.model&&pbaAPI.savePreset(n,t.model,i)}})})},toObj:function(n,t){var i={};return t&&(i.ID=t.ID,i[n.LookupProperty.Text]=t[n.LookupProperty.Text],n.LookupProperty.Image&&(i[n.LookupProperty.Image.ID]=t[n.LookupProperty.Image.ID],i[n.LookupProperty.Image.FileID]=t[n.LookupProperty.Image.FileID]),n.LookupProperty.Icon&&(i[n.LookupProperty.Icon.Value]=t[n.LookupProperty.Icon.Value],i[n.LookupProperty.Icon.Color]=t[n.LookupProperty.Icon.Color])),i},getNewUrl:function(n){var i=window.location.href,t=i.split("/"),r=t[0]+"//"+t[2];return r+(n?n:"")},getNormalKendoDate:function(n){var t=n.getDate()<10?"0"+n.getDate():n.getDate(),i=n.getMonth()<9?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getFullYear(),u=n.getHours()<10?"0"+n.getHours():n.getHours(),f=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes();return t+"."+i+"."+r+" "+u+":"+f},_$createModal:function(n,t,i,r,u,f,e){for(var a,nt,tt,it,v,y,p,rt,l,ut,ft,w="mnemonic",b="selectDialog",k="clearInput",d="",g={},c=0;c<n.Columns.length;c++){var h=$(""),s=$(""),o=n.Columns[c];switch(o.Mnemonic){case"String":h=$('<div> <input class ="'+u+' width:100%"/> <\/div>');s=h.find("."+u);o.ColumnConstrains.HasColumnItems?(s.addClass("dropDownList"),s.attr({columnId:o.ID})):(s.addClass("k-textbox"),o.ColumnConstrains.MinLength&&s.attr({minlength:o.ColumnConstrains.MinLength}),o.ColumnConstrains.MaxLength&&s.attr({maxlength:o.ColumnConstrains.MaxLength}));break;case"Integer":h=$('<div> <input class ="'+u+' width:100%" /> <\/div>');s=h.find("."+u);s.addClass("integerTextBox");o.ColumnConstrains.MaxValue&&s.attr({max:o.ColumnConstrains.MaxValue});o.ColumnConstrains.MinValue&&s.attr({min:o.ColumnConstrains.MinValue});break;case"Decimal":h=$('<div> <input class ="'+u+' width:100%" style="float:right"/> <\/div>');s=h.find("."+u);s.addClass("decimalTextBox");o.ColumnConstrains.MaxValue&&s.attr({max:o.ColumnConstrains.MaxValue});o.ColumnConstrains.MinValue&&s.attr({min:o.ColumnConstrains.MinValue});break;case"Date":h=$('<div> <input class ="'+u+' width:100%"/> <\/div>');s=h.find("."+u);s.addClass("dateTextBox");e&&s.attr({value:new Date(e[o.PropertyName]).toLocaleDateString(kendo.culture().name)});o.ColumnConstrains.MinDate&&s.attr({min:o.ColumnConstrains.MinDate});o.ColumnConstrains.MaxDate&&s.attr({max:o.ColumnConstrains.MaxDate});break;case"Boolean":e&&(a=e[o.PropertyName]);nt=e&&a?'selected="selected"':"";tt=e&&!a?'selected="selected"':"";h=$('<div><select class ="'+u+' k-input"><option '+nt+' value="true">Да<\/option><option '+tt+' value="false">Нет<\/option><\/select><\/div>');s=h.find("."+u);s.addClass("booleanTextBox");break;default:it=$('<a href="#" class ="tooltipstered '+b+'" '+w+' = "'+o.Mnemonic+'" '+f+" = '"+o.PropertyName+'\' ><i class ="fa fa-navicon"><\/i><\/a>');v=$('<span class="input-group-btn"><a href="#" title="Очистить"><i class ="fa fa-close '+k+'"><\/i><\/a><\/span>');v.prepend(it);h=$('<div class="input-group">     <div class="form-control">        <div class ="k-widget k-multiselect k-header" de="input-groupselectable="on" title="" style="">           <div class="k-multiselect-wrap k-floatwrap" deselectable="on">              <ul role="listbox" deselectable="on" class="k-reset"><\/ul>              <input class ="'+u+' k-input width:100%"/>              <span deselectable="on" class="k-icon k-i-close tooltipstered" role="button" tabindex="-1"><\/span><span class="k-icon k-loading-hidden"><\/span>           <\/div>           <select multiple="multiple" data-role="multiselect" aria-disabled="false" style="display: none;" class="k-valid">              <option value="1">1<\/option>           <\/select>           <span style="font-family: Roboto, Helvetica, sans-serif; font-size: 14px; font-stretch: normal; font-style: normal; font-weight: normal; letter-spacing: normal; text-transform: none; line-height: 18.34px; position: absolute; visibility: hidden; top: -3333px; left: -3333px;">Выберите значение...<\/span>        <\/div>     <\/div><\/div>');h.closest("div").append(v);s=h.find("."+u);s.attr("readonly",!0);e&&(s.attr({id:e[o.PropertyName]}),s.attr({LinkedRowID:e.LinkedRowID}),g[c]={index:c,column:o,row:e},$.ajax({type:"GET",url:pbaAPI.getNewUrl("/Response/GetCellObjectLookupTitleById"),data:{id:e[o.PropertyName],mnemonic:o.Mnemonic,cellIndex:c},contentType:"application/json",success:function(n){if(n.error){console.log("Не удалось получить имя объекта");return}var u=n.Data[0].Title,t=undefined,i=undefined;this.url.split("?")[1].split("&").forEach(function(n){var r=n.split("=");r[0]==="cellIndex"&&(t=r[1]);r[0]==="id"&&(i=r[1])});var f=g[t],e=$("div.row input.k-input"),r=e[f.index];r.value=u;$(r).attr({id:i})}}))}y={};y[f]=o.PropertyName;s.attr(y);e&&!s.attr("value")&&s.attr({value:e[o.PropertyName]});p="";o.ColumnConstrains&&o.ColumnConstrains.Required&&(p='<span class="required-mark">•<\/span>',s.addClass("required"));rt=h.prop("outerHTML");d+="<div class='row e-row'>  <div class='col-md-3 d-label'>      <label> "+o.Title+" <\/label>"+p+"  <\/div>  <div class='col-md-9 d-editor'>"+rt+"  <\/div><\/div>"}return l=$('<div style=\'padding: 0;\' class=\'dialog dialog--modal dialog-vm\'>    <div class=\'dialog__toolbar toolbar-vm\'>        <div class="k-toolbar k-widget k-toolbar-resizable">            <div style="float: right; visibility: visible;" class="k-button-group">            <a href="" class ="k-button success k-group-start" id="'+i+'">Сохранить<\/a>            <a href="" class ="k-button primary k-group-end" id="'+r+"\">Сохранить и закрыть<\/a>            <\/div>        <\/div>    <\/div>    <div class='view-model' style='padding:10px'>"+d+"<\/div><\/div>"),ut=l.find("."+b),ut.click(function(){var n=$(this),t=n.attr(w);pbaAPI.openModalDialog(t,function(i){application.viewModelConfigs.get(t).done(function(t){var r=pbaAPI.toObj(t,i[0]);n=n.closest(".input-group").find("."+u);n.attr({value:r[Object.keys(r)[1]],id:r[Object.keys(r)[0]]})})},{title:application.viewModelConfigs.get(t).Title,multiSelect:!1})}),ft=l.find("."+k),ft.click(function(){var n=$(this).closest(".input-group").find("."+u);n.val(undefined);n.attr({value:""})}),l},_setStyle:function(){var n={style:"display: block; width:100%"},h=$(".k-textbox"),e,t,i,o,s,r,u,f;h.attr(n);e={rules:{myRule:function(n){if(n.is("[data-role='numerictextbox']")){var i=parseInt($(n).attr("min")),r=parseInt($(n).attr("max")),t=parseInt(n.val());return t<i||t>r?!1:!0}return!0}},messages:{myRule:function(n){var i=$(n).attr("min"),r=$(n).attr("max"),u="Запросом ограничен ввод значений в диапазоне от "+i+" до "+r,t=$(n).attr("data-val-msg");return t?t:u}}};t=$(".integerTextBox");t.removeClass("integerTextBox");t.kendoNumericTextBox({format:"0: n0"});t.kendoValidator(e);t.closest(".k-widget").attr(n);i=$(".decimalTextBox");i.removeClass("decimalTextBox");i.kendoNumericTextBox({culture:kendo.culture().name,decimals:2,step:.01});i.kendoValidator(e);i.closest(".k-widget").attr(n);o=$(".booleanTextBox");o.removeClass("booleanTextBox");o.attr(n);s={rules:{datepicker:function(n){return n.is("[data-role=datetimepicker]")?n.data("kendoDateTimePicker").value():!0}},messages:{datepicker:"Введите правильную дату!"}};r=$(".dateTextBox");r.removeClass("dateTextBox");r.kendoDatePicker({culture:kendo.culture().name});u=r;u.kendoMaskedTextBox({mask:"00/00/0000"});u.closest(".k-datepicker").add(u).removeClass("k-textbox");u.kendoValidator(s);r.closest(".k-widget").parent().closest(".k-widget").attr(n);f=$(".dropDownList");f.attr(n);f.each(function(n){var t=$(f[n]),i=t.attr("columnId");t.kendoDropDownList({serverFiltering:!0,dataTextField:"Item",dataValueField:"Item",dataSource:{transport:{read:{type:"post",url:pbaAPI.getNewUrl("/Response/GetRequestColumnItems?columnId="+i)}},schema:{data:"Data"}}})});f.removeClass("dropDownList")},_getSendData:function(n,t){var i={};return $("."+n).each(function(){var n=$(this),r,u,f;if(n.attr(t)){if(r=n.attr("id")||n.attr("value"),u=n.hasClass("required"),u&&!r)return f="Не заполнены обязательные поля.",pbaAPI.errorMsg(f),i=undefined,!1;i[n.attr(t)]=n.attr("id")||n.attr("value");!i.LinkedRowID&&n.attr("LinkedRowID")&&(i.LinkedRowID=n.attr("LinkedRowID"))}return!0}),i},showCustomCreateWindow:function(n,t,i,r){function l(){$(":focus").blur();$("input").blur();var n=pbaAPI._getSendData(u,h);n&&$.ajax({type:"POST",url:pbaAPI.getNewUrl("/Response/SaveDynamicObject/"+i),data:JSON.stringify(n),contentType:"application/json",success:function(n){if(n.error)pbaAPI.errorMsg("Ошибка при сохранении объекта.");else{var t=n.rowId;$("."+u).attr("LinkedRowID",t);pbaAPI.uploadMsg("Новый объект успешно сохранен.");r()}}})}var o="CustomWindowSave",s="CustomWindowSaveClose",u="request-row-input",h="fieldname",f=pbaAPI._$createModal(n,t,o,s,u,h),a=f.find("#"+o),v=f.find("#"+s),e="kendoWindow",c=f[e]({title:"Создание строки ответа",modal:!0,resizable:!0,visible:!1,width:window.innerWidth-100,height:window.innerHeight-100,deactivate:function(){this.destroy()},open:function(){$(document).ready(function(){pbaAPI._setStyle()})}});c.data(e).center().open();a.click(function(){l()});v.click(function(){l();c.data(e).close()})},showCustomEditWindow:function(n,t,i,r,u){function a(){$(":focus").blur();$("input").blur();var n=pbaAPI._getSendData(h,c);n&&$.ajax({type:"POST",url:pbaAPI.getNewUrl("/Response/SaveDynamicObject/"+r),data:JSON.stringify(n),contentType:"application/json",success:function(n){n.error?pbaAPI.errorMsg("Ошибка при сохранении объекта."):(pbaAPI.uploadMsg("Новый объект успешно сохранен."),u())}})}var o="CustomWindowSave",s="CustomWindowSaveClose",h="request-row-input",c="fieldname",f=pbaAPI._$createModal(n,t,o,s,h,c,i),v=f.find("#"+o),y=f.find("#"+s),e="kendoWindow",l=f[e]({title:"Изменение строки ответа",modal:!0,resizable:!0,visible:!1,width:window.innerWidth-100,height:window.innerHeight-100,deactivate:function(){this.destroy()},open:function(){$(document).ready(function(){pbaAPI._setStyle()})}});l.data(e).center().open();v.click(function(){a()});y.click(function(){a();l.data(e).close()})},DeleteRow:function(n,t){return $.ajax({type:"DELETE",url:pbaAPI.getNewUrl("/Response/DeleteRow")+"?"+$.param({responseId:n,rowId:t}),contentType:"application/json",success:function(n){n.error?pbaAPI.errorMsg("Ошибка при сохранении объекта."):pbaAPI.uploadMsg("Новый объект успешно сохранен.")}})}})})();