!function(e,t){"use strict";t("kendo.mailclient.ns",[],e)}(function(){"use strict";return kendo.ui.mailclient={},window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.utils",["kendo.mailclient.ns"],e)}(function(){"use strict";return function(e,t){function i(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function n(e,t){return e.getFullYear()===t.getFullYear()}function s(e){return e!==t&&null!==e&&e instanceof Date}function r(e,t,i,n){if(i||n){var s={enumerable:!0,configurable:!0};i&&(s.get=i),n&&(s.set=n),Object.defineProperty(e,t,s)}}function o(t,i){if(i&&!e.isEmptyObject(i)){var n;for(n in i){var s=i[n],o="function"==typeof s?s:s.get,a=s.set;r(t,n,o,a)}}}function a(e,t){function i(){var e=h.contentWindow,t=e?e.document.body:null;t&&(h.style.height=t.scrollHeight+"px",t.onresize=n)}function n(){m.restart()}function s(e){var t=h.contentWindow?h.contentWindow.document:h.contentDocument;t.open(),t.write(e),t.close()}function r(){try{h&&i()}catch(e){D(e.name+" "+e.message)}}function o(){return h[u]}function a(){h.onload=r,h[u]=!0,h.marginWidth="0",h.marginHeight="0",h.frameBorder="0",d()}function d(){t?(h.scrolling="yes",h.style.overflow="auto"):(h.scrolling="no",h.style.overflow="hidden")}function l(){h.onload=null,delete h[u],h=null}var h=e,u="__init_iframe__",f=60,m=c(f,i);return a(),{init:a,resize:i,element:h,setHtml:s,isInit:o,destroy:l}}function d(t,i,n){function s(){if(!v)return null;var e=new O.View(m,{model:i,evalTemplate:!0,wrap:!0});return i.bind(W,l),e.render(v),e}function r(){var t=O.format("#"+p,i.uid);return e(t).data(n?J:Q)}function o(e){n?e.bind(W,c):e.bind(z,c)}function a(e){e.center(),e.open(),g&&e.maximize()}function d(){w=s(),w&&(F=r(),F&&(o(F),a(F)))}function l(){F&&F.close()}function h(){F&&(F.unbind(),F.destroy(),F=null),w&&(w.destroy(),w=null),_=v=null}function c(){_.call(null,i.get(C)),h()}function u(e){"function"==typeof e&&(_=e)}function f(){return F}var m=t.template,p=t.windowId,g=t.isMaximize,_=e.noop,v=window.document.body,C="dialogResult",F=null,w=null;return{show:d,close:l,onClose:u,getWnd:f}}function l(i,n,s,r,o){var a={content:i};if(n!==t&&(a.title=n),s!==t&&(a.messages=s),o!==t&&(a.width=o),r){var d='<div class="k-confirm-descr">';d+='<i class="fa fa-exclamation-triangle"></i><span>'+r+"</span>",d+="</div>",a.content=a.content+d}var l=e("<div />").kendoConfirm(a).data("kendoConfirm").open();return l.result}function h(e){function t(e,t){a[e]=t}function i(e){return a[e]}function n(){var t;try{t=JSON.parse(V.getItem(e))}catch(e){t=null}return t||{}}function s(){a=n()}function r(t){V.setItem(e,JSON.stringify(a)),t&&o()}function o(){a=null}var a=n();return{get:i,set:t,save:r,reset:s,close:o,load:n,open:s}}function c(e,t){function i(){n(),r=window.setTimeout(function(){"function"==typeof t&&t.call(null)},e)}function n(){null!==r&&(window.clearTimeout(r),r=null)}function s(){n(),i()}var r=null;return{start:i,cancel:n,restart:s}}function u(e,t,i,n,s){return g("POST",e,t,i,n,s)}function f(e,t,i,n,s){return g("PUT",e,t,i,n,s)}function m(e,t,i,n,s){return g("GET",e,t,i,n,s)}function p(e,t,i,n,s){return g("DELETE",e,t,i,n,s)}function g(i,n,s,r,o,a){var d=e.Deferred();null!==s&&s!==t&&(s=JSON.stringify(s));var l={type:i,url:n,data:s,dataType:"json",cache:!1,contentType:"application/json; charset=utf-8",xhrFields:{},beforeSend:function(e){r&&e.setRequestHeader("Authorization","Bearer "+r)},error:function(e,t,i){d.reject(_(e,t,i))},success:function(e,t,i){d.resolve({response:e,textStatus:t,jqXHR:i})}};"boolean"==typeof o&&(l.xhrFields.withCredentials=o);var h=e.ajax(l);return a&&(a.xhr=h),d.promise()}function _(e,t,i){var n=new Error("Request failed.");return n.textStatus=t,n.errorThrown=i,n.jqXHR=e,n.toString=function(){var e=Error.prototype.toString.call(this);return e+=" "+this.jqXHR.status,e+=" "+this.jqXHR.statusText,e+=" "+this.textStatus,e+=" "+this.errorThrown},n}function v(e,t){var i=e.match(/\.([^\.]+)$/);return i?i[t?0:1]:""}function C(e,t){var i=t?1e3:1024;if(Math.abs(e)<i)return e+" Б";var n=t?["КБ","МБ","ГБ","ТБ","PB","EB","ZB","YB"]:["КБ","МБ","ГБ","ТБ","PiB","EiB","ZiB","YiB"],s=-1;do e/=i,++s;while(Math.abs(e)>=i&&s<n.length-1);return e.toFixed(1)+" "+n[s]}function F(e,t,i){t=t||" ",i=i||2;for(var n=(e||"").split(t),s="",r=0;r<i;r++)n[r]&&(s+=n[r].charAt(0).toUpperCase());return s}function w(e,t,i,n){return e=Math.abs(e),e%=100,e>=5&&e<=20?n:(e%=10,1==e?t:e>=2&&e<=4?i:n)}function y(e){return e&&e.kendoBindingTarget&&e.kendoBindingTarget.source instanceof H?e.kendoBindingTarget.source:null}function D(e){console&&console.error?console.error(e):console&&console.log&&console.log(e)}function I(e,i){return null!==e&&e!==t&&"function"==typeof e[i]}function S(e){return null!==e&&e!==t&&"[object Object]"===Object.prototype.toString.call(e)}function E(e,t,i){var n,s;for(n in e)if(e.hasOwnProperty(n)&&e[n]!==t[n])return!1;if(!i)for(s in t)if(t.hasOwnProperty(s)&&e[s]!==t[s])return!1;return!0}function T(e){return null!==e&&e!==t}function A(e,t){return function(i){return i[e]===t}}function k(e,t,i){return i.indexOf(e)===t}function b(e,t){var i=e.filter(function(e){return e===t});return i.length>0?i[0]:null}function x(e){return function(t){return t[e]}}function M(e,t){return e.filter(t).length}function R(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?R(t):t)},[])}function U(e,t){var i;return t.length>e.length&&(i=t,t=e,e=i),e.filter(function(e){if(t.indexOf(e)!==-1)return!0})}function L(e){return e.length>0?e[0]:null}function P(e){return e.length>0?e[e.length-1]:null}var O=window.kendo,N=O.ui,B=N.mailclient,j=e.extend,V=window.localStorage,H=O.data.ObservableObject,q=new Date,z="deactivate",W="close",Q="kendoMailClientWindow",J="kendoMailClientModal";a.isInit=function(e){return e&&e.__init_iframe__},j(B,{CURRENT_DATE:q,createIframe:a,timer:c,traceError:D,areSameDate:i,areSameYear:n,isDate:s,defGetSetProp:r,defGetSetProps:o,storage:h,createWndDialog:d,post:u,put:f,get:m,del:p,request:g,fileExtension:v,humanFileSize:C,isFn:I,isObject:S,bindingTargetSource:y,notNullFilter:T,filterByField:A,findByRef:b,onlyUnique:k,selectField:x,arrayCount:M,arrayFlatten:R,arrayIntersect:U,first:L,last:P,initials:F,confirm:l,compareObjects:E,getNoun:w})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.constants",["kendo.mailclient.ns"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.mailclient,r=e.extend,o={None:"None",All:"All",Inbox:"Inbox",Sent:"Sent",Drafts:"Drafts",Junk:"Junk",Trash:"Trash",Archive:"Archive",Flagged:"Flagged"},a={Init:1,Pending:2,Success:3,Failed:4},d={MoveTo:"MoveTo",MoveAll:"MoveAll",AddFlag:"AddFlag",RemoveFlag:"RemoveFlag",MarkAsRead:"MarkAsRead",MarkAsUnread:"MarkAsUnread",Delete:"Delete",DeleteAll:"DeleteAll",Compose:"Compose",Reply:"Reply",Forward:"Forward",Refresh:"Refresh",NewFolder:"NewFolder",UpdateFolder:"ChangeFolder",RemoveFolder:"RemoveFolder",RemoveFolderToTrash:"RemoveFolderToTrash",MarkAsReadFolder:"MarkAsReadFolder",ClearAllFolder:"ClearAllFolder",RefreshMessages:"RefreshMessages",EditDraft:"EditDraft",EditSettings:"EditSettings",EditAsNew:"EditAsNew"},l={};l[o.Inbox]="inbox",l[o.Drafts]="sticky-note-o",l[o.Sent]="paper-plane-o",l[o.Trash]="trash-o",l[o.All]="folder-o",l[o.Flagged]="folder-o",l[o.Junk]="exclamation-circle",l[o.Archive]="folder-o",l[o.None]="folder-o";var h={};h[o.Inbox]="inbox",h[o.Drafts]="drafts",h[o.Sent]="sent",h[o.Trash]="trash",h[o.Junk]="junk";var c={CHANGE_FOLDER:"changeFolder",COMPOSE_WND_FOCUS:"composeWndFocus",MARK_AS_UNREAD:"markAsUnread",MARK_AS_READ:"markAsRead",SELECT_FOLDER:"selectFolder"},u={UNAUTHORIZED:401};r(s,{FolderType:o,CommandState:a,Commands:d,FolderIconMap:l,FolderTranslateMap:h,BroadcastEvents:c,HttpCodes:u})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.models",["kendo.mailclient.ns","kendo.mailclient.utils","kendo.mailclient.constants"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.extend,r=i.Class,o=i.data.Model,a=n.mailclient,d=a.FolderIconMap,l=a.FolderType,h=a.isDate,c=a.isObject,u=Array.isArray,f=a.areSameDate,m=a.areSameYear,p=a.defGetSetProps,g=a.humanFileSize,_=a.fileExtension,v=a.CURRENT_DATE,C=o.define({id:"ClientId",fields:{name:{type:"string",field:"Name"},address:{type:"string",field:"Address"}}}),F=o.define({id:"FolderId",fields:{displayName:{type:"string",field:"Title"},type:{type:"string",field:"Type"},unreadItemCount:{type:"number",field:"UnreadCount"},totalItemCount:{type:"number",field:"TotalCount"},recentItemCount:{type:"number",field:"RecentCount"},parentId:{type:"string",field:"ParentId",nullable:!0},sortOrder:{type:"number",field:"SortOrder"},hasChildren:{type:"boolean",field:"hasChildren",defaultValue:!1},expanded:{type:"boolean",field:"expanded",defaultValue:!1},children:{type:"object",field:"children"}}}),w=o.define({id:"FileId",fields:{FileName:{type:"string",field:"FileName"},FileSize:{type:"number",field:"FileSize"}}}),y=o.define({id:"ID",fields:{Name:{type:"string",field:"Title"},Address:{type:"string",field:"Email"}}}),D={uniqueId:{type:"number",field:"UniqueId"},folderId:{type:"string",field:"FolderId"},subject:{type:"string",field:"Subject",defaultValue:""},from:{type:"object",field:"From"},cc:{type:"object",field:"Cc"},bcc:{type:"object",field:"Bcc"},to:{type:"object",field:"To"},sentDate:{type:"date",field:"Date"},isRead:{type:"boolean",field:"IsRead",defaultValue:!1},isFlag:{type:"boolean",field:"IsFlag",defaultValue:!1},isDraft:{type:"boolean",field:"IsDraft",defaultValue:!1},isSend:{type:"boolean",field:"IsSend",defaultValue:!1},isSent:{type:"boolean",field:"IsSent",defaultValue:!1},highPriority:{type:"boolean",field:"HighPriority",defaultValue:!1},confirmRead:{type:"boolean",field:"ConfirmRead",defaultValue:!1},confirmDelivery:{type:"boolean",field:"ConfirmDelivery",defaultValue:!1}},I=o.define({id:"uniqueId",fields:s({},D,{hasAttachments:{type:"boolean",field:"HasAttachments",defaultValue:!1},bodyPreview:{type:"string",field:"BodyPreview"}})}),S=o.define({id:"uniqueId",fields:s({},D,{body:{type:"string",field:"Body"},isHtml:{type:"boolean",field:"IsHtmlBody"},attachments:{type:"object",field:"Attachments",parse:function(e){return"function"==typeof e.map?e.map(function(e){return new w(e)}):[]}}})}),E={fromName:function(){return this.from?this.from.Name:null},fromAddress:function(){return this.from?this.from.Address:null},toName:function(){return this.to&&this.to[0]?this.to[0].Name:null},toAddress:function(){return this.to&&this.to[0]?this.to[0].Address:null},sentDateFormatted:function(){return h(this.sentDate)?f(this.sentDate,v)?i.toString(this.sentDate,"t"):m(this.sentDate,v)?i.toString(this.sentDate,"MMM d"):i.toString(this.sentDate,"MMM d, yy"):""},isNotFlag:function(){return!this.get("isFlag")},isUnread:function(){return!this.get("isRead")},isFlagShow:function(){return this.get("isFlag")&&this.get("isRead")}},T={setRead:function(e){this.set("isRead",e)},setFlag:function(e){this.set("isFlag",e)},recipientsToString:function(e,i,n){return e=e||[],n=n!==t?n:", ",e.map(function(e){return e.Name||e.Address||i}).join(n)}};I.createFromDetails=function(e){if(e instanceof o){var t=e.toJSON();return t.hasAttachments=t.attachments.length>0,delete t.body,delete t.isHtml,delete t.attachments,new I(t)}},s(I.prototype,T),s(S.prototype,T),p(I.prototype,E),p(S.prototype,E),s(I.prototype,{setId:function(e){this.set(I.idField,e),this.id=this.get(I.idField)}}),s(S.prototype,{setId:function(e){this.set(S.idField,e),this.id=this.get(S.idField)}}),p(C.prototype,{displayName:function(){return this.address}}),p(F.prototype,{icon:function(){return d[this.type]},itemCount:function(){return this.get("unreadItemCount")||0},notExpanded:function(){return!this.get("expanded")},isSystem:function(){return this.get("type")!==l.None},isCustom:function(){return this.get("type")===l.None}});var A={subUnreadItemCount:function(e){var t=this.unreadItemCount-e;this.set("unreadItemCount",t<0?0:t)},addUnreadItemCount:function(e){this.set("unreadItemCount",this.unreadItemCount+e)},addTotalItemCount:function(e){this.set("totalItemCount",this.totalItemCount+e)},subTotalItemCount:function(e){var t=this.totalItemCount-e;this.set("totalItemCount",t<0?0:t)},setUnreadItemCount:function(e){this.set("unreadItemCount",e)},resetCounters:function(){this.set("totalItemCount",0),this.set("unreadItemCount",0)},toggleExpanded:function(){return this.set("expanded",!this.get("expanded"))},setExpand:function(e){this.set("expanded",e)},setEdit:function(e){this.set("edit",e)},setHasChildren:function(e){this.set("hasChildren",e)},setChildren:function(e){this.set("children",e)},setSortOrder:function(e){this.set("sortOrder",e)},setParentId:function(e){this.set("parentId",e)},incrSortOrder:function(e){var t=e||this.sortOrder||0;this.set("sortOrder",t+1)},setDisplayName:function(e){this.set("displayName",e)},setId:function(e){this.set(F.idField,e),this.id=this.get(F.idField)}};s(F.prototype,A),F.create=function(e,t,i){return new F({FolderId:e,parentId:t,sortOrder:0,displayName:i,type:l.None,totalItemCount:0,recentItemCount:0,unreadItemCount:0,expanded:!1,hasChildren:!1,children:[]})},F.from=function(e){e=e||{};var t=F.fields,i=F.idField,n={};return n[i]=e[i],Object.keys(t).forEach(function(i){var s=t[i];s.field&&(n[i]=e[s.field])}),new F(n)},p(w.prototype,{HumanFileSize:function(){return g(this.FileSize)},FileExt:function(){return _(this.FileName||"")}});var k=r.extend({init:function(e,t){this.name=e||"",this.address=t||""},toString:function(){return!this.name||this.name===this.address&&this.address?"<"+this.address+">":this.name&&!this.address?this.name:this.name+" <"+this.address+">"}});k.fromRaw=function(e){if(u(e))return e.map(k.fromRaw);if(c(e))return new k(e.Name,e.Address);throw new Error("Invalid raw data.")},s(a,{AccountModel:C,FolderModel:F,AttachmentModel:w,MessageListItemModel:I,MessageDetailsModel:S,ContactModel:y,Recipient:k})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.data",["kendo.mailclient.ns","kendo.mailclient.utils","kendo.mailclient.models"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.mailclient,r=e.extend,o=i.data.DataSource,a=e.proxy,d=Array.isArray,l=Array.prototype.slice,h=s.get,c=s.last,u=s.storage,f=s.selectField,m=s.arrayIntersect,p=s.traceError,g=s.HttpCodes,_=s.AccountModel,v=s.FolderModel,C=s.MessageListItemModel,F=s.MessageDetailsModel,w=s.ContactModel,y="kendoMailClient",D=o.extend({init:function(e,t){o.fn.init.call(this,t),this.transport.options.read.beforeSend=a(this._handleBeforeSend,this),this.auth=e},_handleBeforeSend:function(e){this.auth&&this.auth.enabled()&&this.auth.addBearerHeader(e)},read:function(t){var i=this,n=e.Deferred();return o.fn.read.call(this,t).done(n.resolve).fail(function(e){if(i.auth&&i.auth.enabled()&&e&&e.status===g.UNAUTHORIZED)i._refreshAuthToken(n,t);else{var s=l.call(arguments);n.reject.apply(n,s)}}),n.promise()},_refreshAuthToken:function(e,t){var i=this;this.auth.refreshToken().done(function(n){try{o.fn.read.call(i,t).done(e.resolve).fail(e.reject)}catch(t){p("Read data failed: "+t.toString()),e.reject({},"","Read exception")}return n}).fail(function(t){return p("Refresh token failed: "+t.toString()),e.reject(t.jqXHR,t.textStatus,t.errorThrown),t})},inProgress:function(){return this._requestInProgress}}),I=D.extend({init:function(e,t){D.fn.init.call(this,e,{transport:{read:{url:t,dataType:"json"}},schema:{data:"Items",total:"TotalCount",model:_}})}}),S=D.extend({init:function(e,t){D.fn.init.call(this,e,{transport:{read:{url:a(this._makeUrl,this),dataType:"json"},parameterMap:a(this._getParameterMap,this)},filter:{field:"parentId",operator:"eq",value:null},sort:[{field:"sortOrder",dir:"asc"},{field:"displayName",dir:"asc"}],schema:{data:a(this._processData,this),model:v}}),this._urlTemplate=t},_getParameterMap:function(){return null},_makeUrl:function(e){return i.format(this._urlTemplate,e.accountId)},_processData:function(e){if(e&&d(e)){var t=e.map(function(e){return e.ParentId||(e.ParentId=null),e.hasChildren=!1,e.expanded=!1,e.children=[],e});return t=this._createTree(t)}return[]},_createTree:function(e){var t=this;return this._rootNodes(e).map(function(i){return t._subtree(i,e),i})},_rootNodes:function(e){return e.filter(function(e){return!e.ParentId})},_subtree:function(e,t){for(var i=[],n=0,s=t.length;n<s;n++)e.FolderId===t[n].ParentId&&(this._subtree(t[n],t),i.push(t[n]));e.children=this.createChildDataSource(i),e.children.fetch(),e.hasChildren=i.length>0},flattenArray:function(){var e=[];return this._subTreeArray(e,this.data()),e},flattenArrayBy:function(e){var t=[];return e.hasChildren&&this._subTreeArray(t,e.children.data()),t},_subTreeArray:function(e,t){for(var i=0,n=t.length;i<n;i++){var s=t[i];e.push(s),s.hasChildren&&this._subTreeArray(e,s.children.data())}},findParents:function(e,t){function i(e){for(var r=0;r<n.length;r++)if(n[r].id===e){if(s.push(n[r]),t)break;n[r].parentId&&i(n[r].parentId)}}var n=this.flattenArray(),s=[],r=n.filter(function(t){return t.id===e});return r.length?(i(r[0].parentId),s):[]},createFolder:function(e,t,i){var n=v.create(e,t,i);return n.set("children",this.createChildDataSource()),n.children.fetch(),n},createChildDataSource:function(e){return new o({data:e||[],schema:{model:v},sort:{field:"displayName",dir:"asc"}})},maxSortOrder:function(e){e=e||this;var t=c(e.data());return t?t.sortOrder||0:0},updateIdentifiers:function(e,t){var i=v.idField;e[i]=t[i],e.id=e.get(i),e.parentId=t.ParentId||null},updateSubtree:function(e,t){t=t||[];var i={FolderId:e.id};this._subtree(i,t),e.setChildren(i.children),e.setHasChildren(i.hasChildren)}}),E=D.extend({init:function(e,t,i){D.fn.init.call(this,e,{transport:{read:{url:a(this._makeUrl,this),dataType:"json"},parameterMap:a(this._getParameterMap,this)},schema:{data:"Items",total:"TotalCount",errors:"Error",model:C},serverPaging:!0,serverFiltering:!0,pageSize:i}),this._urlTemplate=t,this.accountId=null,this.folderId=null},_getParameterMap:function(e,t){return"read"===t&&(this._makeSearchOpt(e),this._makeIsFlagOpt(e),this._makeIsReadOpt(e),this._makeHasAttachmentsOpt(e),this._makeSortOpt(e),this._makeSortDirectionOpt(e),delete e.pageSize,delete e.page,delete e.filter),e},_makeUrl:function(){return i.format(this._urlTemplate,this.accountId,this.folderId)},_makeSearchOpt:function(e){var t=this._findFilter(e.filter,"search");t&&(e.search=t.value)},_makeIsFlagOpt:function(e){var t=this._findFilter(e.filter,"is_flag");t&&(e.is_flag=t.value)},_makeIsReadOpt:function(e){var t=this._findFilter(e.filter,"is_read");t&&(e.is_read=t.value)},_makeHasAttachmentsOpt:function(e){var t=this._findFilter(e.filter,"has_attachments");t&&(e.has_attachments=t.value)},_makeSortOpt:function(e){var t=this._findFilter(e.filter,"order");t&&(e.order=t.value)},_makeSortDirectionOpt:function(e){var t=this._findFilter(e.filter,"desc");t&&(e.desc=t.value)},_findFilter:function(e,t){if(e&&d(e.filters)&&t){var i=e.filters.filter(function(e){return e.field===t});return i.length>0?i[0]:null}return null}}),T=D.extend({init:function(e,t){D.fn.init.call(this,e,{transport:{read:{url:a(this._makeUrl,this),dataType:"json"},parameterMap:a(this._getParameterMap,this)},schema:{data:function(e){return d(e)?[e[0]]:[e]},errors:"Error",model:F}}),this._urlTemplate=t},_getParameterMap:function(){return null},_makeUrl:function(e){return i.format(this._urlTemplate,e.accountId,e.folderId,e.messageId)}}),A=o.extend({init:function(e){o.fn.init.call(this,{data:e,schema:{model:w}})}}),k=o.extend({init:function(e,t){var n=this;o.fn.init.call(this,{transport:{read:function(e){var t=n._getFilterValue(e.data);e.success(n._concatWithLocalData([],t)),n._fetchServerData(t)},create:function(e){e.data[w.idField]=i.guid(),n.addToLocalStorage([e.data]),e.success(e.data)}},schema:{model:w},serverFiltering:!0}),this._urlTemplate=e,this._storage=u(y),this._withCredentials=t,this._additionalDataXhr={xhr:null},this.recipientCache="recipientCache",this.uniqModelField="Email",this.titleModelField="Title",this.maxCacheItems=50},_fetchServerData:function(e){var t=this;this._additionalDataXhr&&this._additionalDataXhr.xhr&&(this._additionalDataXhr.xhr.abort(),this._additionalDataXhr.xhr=null),t.trigger("dataFetching"),h(t._makeUrl(e),null,null,this._withCredentials,this._additionalDataXhr).done(function(e){var i=new A(e.response||[]);i.fetch();var n=i.data().map(function(e){return e}),s=t.data().map(function(e){return e});t.data(s.concat(n)),t.trigger("dataFetchSuccess")}).fail(function(e){t.trigger("dataFetchError"),"abort"!==e.textStatus&&p("Error request: "+e.textStatus+" "+e.errorThrown)})},_makeUrl:function(e){return i.format(this._urlTemplate,encodeURIComponent(e||""))},_concatWithLocalData:function(e,t){e=e||[];var i=this._fetchLocalItems();if(t){var n=this._filterRawData(i,t);e=e.concat(this._removeDuplicates(n,e))}else e=e.concat(this._removeDuplicates(i,e));return e},_removeDuplicates:function(e,t){var i,n,s=this.uniqModelField;i=e.map(f(s)),n=t.map(f(s));var r=m(i,n);return r.length>0?e.filter(function(e){return r.indexOf(e[s])===-1}):e},_fetchLocalItems:function(){this._storage.open();var e=this._storage.get(this.recipientCache)||[];return this._storage.close(),e},_filterRawData:function(e,t){e=e||[];var n=i.data.Query.process(e,{filter:{logic:"or",filters:[{field:this.uniqModelField,value:t,operator:"contains"},{field:this.titleModelField,value:t,operator:"contains"}]}});return n.data},_getFilterValue:function(e){var t=e.filter,i=t?t.filters:null;return i&&i[0]?i[0].value||"":""},addToLocalStorage:function(e){this._storage.open();var t=this,i=this._storage.get(this.recipientCache)||[],n=i.slice(),s=t.uniqModelField,r=function(e){var t=i.filter(function(t){return t[s]===e});return t.length>0?t[0]:null};(e||[]).forEach(function(e){var i=r(e[s]);i||(n.length>=t.maxCacheItems&&n.pop(),n.unshift(e))}),this._storage.set(this.recipientCache,n),this._storage.save(!0)},createRawItems:function(e){e=e||[];var t=this.reader.model,i=[];if(!t)return i;var n=t.fields;return e.forEach(function(e){var t={};Object.keys(e).forEach(function(i){var s=n[i];s&&s.field&&(t[s.field]=e[i])}),i.push(t)}),i}});r(s,{AccountDataSource:I,FolderListDataSource:S,MessageListDataSource:E,MessageDetailsDataSource:T,ContactListDataSource:k})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.auth",["kendo.mailclient.ns","kendo.mailclient.utils"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=i.Class,r=n.mailclient,o=r.request,a=r.HttpCodes,d=e.extend,l=s.extend({init:function(e){this.mailclient=e,this.options=e.options,this.token=null,this._enabled=this._checkTokenOpt(),this._refreshTokenDefer=null},_checkTokenOpt:function(){var e=this.options,t=e.auth?e.auth.token:null,i=t&&t.method&&t.field;return!(!t.createUrl||!i)},enabled:function(e){return arguments.length?void(this._enabled=!!e):this._enabled},getToken:function(){var t=this,n=e.Deferred(),s=this.options,r=s.auth.token,a=this.mailclient,d=r.createUrl,l=r.method,h=r.withCredentials;return a.showProgress(),o(l,d,null,null,h).done(function(e){var s=e.response,o=s[r.field];if(a.hideProgress(),o)t.token=o,n.resolve(o);else{var d=new Error(i.format("Invalid auth token: {0}",o));a.showError(d.toString()),n.reject(d)}}).fail(function(e){a.hideProgress(),a.showError(e.toString()),n.reject(e)}),n},refreshToken:function(){var e=this;return this._refreshTokenDefer||(this._refreshTokenDefer=this.getToken().done(function(t){return e._refreshTokenDefer=null,t}).fail(function(t){return e._refreshTokenDefer=null,t})),this._refreshTokenDefer},validateOrRefreshToken:function(t){var i=this,n=this.options.auth.tokenValidation,s=n.readUrl,r=n.method,d=n.withCredentials,l=e.Deferred();return n.readUrl?o(r,s,null,t||this.token,d).done(l.resolve).fail(function(e){e.jqXHR&&e.jqXHR.status===a.UNAUTHORIZED?i.refreshToken().done(l.resolve).fail(l.reject):l.reject()}):l.resolve(),l.promise()},addBearerHeader:function(e){this._enabled&&this.token&&e.setRequestHeader("Authorization","Bearer "+this.token)}});d(r,{Authenticator:l})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.events",["kendo.mailclient.ns","kendo.mailclient.utils"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.extend,r=e.isEmptyObject,o=e.proxy,a=Array.isArray,d=i.Class,l=n.mailclient,h=l.timer,c=l.traceError,u=l.BroadcastEvents,f=l.FolderModel,m=d.extend({init:function(e,t){this.mailclient=e,this.options=t,this._timer=h(t.pollingInterval,o(this._sendRequest,this)),this._requestDone=o(this._requestDone,this),this._requestFail=o(this._requestFail,this),this._requestDefer=null,this._running=!1},start:function(){this._running||(this._running=!0,this._timer.start())},stop:function(){this._running&&(this._running=!1,this._timer.cancel())},_sendRequest:function(){if(!this._requestDefer){var e=this.mailclient.service;this._requestDefer=e.getFolders().done(this._requestDone).fail(this._requestFail)}},_requestDone:function(e){this._requestDefer=null;var t=this._fetchEvents(e.response);if(t.length>0)try{this._broadcast(t)}catch(e){c("EventPoll: Broadcast events error: "+e.toString())}this._running&&this._timer.restart()},_requestFail:function(e){this._requestDefer=null,c("EventPoll: Request failed: "+e.toString()),this._running&&this._timer.restart()},_broadcast:function(e){var t=this.mailclient;e.forEach(function(e){t.broadcast(e.type,e)})},_fetchEvents:function(e){if(!e||!a(e)||0===e.length)return[];for(var t=[],i=this.mailclient.folderList.flattenAll(),n=this._getFoldersFromRawData(e),s=this._getModelsById(n),o=0,d=i.length;o<d;o++){var l=i[o],h=s[l.id];if(h){var c=this._getChangedFields(l,h,["unreadItemCount","totalItemCount"]);r(c)||t.push({type:u.CHANGE_FOLDER,folderId:l.id,changedFields:c})}}return t},_getChangedFields:function(e,t,i){var n,s,r,o={};for(s=0,r=i.length;s<r;s++)n=i[s],e[n]!==t[n]&&(o[n]=t[n]);return o},_getModelsById:function(e){var t={};return e.forEach(function(e){t[e.id]=e}),t},_getFoldersFromRawData:function(e){return e.map(function(e){return f.from(e)})}}),p=d.extend({init:function(e){this.mailclient=e,this._initEventProvider()},_initEventProvider:function(){var e=this.mailclient,t=e.options.events;t.polling&&(this.eventProvider=new m(e,t))},start:function(){this.eventProvider&&this.eventProvider.start()},stop:function(){this.eventProvider&&this.eventProvider.stop()}});s(l,{EventManager:p,EventPoll:m})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.commandutil",["kendo.mailclient.ns","kendo.mailclient.utils"],e)}(function(){"use strict";return function(e,t){function i(e,t){i.registered||(i.registered={}),i.registered[e]=t}function n(n,s){function r(r,o){if(i.registered[r]===t)throw new Error("Could not found command: "+r);var a=i.registered[r];if("function"!=typeof a)throw new Error("Could not found command constructor: "+r);var d=new a(e.extend({},o,{mailclient:n,widgetOpt:n.options,commandType:r,runningCommands:s}));return d}return r}var s=window.kendo,r=s.ui,o=s.Class,a=r.mailclient,d=a.compareObjects,l=a.first,h=s.isFunction,c=e.extend,u=o.extend({init:function(){this._commands=[]},add:function(e){this.exists(e)||this._commands.push(e)},remove:function(e){var t=this._commands.indexOf(e);t!==-1&&this._commands.splice(t,1)},exists:function(e){return this._commands.indexOf(e)!==-1},existsBy:function(e,t){return null!==this.findBy(e,t)},findBy:function(e,t){var i=this._commands.filter(function(i){return i.type===e&&d(t,i.options,!0)});return l(i)},findByType:function(e,t){var i=this._commands.filter(function(i){return!h(t)&&i.type===e||i.type===e&&h(t)&&t(i)});return l(i)},find:function(e){var t=this._commands.indexOf(e);return t!==-1?this._commands[t]:null}});c(a,{RunningCommands:u,makeCommandFactory:n,registerCommand:i})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.view-models",["kendo.mailclient.ns","kendo.mailclient.utils","kendo.mailclient.constants","kendo.mailclient.data","kendo.mailclient.models","kendo.mailclient.auth","kendo.mailclient.events","kendo.mailclient.commandutil"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.mailclient,r=e.extend,o=i.data.DataSource,a=i.data.ObservableObject,d=e.proxy,l=e.isEmptyObject,h=i.keys,c=i.isFunction,u=s.FolderType,f=s.Commands,m=s.FolderTranslateMap,p=s.BroadcastEvents,g=s.HttpCodes,_=Array.isArray,v=Array.prototype.slice,C=s.storage,F=s.arrayCount,w=s.first,y=s.timer,D=s.traceError,I=s.initials,S=s.fileExtension,E=s.confirm,T=s.getNoun,A=s.get,k=s.post,b=s.put,x=s.del,M=s.notNullFilter,R=s.filterByField,U=s.selectField,L=s.findByRef,P=s.bindingTargetSource,O=s.makeCommandFactory,N=s.AccountDataSource,B=s.FolderListDataSource,j=s.MessageListDataSource,V=s.MessageDetailsDataSource,H=s.ContactListDataSource,q=s.Authenticator,z=s.EventManager,W=s.RunningCommands,Q="kendoMailClient",J="currentAccount",G="settings",X="listViewSelectItem",Y="listViewSelectElement",K="listViewClearSelection",$="folder",Z="message",ee="change",te="close",ie="showError",ne="hideError",se="documentClick",re="editComplete",oe="kendoEditor",ae="[data-role='editor']",de="kendoMailClientUpload",le="[data-role='mailclientupload']",he="upload",ce="remove",ue="queueProcessing",fe="queueComplete",me="removeMessage",pe="updateMessage",ge="requestStart",_e="requestEnd",ve="error",Ce=a.extend({init:function(){a.fn.init.call(this)},_initDataSource:function(e){e.bind(ge,this._onRequestStart.bind(this)),e.bind(_e,this._onRequestEnd.bind(this)),e.bind(ve,this._onRequestError.bind(this))},_onRequestStart:function(){this.parent().showProgress()},_onRequestEnd:function(){this.parent().hideProgress()},_onRequestError:function(e){this._isUnauthorized(e.xhr)?D(this._makeErrorMessage(e)):this.parent().showError(this._makeErrorMessage(e))},_isUnauthorized:function(e){return e&&e.status===g.UNAUTHORIZED},_makeErrorMessage:function(e){var t="Request error: ";return t+=e.errorThrown+" ",t+=e.status+" ",t+=e.xhr.statusText},getFirst:function(e){return w(e.view())}}),Fe=a.extend({init:function(){a.fn.init.call(this)}}),we=Ce.extend({init:function(e,t){Ce.fn.init.call(this);var i=t.account;this.onChange=d(this.onChange,this),this._storage=C(Q),this.set("selectedItem",null),this.set("dataSource",new N(e,i.readUrl)),this._initDataSource(this.dataSource)},fetch:function(){return this.dataSource.fetch()},getFirst:function(){return Ce.fn.getFirst.call(this,this.dataSource)},getCurrentId:function(){return this.selectedItem},setCurrentId:function(e){this.set("selectedItem",e),this._storage.set(J,e),this._storage.save()},getCurrent:function(){return this.selectedItem?this.dataSource.get(this.selectedItem):null},switchAccount:function(e){this.parent().folderList.reload(e)},switchToCurrent:function(){var e=this.getCurrent();e||(e=this.getCurrentFromStorage(),e&&this.setCurrentId(e.id)),e||(e=this.getFirst(),e&&this.setCurrentId(e.id)),e&&this.switchAccount(e.id)},getCurrentFromStorage:function(){var e=this._storage.get(J)||null;return e?this.dataSource.get(e):null},onChange:function(){this.setCurrentId(this.selectedItem),this.switchAccount(this.selectedItem)}}),ye=Ce.extend({init:function(e,t,i){Ce.fn.init.call(this);
var n=i.folder;this._options=i,this.set("dataSource",new B(e,n.readUrl)),this._selectedItem=null,this._currentEdit=null,this._currentEditHandler=null,this._storage=C(Q),this.EXPAND_STORAGE_KEY="FolderExpand",this._dragExpanded=[],this._autoCollapseTimeout=2e3,this._autoCollapseTimer=y(this._autoCollapseTimeout,d(this._onAutoCollapse,this)),this.onChange=d(this.onChange,this),this.toggleExpand=d(this.toggleExpand,this),this.onExpanderEnter=d(this.onExpanderEnter,this),this.onFolderBarLeave=d(this.onFolderBarLeave,this),this.onFolderBarEnter=d(this.onFolderBarEnter,this),this.onFolderBarDrop=d(this.onFolderBarDrop,this),this.onDragHint=d(this.onDragHint,this),this.onDrop=d(this.onDrop,this),this.onDragLeave=d(this.onDragLeave,this),this.onDragEnter=d(this.onDragEnter,this),this.onDragStart=d(this.onDragStart,this),this.onContextCommand=d(this.onContextCommand,this),this.onOpenContextMenu=d(this.onOpenContextMenu,this),this.onBroadcastChangeFolder=d(this.onBroadcastChangeFolder,this),t.bind(p.CHANGE_FOLDER,this.onBroadcastChangeFolder),this._initDataSource(this.dataSource),this.dataSource.bind(ee,d(this._updateExpandFromStorage,this))},reload:function(e){var t=this;this.reset(),this.parent().messageList.clearSelection(),t.fetch(e).then(function(){t.switchToCurrent(e)})},fetch:function(e){return this.dataSource.read({accountId:e})},find:function(e){if("function"==typeof this.dataSource.flattenArray){var t=this.dataSource.flattenArray().filter(R("id",e));return w(t)}return this.dataSource.get(e)},findByType:function(e){var t;t="function"==typeof this.dataSource.flattenArray?this.dataSource.flattenArray():this.dataSource.data();var i=t.filter(R("type",e));return w(i)},findTopFolder:function(e){var t=this.getParents(e);return t.length>0?t[t.length-1]:e},flattenAll:function(){return"function"==typeof this.dataSource.flattenArray?this.dataSource.flattenArray():this.dataSource.data()},getParents:function(e,t){return this.dataSource.findParents(e.id,t)},getParent:function(e){var t=this.getParents(e,!0);return w(t)},getParentsAndSelf:function(e){return[e].concat(this.getParents(e))},getFirst:function(){return Ce.fn.getFirst.call(this,this.dataSource)},getCurrent:function(){return this._selectedItem},isCurrent:function(e){var t=this.getCurrent();return!!t&&t.id===e},sort:function(e){e instanceof o&&e.sort(e.options.sort)},findDataSource:function(e){var t=this.getParent(e);return t?t.children:this.dataSource},isRootDataSource:function(e){return e===this.dataSource},isFolder:function(e){var t=this.dataSource.reader.model;return e&&t&&e instanceof t},switchFolder:function(e,t){e&&t&&this.parent().messageList.reload(e,t)},switchToCurrent:function(e){var t=this.getCurrent();t||(t=this.getFirst(),t&&this._updateSelection(t)),t&&this.switchFolder(e,t.id)},folderName:function(e){var t=m[e.type],i=this._options.localization,n=e.get("displayName");return t&&i.folders[t]?i.folders[t]:n},moveToList:function(){return this.dataSource.view().filter(function(e){return e.type!==u.Trash})},totalUnreadItemCount:function(){return this.flattenAll().reduce(function(e,t){return e+t.unreadItemCount},0)},isTrashFolder:function(){var e=this.parent().folderList.getCurrent();return e&&e.type===u.Trash},isSpamFolder:function(){var e=this.parent().folderList.getCurrent();return e&&e.type===u.Junk},isSentFolder:function(){var e=this.parent().folderList.getCurrent();return e&&e.type===u.Sent},_updateSelection:function(e){this._selectedItem=e,this.parent().trigger(X,{type:$,item:e})},reselect:function(){if(this._selectedItem){var e=this.find(this._selectedItem.id);e&&this._updateSelection(e),this._selectedItem=e}},clearSelection:function(){this._selectedItem=null,this.parent().trigger(K,{type:$})},isSubtreeOrSelfSelected:function(e){if(!this._selectedItem)return!1;if(this._selectedItem.id===e.id)return!0;var t=this.getParents(this._selectedItem),i=t.filter(R("id",e.id));return i.length>0},toggleExpand:function(e){e.stopImmediatePropagation(),e.data.toggleExpanded(),this._saveExpand(e.data),this._removeFromDragExpanded(e.data)},reset:function(){this._selectedItem=null,this._currentEdit=null,this._currentEditHandler=null,this._dragExpanded=[],this._autoCollapseTimer.cancel()},onBroadcastChangeFolder:function(e){var t=e.changedFields,i=this.find(e.folderId);i&&Object.keys(t).forEach(function(e){i.set(e,t[e])})},onChange:function(e){var t=this._selectedItem,i=e.sender.dataItem(e.sender.select()),n=this.parent().account.getCurrentId(),s=i&&!t||i&&t&&i.id!==t.id;this._selectedItem=i||null,i&&s&&n&&(this.parent().service.broadcast(p.SELECT_FOLDER,{prev:t,selected:i}),this.switchFolder(n,i.id),this._removeArrayFromDragExpanded(this.getParentsAndSelf(i)))},onFolderItemClick:function(e){e.stopImmediatePropagation(),this.parent().trigger(Y,{type:$,item:e.currentTarget})},onExpanderEnter:function(e){this.cancelAutoCollapse();var t=P(e.dropTarget[0]);t&&!t.expanded&&(t.setExpand(!0),this._addToDragExpanded(t))},onFolderBarLeave:function(){this.autoCollapse()},onFolderBarEnter:function(){this.cancelAutoCollapse()},onFolderBarDrop:function(e){var t=e.draggable.currentTarget,i=t?this._contextModel(t[0]):null;i&&this.onDrop(e),this.autoCollapse()},onDragHint:function(e){var t=e.target?e.target[0]:null,i=t?P(t):null;e.hintData.title=i?this.folderName(i):""},onDrop:function(e){var t=this,i=e.origin||e,n=this._contextModel(i.dropTarget[0]),s=i.draggable?i.draggable.currentTarget:null,r=s&&s.length?this._contextModel(s[0]):null,o=n?n.id:null,a=r?r.id:null,d=r?this.getParent(r):null;if(r){var l=r.parentId!==o&&r.id!==o;if(l){var h=this.parent().command(f.UpdateFolder,{folderId:r.id,parentId:o});h.exec().done(function(){r&&n&&d&&t.changeParent(r,n,d),a&&r&&t._updateExpandFolderId(a,r.id)})}}},onDragLeave:function(){this.autoCollapse()},onDragEnter:function(){this.cancelAutoCollapse()},onDragStart:function(){this.completeEdit()},autoCollapse:function(){this._autoCollapseTimer.restart()},cancelAutoCollapse:function(){this._autoCollapseTimer.cancel()},_onAutoCollapse:function(){this._dragExpanded.forEach(function(e){e.expanded&&e.setExpand(!1)}),this._dragExpanded=[]},_addToDragExpanded:function(e){this._dragExpanded.push(e)},_removeArrayFromDragExpanded:function(e){var t=this;e.forEach(function(e){t._removeFromDragExpanded(e)})},_removeFromDragExpanded:function(e){var t=this._dragExpanded.indexOf(e);t>-1&&this._dragExpanded.splice(t,1)},_updateExpandFromStorage:function(e){if(!e.action){this._storage.open();var t=this._storage.get(this.EXPAND_STORAGE_KEY);t&&this.flattenAll().forEach(function(e){t[e.id]&&e.setExpand(!0)}),this._storage.close()}},_saveExpand:function(e){this._storage.open();var t=this._storage.get(this.EXPAND_STORAGE_KEY)||{};e.expanded?t[e.id]=e.expanded:delete t[e.id],this._storage.set(this.EXPAND_STORAGE_KEY,t),this._storage.save(!0)},_updateExpandFolderId:function(e,t){this._storage.open();var i=this._storage.get(this.EXPAND_STORAGE_KEY)||{};i[e]&&(i[t]=i[e],delete i[e]),this._storage.set(this.EXPAND_STORAGE_KEY,i),this._storage.save(!0)},enableEdit:function(e,t){this.isCurrentEdit(e)||(this._currentEdit&&this._currentEdit!==e&&this.completeEdit(),this._currentEdit=e,this._currentEdit.setEdit(!0),this._currentEditHandler=function(e){c(t)&&t.call(null,e.sender)},this._currentEdit.bind(re,this._currentEditHandler))},enableNewEdit:function(e,t){var i=this.dataSource,n=e?e.id:null,s=i.createFolder(null,n,""),r=e?e.children:i;e&&(e.setHasChildren(!0),e.setExpand(!0)),e||s.incrSortOrder(i.maxSortOrder()),r.pushCreate(s),this.enableEdit(s,t)},isCurrentEdit:function(e){return this._currentEdit===e&&e.edit},cancelEdit:function(){this._currentEdit&&!this._currentEdit.id&&this.remove(this._currentEdit),this.stopEdit()},stopEdit:function(e){if(this._currentEdit){if(this._currentEdit.setEdit(!1),this._currentEdit.unbind(re,this._currentEditHandler),e){var t=this.findDataSource(this._currentEdit);this.sort(this.isRootDataSource(t)?null:t)}this._currentEdit=this._currentEditHandler=null}},completeEdit:function(){this._currentEdit&&this._currentEdit.trigger(re),this.stopEdit(!0)},remove:function(e){var t=this.getParents(e),i=t.length>0?t[0]:null,n=this.dataSource,s=i?i.children:n,r=this._selectedItem===e;s.pushDestroy(e),i&&0===s.total()&&(i.setHasChildren(!1),i.setExpand(!1)),r&&this.parent().messageList.clearAll()},changeParent:function(e,t,i){var n=t?t.children:this.dataSource,s=i,r=s?s.children:this.dataSource,o=t?t.id:null;e.setParentId(o),r.pushDestroy(e),this._updateHasChildren(s),t&&t.setHasChildren(!0),n.pushCreate(e)},_updateHasChildren:function(e){e&&(e.setHasChildren(!!e.children.total()),!e.hasChildren&&e.expanded&&e.setExpand(!1))},onEditKeyUp:function(e){e.keyCode===h.ENTER&&this.completeEdit()},onEditFocusOut:function(){this.completeEdit()},onContextCommand:function(t){var i=e(t.item).data("command"),n=this._contextModel(t.target),s=i?i+"Command":null;s&&"function"==typeof this[s]&&this[s].call(this,n)},onOpenContextMenu:function(e){var t=e.sender,i=e.target,n=this._contextModel(i),s=null!==n,r=!!n&&n.type===u.None,o=n&&n.type===u.Trash,a=n&&n.type===u.Junk,d=n&&n.type!==u.Trash||!n;this._enableContextMenuItems(t,{menuItemCreateFolder:!a,menuItemRenameFolder:r,menuItemDeleteFolder:r,menuItemMarkAsReadFolder:s,menuItemClearFolder:s}),this._visibleContextMenuItems(t,{menuItemCreateFolder:d,menuItemRenameFolder:d,menuItemDeleteFolder:d,menuItemClearFolder:d,menuItemClearTrashFolder:o})},_enableContextMenuItems:function(i,n){n=n||[],i.element.find("> li").each(function(s,r){var o=e(r).data("command");(l(n)||n[o]!==t)&&i.enable(r,n[o])})},_visibleContextMenuItems:function(i,n){n=n||[],i.element.find("> li").each(function(i,s){var r=e(s).data("command");(l(n)||n[r]!==t)&&(n[r]?e(s).show():e(s).hide())})},_contextModel:function(e){var t=P(e);return this.isFolder(t)?t:null},menuItemCreateFolderCommand:function(e){var t=this;this.enableNewEdit(e,function(e){var i=(e.displayName||"").trim();if(i){var n=t.parent().command(f.NewFolder,{model:e});n.exec().fail(function(){t.remove(e)})}else t.cancelEdit()})},menuItemRenameFolderCommand:function(e){var t=this;if(e){var i=e.displayName;this.enableEdit(e,function(e){var n=(e.displayName||"").trim(),s=i!==n;if(e.setDisplayName(n),!n)return void e.setDisplayName(i);if(s){var r=t.parent().command(f.UpdateFolder,{model:e});r.exec().fail(function(){e.setDisplayName(i)})}else t.cancelEdit()})}},menuItemMarkAsReadFolderCommand:function(e){if(e){var t=this.parent().command(f.MarkAsReadFolder,{folderId:e.id});t.exec()}},menuItemClearTrashFolderCommand:function(e){if(e&&e.type===u.Trash){var t=this,n=e.id,s=this._options.localization,r=s.clearTrashFolderConfirmDescr,o=i.format(s.clearTrashFolderConfirm,this.folderName(e));E(o,"",s.dialogs,r).done(function(){var e=t.parent().command(f.ClearAllFolder,{folderId:n});e.exec()})}},menuItemClearFolderCommand:function(e){if(e){var t=this.getParents(e),i=t[t.length-1];i&&i.type===u.Trash?this.clearFolderCommand(e):this.moveAllToTrashCommand(e)}},clearFolderCommand:function(e){var t=this,n=e.id,s=this._options.localization,r=s.deleteAllMessagesConfirmDescr,o=i.format(s.deleteAllMessagesConfirm,this.folderName(e));E(o,"",s.dialogs,r).done(function(){var e=t.parent().command(f.DeleteAll,{folderId:n});e.exec()})},moveAllToTrashCommand:function(e){var t=this,n=e.id,s=this._options.localization,r=i.format(s.deleteAllToTrashConfirm,this.folderName(e));E(r,"",s.dialogs).done(function(){var e=t.findByType(u.Trash),i=t.parent().command(f.MoveAll,{srcFolderId:n,destFolderId:e?e.id:null});i.exec()})},menuItemDeleteFolderCommand:function(e){if(e){var t=this.getParents(e),i=t[t.length-1];i&&i.type===u.Trash?this.deleteFolderCommand(e):this.deleteFolderToTrashCommand(e)}},deleteFolderCommand:function(e){var t=this,n=e.id,s=this._options.localization,r=s.deleteFolderConfirmDescr,o=i.format(s.deleteFolderConfirm,this.folderName(e));E(o,"",s.dialogs,r).done(function(){var e=t.parent().command(f.RemoveFolder,{folderId:n});e.exec()})},deleteFolderToTrashCommand:function(e){var t=this,n=e.id,s=this._options.localization,r=i.format(s.deleteFolderToTrashConfirm,this.folderName(e));E(r,"",s.dialogs).done(function(){var e=t.parent().command(f.RemoveFolderToTrash,{folderId:n});e.exec()})}}),De={initials:function(e,t){return t.contact.imageUrl?null:e?I(e):null},imageUrl:function(e,t,i){var n=e.makeContactImageUrl(t,i);return n?'url("'+n+'")':null},isVisible:function(e,t){return!(!t.contact.imageUrl&&!e)}},Ie=Ce.extend({init:function(e,t,i){Ce.fn.init.call(this);var n=i.message;this._options=i,this.search=d(this.search,this),this.searchOnEnter=d(this.searchOnEnter,this),this.resetSearch=d(this.resetSearch,this),this.isSearching=d(this.isSearching,this),this.toggleFlag=d(this.toggleFlag,this),this.toggleRead=d(this.toggleRead,this),this.toggleFilter=d(this.toggleFilter,this),this.toggleSort=d(this.toggleSort,this),this.selectFilterItem=d(this.selectFilterItem,this),this.resetFilter=d(this.resetFilter,this),this._handleCloseFilter=d(this._handleCloseFilter,this),this._handleCloseSort=d(this._handleCloseSort,this),this.onChange=d(this.onChange,this),this.onDoubleClick=d(this.onDoubleClick,this),this.onDragHint=d(this.onDragHint,this),this.onDrop=d(this.onDrop,this),this.onDragLeave=d(this.onDragLeave,this),this.onDragEnter=d(this.onDragEnter,this),this.onContextCommand=d(this.onContextCommand,this),this.onOpenContextMenu=d(this.onOpenContextMenu,this),this.onBroadcastUpdateMessage=d(this.onBroadcastUpdateMessage,this),this.onBroadcastRemoveMessage=d(this.onBroadcastRemoveMessage,this),this.onBroadcastChangeFolder=d(this.onBroadcastChangeFolder,this),this.onBroadcastSelectFolder=d(this.onBroadcastSelectFolder,this),t.bind(pe,this.onBroadcastUpdateMessage),t.bind(me,this.onBroadcastRemoveMessage),t.bind(p.CHANGE_FOLDER,this.onBroadcastChangeFolder),t.bind(p.SELECT_FOLDER,this.onBroadcastSelectFolder),this.set("dataSource",new j(e,n.readUrl,n.pageSize)),this.set("searchQuery",""),this.set("activeSearch",!1),this.set("moveToMenuItems",new o({data:[]})),this.set("activeFilter",!1),this.set("filterOpened",!1),this.set("filterItems",{}),this.set("resetFilterVisible",!1),this.set("sortOpened",!1),this.set("sortActivated",!1),this.set("sortOrderDesc",!0),this.set("sortItems",[{id:"date",title:"Дата",selected:!0,def:!0},{id:"subject",title:"Тема"},{id:"size",title:"Размер"},{id:"from",title:"От"},{id:"to",title:"Кому"}]),this._selectedItem=null,this._selectedList=null,this._initDataSource(this.dataSource),this.dataSource.bind(_e,d(this._postFetch,this))},reload:function(e,t){this.clearSelection(),this.fetch(e,t)},fetch:function(e,t){this.dataSource.accountId=e,this.dataSource.folderId=t,this.dataSource._skip=0,this.dataSource._page=1,this.search()},_postFetch:function(e){var t=this.parent().folderList.isSentFolder();if(t){var i=e.response||{};(i.Items||[]).forEach(function(e){t&&(e.IsSent=!0)})}},search:function(){this.set("activeSearch",!this.searchQueryEmpty()),this.dataSource.filter(this._makeFilter())},searchOnEnter:function(e){e.keyCode===h.ENTER&&this.search()},resetSearch:function(){this.set("searchQuery",""),this.search()},searchQueryEmpty:function(){return!(this.get("searchQuery")||"").trim()},isSearching:function(){return this.get("activeSearch")},_makeFilter:function(){var e=[],t=(this.searchQuery||"").trim(),i=this.getSortOrder(),n=this.sortOrderDesc;return t&&e.push({field:"search",operator:"eq",value:t}),this.flaggedFilterChecked()&&e.push({field:"is_flag",operator:"eq",value:!0}),this.unreadFilterChecked()&&e.push({field:"is_read",operator:"eq",value:!1}),this.hasAttachmentsFilterChecked()&&e.push({field:"has_attachments",operator:"eq",value:!0}),i&&(e.push({field:"order",operator:"eq",value:i.id}),e.push({field:"desc",operator:"eq",value:n})),e},find:function(e){return this.dataSource.get(e)},remove:function(e){var t=this.find(e);t&&this.dataSource.pushDestroy(t)},clearAll:function(){this.clearSelection(),this.dataSource.data([])},removeList:function(e){var t=this;_(e)&&e.forEach(function(e){e&&t.dataSource.pushDestroy(e)})},add:function(e){this.dataSource.pushCreate(e)},addIfNotExists:function(e){this.dataSource.pushUpdate(e)},itemSubject:function(e){return e.subject||this._options.localization.noSubject},itemInitials:function(e){return De.initials(e.fromName,this._options)},itemImageUrl:function(e){return De.imageUrl(this.parent().service,e.fromName,e.fromAddress)},isAvatar:function(e){return De.isVisible(e.fromName,this._options)},itemToInitials:function(e){return De.initials(this._firstToName(e),this._options)},itemToImageUrl:function(e){return De.imageUrl(this.parent().service,this._firstToName(e),this._firstToAddress(e))},isToAvatar:function(e){return De.isVisible(this._firstToName(e),this._options)},_firstToName:function(e){return e.to&&e.to[0]?e.to[0].Name:null},_firstToAddress:function(e){return e.to&&e.to[0]?e.to[0].Address:null},select:function(e){var t=this.find(e);t&&(this._selectedItem=t,this._updateSelection(t))},clearSelection:function(){this._selectedItem=this._selectedList=null,this.parent().messageDetails.clear(),this._updateClearSelection()},clearSelectedItem:function(){this._selectedItem=null,this._updateClearSelection()},selectedItem:function(e){return arguments.length?void(this._selectedItem=e):this._selectedItem},selectedList:function(e){return arguments.length?void(this._selectedList=e||[]):this._selectedList},singleSelected:function(){return(!this._selectedList||0===this._selectedList.length)&&this._selectedItem},reselect:function(){var e=this;if(this._selectedList){var t=this._selectedList.map(function(t){return e.find(t.id)}).filter(M);t.forEach(function(t){e._updateSelection(t)}),this._selectedList=t}else if(this._selectedItem){var i=this.find(this._selectedItem.id);i&&this._updateSelection(i),this._selectedItem=i}},_clearManySelection:function(){this._selectedList=null,this._updateClearSelection()},_updateSelection:function(e){this.parent().trigger(X,{type:Z,item:e})},_updateClearSelection:function(){this.parent().trigger(K,{type:Z})},folderName:function(e){return this.parent().folderList.folderName(e)},toggleFlag:function(e){var t=e.data;e.stopImmediatePropagation(),t&&(t.isFlag?this.menuItemRemoveFlagCommand([t]):this.menuItemAddFlagCommand([t]))},toggleRead:function(e){var t=e.data;e.stopImmediatePropagation(),t&&(t.isRead?this.menuItemMarkAsUnreadCommand([t]):this.menuItemMarkAsReadCommand([t]))},toggleFilter:function(e){this.filterOpened?(this.set("filterOpened",!1),this.parent().unbind(se,this._handleCloseFilter)):(e.stopImmediatePropagation(),this._handleCloseSort(),this.set("filterOpened",!0),this.parent().bind(se,this._handleCloseFilter))},_handleCloseFilter:function(){this.set("filterOpened",!1),this.parent().unbind(se,this._handleCloseFilter)},selectFilterItem:function(t){var i=e(t.currentTarget).data("filter-id");this.set("filterItems."+i,!this.get("filterItems."+i)),this.set("activeFilter",this.flaggedFilterChecked()||this.unreadFilterChecked()||this.hasAttachmentsFilterChecked()),this.set("resetFilterVisible",this.activeFilter),this.search()},resetFilter:function(){this.set("filterItems",{}),this.set("activeFilter",!1),this.set("resetFilterVisible",!1),this.search()},flaggedFilterChecked:function(){return!!this.get("filterItems.flagged")},unreadFilterChecked:function(){return!!this.get("filterItems.unread")},hasAttachmentsFilterChecked:function(){return!!this.get("filterItems.hasAttachments")},toggleSort:function(e){this.sortOpened?(this.set("sortOpened",!1),this.parent().unbind(se,this._handleCloseSort)):(e.stopImmediatePropagation(),this._handleCloseFilter(),this.set("sortOpened",!0),this.parent().bind(se,this._handleCloseSort))},_handleCloseSort:function(){this.set("sortOpened",!1),this.parent().unbind(se,this._handleCloseSort)},selectSortItem:function(e){var t=this.getSortOrder();this.resetSortItems(),this.set("sortActivated",!e.data.get("def")),e.data.set("selected",!0),e.data.id===t.id&&this.set("sortOrderDesc",!this.get("sortOrderDesc")),this.search()},resetSortItems:function(){var e=w(this.sortItems.filter(R("selected",!0)));e&&e.set("selected",!1)},_resetSort:function(){this.resetSortItems(),this.set("sortActivated",!1),this.set("sortOrderDesc",!0);var e=w(this.sortItems.filter(R("def",!0)));e&&e.set("selected",!0)},getSortOrder:function(){return w(this.sortItems.filter(R("selected",!0)))},onChange:function(e){var t=e.sender,i=t.select().map(function(e,i){return t.dataItem(i)}).get(),n=!_(i)||0===i.length,s=!n&&i.length>1,r=n?null:i[0];s?this._selectedList=i:r&&this._showMessage(r)},onDoubleClick:function(e){var t=e.data;t&&t.isDraft&&this.menuItemEditCommand([t])},onDragHint:function(e){e.hintData.count=1,e.target&&this._elementInSelectedList(e.target[0])&&(e.hintData.count=(this._selectedList||[]).length)},onDrop:function(e){var t=e.origin,i=P(t.dropTarget[0]),n=this.parent().folderList,s=this.parent().folderList.getCurrent(),r=t.draggable?t.draggable.currentTarget:null,o=r&&r.length?P(r[0]):null,a=s&&i&&o&&s.id!==i.id,d=[];return a&&(this._elementInSelectedList(r[0])?d=(this._selectedList||[]).slice():d.push(o),d.length>0)?void this._moveToFolder(i,d).done(function(){n.autoCollapse()}).fail(function(){n.autoCollapse()}):void n.autoCollapse()},onDragLeave:function(){this.parent().folderList.autoCollapse()},onDragEnter:function(){this.parent().folderList.cancelAutoCollapse()},_broadcastFilter:function(e){if(e){var t=e.folderId;return this.parent().folderList.isCurrent(t)}return!0},onBroadcastUpdateMessage:function(e){var t=e.newMessageId,i=e.oldMessageId;if(i&&t&&this._broadcastFilter(e.filter)){var n=this.find(i);n&&n.setId(t)}},onBroadcastRemoveMessage:function(e){var t=e.messageId;t&&this._broadcastFilter(e.filter)&&this.remove(t)},onBroadcastChangeFolder:function(e){var i=this.parent(),n=e.changedFields,s=i.folderList.isCurrent(e.folderId);!s||n.unreadItemCount===t&&n.totalItemCount===t||i.command(f.Refresh,{noRefreshFolders:!0}).exec()},onBroadcastSelectFolder:function(){this.set("searchQuery",""),this.set("activeSearch",!1),this.set("filterItems",{}),this.set("activeFilter",!1),this.set("resetFilterVisible",!1),this._resetSort();var e=this.dataSource.filter();e&&e.filters&&(e.filters=[]),this._handleCloseFilter(),this._handleCloseSort()},_moveToFolder:function(e,t){var i=this.parent().command(f.MoveTo,{messageIds:t.map(U("id")),folderId:e.id});return i.exec()},_elementInSelectedList:function(e){if(this._selectedList){var t=P(e);if(t){var i=this._selectedList.filter(R("id",t.id));return i.length>0}}return!1},_showMessage:function(e,t){var i=this.parent(),n=i.account.getCurrentId(),s=i.folderList.getCurrent(),r=this._selectedItem,o=e&&!r||e&&r&&r.id!==e.id;e&&o&&n&&s&&(this._selectedItem=e,this._selectedList=null,i.messageDetails.show(n,s.id,e.id),t&&(this._updateClearSelection(),this._updateSelection(e)))},_findMessageIdsForCommand:function(e,t,i){return e.filter(R(t,i)).map(U("id"))},menuItemOpenCommand:function(e){var t=e[0];return!!t&&(this._showMessage(t,!0),null)},menuItemReplyCommand:function(e){var t=e[0];if(t){var i=this.parent().command(f.Reply,{messageId:t.id});return i.exec()}return!1},menuItemReplyAllCommand:function(e){var t=e[0];if(t){var i=this.parent().command(f.Reply,{messageId:t.id,isAll:!0});return i.exec()}return!1},menuItemForwardCommand:function(e){var t=e[0];if(t){var i=this.parent().command(f.Forward,{messageId:t.id});return i.exec()}return!1},menuItemEditCommand:function(e){var t=e[0];if(t){if(!this.isRunningEditDraftCommand(t.id)){var i=this.parent().command(f.EditDraft,{messageId:t.id});return i.exec()}this.parent().broadcast(p.COMPOSE_WND_FOCUS,{messageId:t.id})}return!1},menuItemMarkAsReadCommand:function(e){var t=this._findMessageIdsForCommand(e,"isRead",!1);if(t.length>0){var i=this.parent().command(f.MarkAsRead,{messageIds:t});return i.exec()}return!1},menuItemMarkAsUnreadCommand:function(e){var t=this._findMessageIdsForCommand(e,"isRead",!0);if(t.length>0){var i=this.parent().command(f.MarkAsUnread,{messageIds:t});return i.exec()}return!1},menuItemAddFlagCommand:function(e){var t=this._findMessageIdsForCommand(e,"isFlag",!1);if(t.length>0){var i=this.parent().command(f.AddFlag,{messageIds:t});return i.exec()}return!1},menuItemRemoveFlagCommand:function(e){var t=this._findMessageIdsForCommand(e,"isFlag",!0);if(t.length>0){var i=this.parent().command(f.RemoveFlag,{messageIds:t});return i.exec()}return!1},menuItemSpamCommand:function(e){var t=this.parent().command(f.MoveTo,{messageIds:e.map(U("id")),folderType:u.Junk});return t.exec()},menuItemDeleteCommand:function(e){var t=this.deleteMessagesCommand(e);return t.defer},deleteMessagesCommand:function(t){var n,s,r=this,o=this.parent().folderList,a=o.getCurrent(),d=a?o.findTopFolder(a):null,l=!!d&&d.type===u.Trash;if(l&&a){var h=this._options.localization,c=t.length>1?h.deleteMessagesConfirmDescr:h.deleteMessageConfirmDescr,m=t.length>1?i.format(h.deleteMessagesConfirm,t.length,T.apply(null,[t.length].concat(h.deleteMessagesConfirmNoun))):i.format(h.deleteMessageConfirm,this.itemSubject(t[0])),p=t.map(U("id"));s=e.Deferred(),n=r.parent().command(f.Delete,{folderId:a.id,messageIds:p}),E(m,"",h.dialogs,c,500).done(function(){n.exec().done(s.resolve).fail(s.reject)})}else n=this.parent().command(f.MoveTo,{messageIds:t.map(U("id")),folderType:u.Trash}),s=n.exec();return{command:n,defer:s}},menuItemMoveToCommand:function(e,t){var i=this.parent().folderList.getCurrent(),n=t.data("folder-id");if(n&&(!i||i.id!==n)){var s=this.parent().command(f.MoveTo,{messageIds:e.map(U("id")),folderId:n});return s.exec()}return!1},menuItemEditAsNewCommand:function(e){var t=e[0];if(t){var i=this.parent().command(f.EditAsNew,{messageId:t.id});return i.exec()}return!1},isRunningEditDraftCommand:function(e){return this.parent().runningCommands.findByType(f.EditDraft,function(t){return t.viewModel.getDraft().id===e})},onContextCommand:function(t){var i=this,n=e(t.item),s=P(t.target),r=n.data("command"),o=r?r+"Command":null,a=this._selectedList&&this._selectedList.length>0;if(o&&"function"==typeof this[o]){if(a){var d=!!L(this._selectedList,s);if(d){var l=this[o].call(this,this._selectedList,n);return void(l&&"function"==typeof l.done&&l.done(function(){i._clearManySelection()}))}}s&&this[o].call(this,[s],n)}},onOpenContextMenu:function(t){var i=t.item,n=t.sender,s=t.target,r=this.parent(),o=i&&e(i).hasClass("k-item");if(!o){this.moveToMenuItems.data(r.folderList.moveToList()),n._updateClasses();var a=this._selectedList&&this._selectedList.length>0,d=P(s);if(!a&&d)this._processContextMenuItems(n,[d]);else if(a&&d){var l=!!L(this._selectedList,d);l?this._processContextMenuItems(n,this._selectedList):this._processContextMenuItems(n,[d])}else a&&this._processContextMenuItems(n,this._selectedList)}},_processContextMenuItems:function(n,s){var r=s.length>1,o=r?{}:s[0],a={},d={},l={},h=this.parent(),c=h.folderList.isSpamFolder(),u=h.folderList.getCurrent();if(r){a.menuItemOpen=!0,a.menuItemReply=!0,a.menuItemReplyAll=!0,a.menuItemForward=!0,a.menuItemEdit=!0,a.menuItemEditAsNew=!0;var f=F(s,R("isRead",!0)),m=F(s,R("isFlag",!0)),p=s.length-f,g=s.length-m;a.menuItemMarkAsRead=!p,a.menuItemMarkAsUnread=!f,a.menuItemAddFlag=!g,a.menuItemRemoveFlag=!m,l.menuItemMarkAsRead=p,l.menuItemMarkAsUnread=f,l.menuItemDelete=s.length}else a.menuItemReply=o.isDraft,a.menuItemReplyAll=o.isDraft,a.menuItemForward=o.isDraft,a.menuItemEdit=!o.isDraft,a.menuItemMarkAsRead=o.isRead,a.menuItemMarkAsUnread=!o.isRead,a.menuItemAddFlag=o.isFlag,a.menuItemRemoveFlag=!o.isFlag;a.menuItemDelete=!1,a.menuItemSpam=c||o.isDraft,n.element.find("> li").show().each(function(s,r){var o=e(r),h=r,c=h._titleChanged_,u=h._originTitle_,f=o.data("many-title"),m=o.data("command"),p=a[m],g=d[m],_=l[m]||0,v=o.find("> .k-link");p&&o.hide(),g!==t&&n.enable(r,!g),_>0&&f?(h._titleChanged_||(h._titleChanged_=!0,h._originTitle_=v.html()),v.html(i.format(f,_))):c&&(v.html(u),h._titleChanged_=!1,h._originTitle_=null)}),n.element.find("li[data-folder-id]").each(function(t,i){var s=e(i),r=s.data("folder-id"),o=s.find("> .k-link > span"),a=o.length>0?P(o[0]):null;u&&u.id===r&&(a&&a.children&&a.children.total()>0?s.addClass("context-menu__subitem--disabled"):n.enable(i,!1))})}}),Se=Ce.extend({init:function(e,t,i){Ce.fn.init.call(this);var n=i.message;this.set("dataSource",new V(e,n.readItemUrl)),this.set("hasCurrent",!1),this.set("infoVisible",!1),this.set("folderSelectorOpened",!1),this.set("additionalActionsOpened",!1),this.set("moveToItems",new o({data:[]})),this._options=i,this._markAsReadTimer=null,this._moveToCommand=null,this._setFlagCommand=null,this._handleCloseFolderSelector=d(this._handleCloseFolderSelector,this),this._handleCloseAdditionalActions=d(this._handleCloseAdditionalActions,this),this.onBroadcastUpdateMessage=d(this.onBroadcastUpdateMessage,this),this.onBroadcastRemoveMessage=d(this.onBroadcastRemoveMessage,this),t.bind(pe,this.onBroadcastUpdateMessage),t.bind(me,this.onBroadcastRemoveMessage),this._initDataSource(this.dataSource)},fetch:function(e,t,i){var n=this;return this.dataSource.read({accountId:e,folderId:t,messageId:i}).then(function(){return n._resetState(),n.set("hasCurrent",!0),n.getCurrent()})},show:function(e,t,i){var n=this,s=this._options.message;return this._cancelMarkAsReadTimer(),this.fetch(e,t,i).done(function(e){e.isRead||null===s.markAsReadTimeout||n._startMarkAsReadTimer(e.id,s.markAsReadTimeout)})},getCurrent:function(){var e=this.dataSource.view();return e&&e.length>0?e[0]:null},isCurrent:function(e){var t=this.getCurrent();return!!t&&t.id===e},find:function(e){return this.dataSource.get(e)},clear:function(){this.set("hasCurrent",!1),this.dataSource.data([]),this._resetState()},close:function(){var e=this.getCurrent(),t=this.parent().messageList,i=t.selectedItem(),n=t.selectedList(),s=i&&e&&i.id===e.id;s&&(n?t.selectedItem(null):t.clearSelectedItem()),this.clear()},moveToTrash:function(){var e=this.getCurrent(),t=this.parent();e&&t.messageList.deleteMessagesCommand([e])},moveToSpam:function(){this.moveToFolder(u.Junk)},isTrashFolder:function(){return this.parent().folderList.isTrashFolder()},isSpamFolder:function(){return this.parent().folderList.isSpamFolder()},isSentFolder:function(){return this.parent().folderList.isSentFolder()},moveToFolder:function(e,t){var i,n=this.getCurrent(),s=this.parent(),r=s.folderList.getCurrent(),o=(!r||r.id!==t)&&n&&!this._commandPending(this._moveToCommand);o&&(i=s.command(f.MoveTo,{messageIds:[n.id],folderType:e,folderId:t}),i.exec(),this._moveToCommand=i)},toggleFlag:function(){var e,t=this.getCurrent(),i=this.parent();t&&!this._commandPending(this._setFlagCommand)&&(e=t.isFlag?i.command(f.RemoveFlag,{messageIds:[t.id]}):i.command(f.AddFlag,{messageIds:[t.id]}),e.exec(),this._setFlagCommand=e)},markAsRead:function(e){var t,i=this.parent();e&&(t=i.command(f.MarkAsRead,{messageIds:[e],noProgressBar:!0}),t.exec())},reply:function(){this._reply(!1)},replyAll:function(){this._reply(!0)},_reply:function(e){var t=this.getCurrent();t&&this.parent().command(f.Reply,{messageDetails:t,isAll:e}).exec()},forward:function(){var e=this.getCurrent();e&&this.parent().command(f.Forward,{messageDetails:e}).exec()},editAsNew:function(){var e=this.getCurrent();e&&this.parent().command(f.EditAsNew,{messageDetails:e}).exec()},edit:function(){var e=this.getCurrent();if(e&&e.isDraft){var t=this.parent().runningCommands.findByType(f.EditDraft,function(t){return t.viewModel.getDraft().id===e.id});t?this.parent().broadcast(p.COMPOSE_WND_FOCUS,{messageId:e.id}):this.parent().command(f.EditDraft,{messageDetails:e}).exec()}},toggleInfo:function(){this.set("infoVisible",!this.get("infoVisible"))},toggleAdditionalActions:function(e){this.additionalActionsOpened?this.closeAdditionalActions():(this.closeFolderSelector(),this.openAdditionalActions(e))},openAdditionalActions:function(e){e.stopImmediatePropagation(),this.set("additionalActionsOpened",!0),this.parent().bind(se,this._handleCloseAdditionalActions)},closeAdditionalActions:function(){this.set("additionalActionsOpened",!1),this.parent().unbind(se,this._handleCloseAdditionalActions);
},_handleCloseAdditionalActions:function(){this.closeAdditionalActions()},toggleFolderSelector:function(e){this.folderSelectorOpened?this.closeFolderSelector():(this.closeAdditionalActions(),this.openFolderSelector(e))},openFolderSelector:function(e){e.stopImmediatePropagation(),this.updateMoveToItems(),this.set("folderSelectorOpened",!0),this.parent().bind(se,this._handleCloseFolderSelector)},closeFolderSelector:function(){this.set("folderSelectorOpened",!1),this.parent().unbind(se,this._handleCloseFolderSelector)},_handleCloseFolderSelector:function(){this.closeFolderSelector()},selectFolder:function(e){var t=e.data;e.stopImmediatePropagation(),this.closeFolderSelector(),t&&this.moveToFolder(null,t.id)},folderName:function(e){return this.parent().folderList.folderName(e)},folderList:function(){return[]},updateMoveToItems:function(){var e=[],t=this.parent().folderList.moveToList(),i=0;this._flattenMoveToItems(e,i,t),this.moveToItems.data(e)},_flattenMoveToItems:function(e,t,i){for(var n=0;n<i.length;n++)i[n].deepLevel=t,e.push(i[n]),i[n].children.total()>0&&this._flattenMoveToItems(e,t+1,i[n].children.data())},isMoveToItemDisabled:function(e){var t=this.parent().folderList.getCurrent();return t&&t.id===e.id},onDownloadAttachment:function(e){var t=this,i=this.parent(),n=i.auth,s=n.enabled()?n.token:null,r=e.data;s?(r.set("progress",!0),n.validateOrRefreshToken(s).done(function(){r.set("progress",!1);var e=t.makeAttachmentUrl(r.FileId,n.token);e!==!1?r.set("downloadUrl",[{url:e}]):r.set("downloadUrl",[])}).fail(function(){r.set("progress",!1),r.set("downloadUrl",[])})):r.set("downloadUrl",[]),e.preventDefault()},makeAttachmentUrl:function(e,t){var n=this._options,s=this.parent(),r=n.message.attachmentUrl,o=this.getCurrent(),a=o?o.folderId:null,d=o?o.id:null,l=s.account.getCurrentId(),h=l&&a&&d&&r&&e;return!!h&&i.format(r,l,a,d,e,t)},initials:function(e){return De.initials(e.fromName,this._options)},imageUrl:function(e){return De.imageUrl(this.parent().service,e.fromName,e.fromAddress)},isAvatar:function(e){return De.isVisible(e.fromName,this._options)},_commandPending:function(e){return e&&e.isPending()},_startMarkAsReadTimer:function(e,t){var i=this;this._cancelMarkAsReadTimer(),this._markAsReadTimer=y(t,function(){i.markAsRead(e)}),this._markAsReadTimer.start()},_cancelMarkAsReadTimer:function(){this._markAsReadTimer&&(this._markAsReadTimer.cancel(),this._markAsReadTimer=null)},_resetState:function(){this.set("infoVisible",!1),this.set("folderSelectorOpened",!1),this.moveToItems.data([]),this._cancelMarkAsReadTimer()},_broadcastFilter:function(e){if(e){var t=e.folderId;return this.parent().folderList.isCurrent(t)}return!0},onBroadcastUpdateMessage:function(e){var t=e.newMessageId,i=e.oldMessageId;i&&t&&this.isCurrent(i)&&this._broadcastFilter(e.filter)&&this.getCurrent().setId(t)},onBroadcastRemoveMessage:function(e){var t=e.messageId;t&&this.isCurrent(t)&&this._broadcastFilter(e.filter)&&this.close()}}),Ee=a.extend({init:function(e){a.fn.init.call(this),this._options=e,this.onPreviewNotFound=d(this.onPreviewNotFound,this),this.onBeforePreviewOpen=d(this.onBeforePreviewOpen,this)},onPreviewNotFound:function(e){var t=e.sender,i={Name:"",Email:""},n=t.target(),s=n?n.data("preview"):null,r=n?n.data("preview-title"):null;i.Title=r||"",i.Email=s||"",e.data=i},onBeforePreviewOpen:function(e){var t=e.sender,i=t.options.content,n=this._options.contact.ajaxOptions,s=e.target?e.target.data("preview"):null,r=this.parent().service;i.url=s?r.makeContactPreviewUrl(s):null,i.xhrFields={withCredentials:n.withCredentials}}}),Te=a.extend({init:function(t){var i={to:[],cc:[],bcc:[],subject:"",body:""};t=e.extend(i,t||{}),a.fn.init.call(this,t)}}),Ae=a.extend({init:function(e,t){a.fn.init.call(this),this.auth=e,this._options=t,this._uploader=null,this.set("fileCount",0),this.set("fileListOpened",!1),this.set("fileListEnabled",!1),this.set("actionPending",!1),this.set("actionQueue",[]),this.toggleFileList=d(this.toggleFileList,this),this.onFileSelect=d(this.onFileSelect,this),this.onFileUpload=d(this.onFileUpload,this),this.onFileSuccess=d(this.onFileSuccess,this),this.onFileRemove=d(this.onFileRemove,this),this.onFileCancel=d(this.onFileCancel,this),this.onFileError=d(this.onFileError,this),this.onUploadCompleted=d(this.onUploadCompleted,this),this.onFileListCreated=d(this.onFileListCreated,this),this.onFileListDestroyed=d(this.onFileListDestroyed,this)},initFiles:function(e){this.updateFiles(e)},updateFiles:function(e){if(e&&e.length>0&&this.getUploader()){var t=this.getUploader();this._updateUploadedFiles(t,{Attachments:e}),this.set("fileCount",e.length)}},getFiles:function(){return this.getUploader()?this.getUploader().getFiles().map(this.selectFile):[]},selectFile:function(e){return{id:e.id,name:e.name,size:e.size,ext:e.extension}},initUploader:function(){var e=this.getUploader();e&&this.setFileListEnabled(e.isFileList())},getUploader:function(){return this._uploader||(this._uploader=this.findUploader()),this._uploader},findUploader:function(){var e=this.parent().getWnd();return e?e.element.find(le).data(de):null},dispose:function(){this.set("actionQueue",[]),this._uploader=null},addFileCount:function(e){this.set("fileCount",this.fileCount+e)},subFileCount:function(e){var t=this.fileCount-e;this.set("fileCount",t<0?0:t)},toggleFileList:function(){this.fileListEnabled?this.set("fileListOpened",!this.fileListOpened):this.set("fileListOpened",!1)},setFileListOpened:function(e){this.set("fileListOpened",e)},closeFileList:function(){this.setFileListOpened(!1)},setFileListEnabled:function(e){this.set("fileListEnabled",e)},isPending:function(){return this.get("actionPending")},pending:function(e){this.set("actionPending",e)},actionQueueCount:function(){return this.get("actionQueue").length},queueAction:function(e,t){var i=this;e=e||[],e.forEach(function(e){i.actionQueue.push({op:t,fileUid:e.uid})})},queueUpload:function(e){this.queueAction(e,he)},queueRemove:function(e){this.queueAction(e,ce)},removeQueueAction:function(e,t){var i=this;e=e||[],e.forEach(function(e){var n=i.actionQueue.find(function(i){return i.fileUid===e.uid&&i.op===t});n&&i.actionQueue.remove(n)})},performNextAction:function(e){if(!this.isPending()){var t=this.actionQueue.shift();t?(t.op===he?this.performUploadAction(e,t):t.op===ce&&this.performRemoveAction(e,t),this.trigger(ue)):this.trigger(fe)}},performUploadAction:function(e,t){var i=t.fileUid;i&&e.hasFileByUid(i)?e.uploadFileByUid(i):this.performNextAction(e)},performRemoveAction:function(e,t){var i=t.fileUid,n=i?e.findFileDataByUid(i):null,s=i&&n&&n.id&&e.isFileUploadedByUid(i);s?(this.prepareRemoveUrl(e,n.id),this.pending(!0),this._fileListProgress(e,!0),e.removeFileByUid(i)):this.performNextAction(e)},performNextActionAsync:function(e){var t=this;this._runAsync(function(){t.auth.validateOrRefreshToken().done(function(){t.performNextAction(e)})})},prepareUploadUrl:function(e){var t=this.parent(),i=t._service,n=t.getDraft()||{},s=e.options.async;s.saveUrl=i.makeUploadFileUrl(n.id,n.folderId)},prepareRemoveUrl:function(e,t){var i=this.parent(),n=i._service,s=i.getDraft()||{},r=e.options.async;r.removeUrl=n.makeRemoveFileUrl(s.id,t,s.folderId)},_runAsync:function(e){var t=this,i=window.setTimeout(function(){clearTimeout(i),c(e)&&e.call(t)},0)},_updateFileCount:function(e,t){t===he?this.addFileCount(e):t===ce&&this.subFileCount(e)},_updateDraft:function(e){var t=this.parent(),i=e.UniqueId||null;i&&t.setDraft(i)},_updateUploadedFiles:function(e,t){var i=t.Attachments||[],n=this.fileListOpened;i.length>0&&(e.clearUploadedFiles(),e.addUploadedFiles(i.map(function(e){return{name:e.FileName,size:e.FileSize,extension:S(e.FileName,!0),id:e.FileId}})),this.setFileListOpened(n))},_updateUploadedFilesAsync:function(e,t){this._runAsync(function(){this._updateUploadedFiles(e,t)})},_isFilesUploaded:function(e,t){var i=t.filter(function(t){return e.isFileUploadedByUid(t.uid)});return i.length===t.length},_fileListProgress:function(e,t){e.fileListProgress(t)},onFileSelect:function(e){var t=this,i=this.parent(),n=e.sender,s=e.files;this.queueUpload(s),this.setFileListOpened(!0),i.createDraft().done(function(){t.performNextActionAsync(n)})},onFileRemove:function(e){var t=this,i=this.parent(),n=e.sender,s=e.files;this.removeQueueAction(e.files,he),this._isFilesUploaded(n,s)&&(e.preventDefault(),this.isPending()||(this.removeQueueAction(s,ce),this.queueRemove(s),i.createDraft().done(function(){t.performNextActionAsync(n)})))},onFileUpload:function(e){return this.isPending()?void e.preventDefault():(this.pending(!0),this._fileListProgress(e.sender,!0),void this.prepareUploadUrl(e.sender))},onFileSuccess:function(e){var t=e.response||{},i=e.operation,n=e.files||[],s=n.length,r=e.sender;this.pending(!1),this._fileListProgress(r,!1),this._updateFileCount(s,i),this._updateDraft(t),this._updateUploadedFilesAsync(r,t),this.performNextActionAsync(r)},onFileCancel:function(e){this.pending(!1),this._fileListProgress(e.sender,!1),this.performNextActionAsync(e.sender)},onFileError:function(e){this.pending(!1),this._fileListProgress(e.sender,!1),this.performNextActionAsync(e.sender)},onUploadCompleted:function(){},onFileListCreated:function(){this.setFileListEnabled(!0)},onFileListDestroyed:function(){this.setFileListEnabled(!1),this.setFileListOpened(!1)}}),ke=a.extend({init:function(e,t,n){a.fn.init.call(this),this._prepareMessageData(n),this.set("msg",new Te(n)),this.set("attachments",new Ae(t.getAuth(),e)),this.set("sending",!1),this.set("sendError",!1),this.set("draftSaveError",!1),this.set("copyVisible",!1),this.set("hasUnsavedData",!1),this.set("attachmentSaved",!0),this.set("dataSavedTs",null),this.set("isSettingsOpened",!1),this.set("settingItems",[{id:"highPriority",title:"Высокий приоритет",checked:!!this.msg.highPriority,icon:"flag"},{id:"confirmRead",title:"Подтвердить прочтение",checked:!!this.msg.confirmRead,icon:"envelope-open-o"},{id:"confirmDelivery",title:"Подтверждение о доставке",checked:!!this.msg.confirmDelivery,icon:"laptop"}]),this.dialogResult=!1,this._options=e,this._service=t,this._draft={id:null,folderId:null},this._wnd=null,this._editor=null,this._titleSet=!1,this._draftDeferred=null,this._saveDraftQueued=!1,this._forceClose=!1,this._needRefreshAfterClose=!1,this._initDataSources(n),this._initDraft(n),this._saveDraftTimer=y(e.draft.saveTimeout,d(this._queueSaveDraft,this)),this._notifyDataChanged=i.throttle(d(this._dataChanged,this),e.draft.notifyChangedTimeout),this._resizeEditorToolbarHandler=i.throttle(d(this._resizeEditorToolbar,this),500),this._saveDraftDone=d(this._saveDraftDone,this),this._saveDraftFail=d(this._saveDraftFail,this),this._sendDraftDone=d(this._sendDraftDone,this),this._sendDraftFail=d(this._sendDraftFail,this),this.msg.bind(ee,this._notifyDataChanged),this.attachments.bind(ue,d(this.onAttachmentProcessing,this)),this.attachments.bind(fe,d(this.onAttachmentCompleted,this)),this.onBroadcastComposeWndFocus=d(this.onBroadcastComposeWndFocus,this),t.onBroadcast(p.COMPOSE_WND_FOCUS,this.onBroadcastComposeWndFocus),this._onCloseSettings=d(this._onCloseSettings,this),this._onEditorFocus=d(this._onEditorFocus,this),this._waitSaveDaftAndClose=d(this._waitSaveDaftAndClose,this)},_initDataSources:function(e){var t=this._options,i=[],n=[],s=[];e&&(i=e.to||[],n=e.cc||[],s=e.bcc||[]),this.set("toDataSource",this._createContactDataSource(i,t)),this.set("ссDataSource",this._createContactDataSource(n,t)),this.set("bссDataSource",this._createContactDataSource(s,t)),this.set("copyVisible",n.length>0||s.length>0)},_initDraft:function(e){if(e){var t=e.messageId||null,i=e.folderId||null;this.setDraft(t,i)}},setWnd:function(e){this._oldTitle=e.title(),this._wnd=e},getWnd:function(){return this._wnd},send:function(){this.sendEnabled()&&(this.attachments.closeFileList(),this.hasUnsavedData||!this.hasDraft()?this.saveDraftAndSend():this._sendDraft())},saveDraftAndSend:function(){var e=this;this.cancelSaveDraftTimer(),this.pending(!0);var t=function(){e._sendDraft()},i=function(){e.pending(!1),e.showSendError()};this._draftDeferred?this._draftDeferred.done(t).fail(i):this._saveDraft().done(t).fail(i)},sendEnabled:function(){var e=this.get("attachmentSaved"),t=(this.get("msg.to")||[]).length>0,i=!this.get("sending");return e&&t&&i},pending:function(e){this.set("sending",e)},showSendError:function(){this.set("sendError",!0),this.set("draftSaveError",!1)},showDraftError:function(){this.set("sendError",!1),this.set("draftSaveError",!0)},hideErrors:function(){this.set("sendError",!1),this.set("draftSaveError",!1)},showCopy:function(){this.set("copyVisible",!0)},dataSavedTsFormatted:function(){var e=this.get("dataSavedTs");return e?i.toString(e,"t"):""},saveStatusVisible:function(){return!this.get("hasUnsavedData")&&!!this.get("dataSavedTs")&&!this.get("sending")&&this.get("attachmentSaved")},toggleSettings:function(e){this.isSettingsOpened?(this.set("isSettingsOpened",!1),this._service.parent().unbind(se,this._onCloseSettings)):(e.stopImmediatePropagation(),this.set("isSettingsOpened",!0),this._service.parent().bind(se,this._onCloseSettings))},_onCloseSettings:function(){this.set("isSettingsOpened",!1),this._service.parent().unbind(se,this._onCloseSettings)},onSelectSettingItem:function(e){e.stopImmediatePropagation(),e.data.set("checked",!e.data.get("checked")),this._notifyDataChanged()},isSettingChecked:function(e){var t=w(this.settingItems.filter(R("id",e)));return!!t&&t.checked},onResizeWnd:function(){this._resizeEditorToolbarHandler(this._editor)},onAfterOpenWnd:function(){this._editor=this._findEditor(),this._resizeEditorToolbarHandler(this._editor),this._initEditorEvents(this._editor),this.attachments.initUploader(),this.attachments.initFiles(this.msg.attachments)},onAfterCloseWnd:function(){this._needRefreshAfterClose&&this._refreshMessages(),this.destroy()},onBeforeCloseWnd:function(e){this._forceClose||!this.hasUnsavedData&&this.attachmentSaved||(this.closeConfirm(),e.preventDefault()),this._forceClose&&(this._removeDraft(),this._needRefreshAfterClose=!1)},closeConfirm:function(){var e=this,t=this._options.localization,i=t.unsavedDataConfirm;E(i,"",t.usavedDataDialog,null,480).done(function(){e.unbind(ee,e._waitSaveDaftAndClose),e.bind(ee,e._waitSaveDaftAndClose)}).fail(function(){e._forceClose=!0,e._close()})},_waitSaveDaftAndClose:function(e){"hasUnsavedData"!==e.field&&"attachmentSaved"!==e.field||!this.hasUnsavedData&&this.attachmentSaved&&this._close()},onAttachmentProcessing:function(){this.set("attachmentSaved",!1),this._updateTitle(),this._needRefreshAfterClose=!0},onAttachmentCompleted:function(){this.set("attachmentSaved",!0),this._updateDataSavedTs(),this._updateTitle(),this.onSaveDraftQueue()},onBroadcastComposeWndFocus:function(e){var t=e.messageId;t===this.getDraft().id&&this._wnd&&(this._wnd.toFront(),this._editor&&this._editor.focus())},_findEditor:function(){return this._wnd?this._wnd.element.find(ae).data(oe):null},_resizeEditorToolbar:function(e){e&&e.toolbar.resize()},_initEditorEvents:function(t){t&&t.body&&e(t.body).on("focus",this._onEditorFocus)},_remEditorEvents:function(t){t&&t.body&&e(t.body).off("focus",this._onEditorFocus)},_onEditorFocus:function(){this._onCloseSettings()},editorChanged:function(){this._notifyDataChanged()},_editorValue:function(){return this._editor?this._editor.value():null},_syncEditorValue:function(){this.msg.body=this._editorValue()},_sendDraft:function(){this.pending(!0),this._service.sendDraft(this._draft.id,this._draft.folderId).done(this._sendDraftDone).fail(this._sendDraftFail)},_sendDraftDone:function(){this.pending(!1),this.onRemoveMessage(this._draft.id,{folderId:this._draft.folderId}),this._needRefreshAfterClose=!1,this._close()},_sendDraftFail:function(e){D(e.toString()),this.pending(!1),this.showSendError()},_saveDraft:function(){this._syncEditorValue();var e=this._draft,t=this._service,i=!e.id,n=this._createMsg(i);return this.hideErrors(),this._draftDeferred=t.saveDraft(e.id,e.folderId,n).done(this._saveDraftDone).fail(this._saveDraftFail),this._draftDeferred},_queueSaveDraft:function(){this._draftDeferred||!this.attachmentSaved?this._saveDraftQueued=!0:this._saveDraft()},_saveDraftDone:function(e){this._draftDeferred=null,this.setDraft(e.id,e.folderId),this.attachments&&this.attachments.updateFiles(e.files),this._dataSaved(),this.onSaveDraftQueue()},_saveDraftFail:function(e){D(e.toString()),this._draftDeferred=null,this.showDraftError(),this.onSaveDraftQueue()},onSaveDraftQueue:function(){this._saveDraftQueued&&(this._saveDraftQueued=!1,this._queueSaveDraft())},createDraft:function(){var t=this,i=e.Deferred();return this._draftDeferred?this._createDraftWait||(this._createDraftWait=!0,this._draftDeferred.done(function(){i.resolve(t.getDraft()),t._createDraftWait=!1}).fail(function(e){t._createDraftWait=!1,i.reject(e)})):this.hasDraft()?(this.hasUnsavedData&&(this.cancelSaveDraftTimer(),this._saveDraftQueued=!0),i.resolve(this.getDraft())):(this.cancelSaveDraftTimer(),this._markAsUnsaved(),this._saveDraft().done(function(){i.resolve(t.getDraft())}).fail(i.reject)),i},cancelSaveDraftTimer:function(){this._saveDraftTimer.cancel()},getDraft:function(){return this._draft},setDraft:function(e,t){var i=this._draft.id;this._draft.id=e,t&&(this._draft.folderId=t),i&&i!==e&&this.onUpdateMessage(i,e,{folderId:this._draft.folderId})},hasDraft:function(){return!!this._draft.id},_removeDraft:function(){if(this._draftDeferred){var e=this,t=this._service,i=function(){e._moveDraftToTrash(t,e.getDraft().id)};this._draftDeferred.done(i).fail(i)}else this.hasDraft()&&this._moveDraftToTrash(this._service,this.getDraft().id)},_moveDraftToTrash:function(e,t){if(t){var i=e.parent().folderList;e.parent().command(f.MoveTo,{messageIds:[t],folderType:u.Trash,srcFolder:i.findByType(u.Drafts)}).exec()}},_dataSaved:function(){this.set("hasUnsavedData",!1),this._updateDataSavedTs(),this._updateTitle()},_updateDataSavedTs:function(){this.set("dataSavedTs",new Date)},_dataChanged:function(){this.sending||(this._saveDraftTimer.restart(),this.set("hasUnsavedData",!0),this._updateTitle(),this._needRefreshAfterClose=!0)},_updateTitle:function(){this.hasUnsavedData||!this.attachmentSaved?this._markAsUnsaved():this._markAsSaved()},_markAsUnsaved:function(){this._titleSet||(this._title(this._oldTitle+" *"),this._titleSet=!0)},_markAsSaved:function(){this._title(this._oldTitle),this._titleSet=!1},_close:function(){this.trigger(te)},_title:function(e){var t=this._wnd;return arguments.length?void(t&&t.title(e)):t?t.title():null},_createMsg:function(e){var t={to:this._normalizeAddresses(this.msg.to),cc:this._normalizeAddresses(this.msg.cc),bcc:this._normalizeAddresses(this.msg.bcc),subject:this.msg.subject,body:this._prepareBody(this.msg.body),isHtml:!0,highPriority:this.isSettingChecked("highPriority"),confirmRead:this.isSettingChecked("confirmRead"),confirmDelivery:this.isSettingChecked("confirmDelivery")};return e&&this._addCopyAttachments(t,this.msg.copyAttachments,this.msg.attachments),t},_addCopyAttachments:function(e,t,i){if(t&&i&&i.length>0){var n=i.map(function(e){return e.FileId}).filter(M);n.length>0&&(e.copyAttachments={folderId:t.folderId,messageId:t.messageId,files:n})}},_prepareBody:function(e){var t=this._options.draft;return e?i.format(t.bodyWrap,e):null},_normalizeAddresses:function(e){return e=e||[],e.map(function(e){return{Name:e.Name===e.Address?null:e.Name,Address:e.Address}})},_prepareAddresses:function(e){return e=e||[],e.map(function(e){return{Name:e.Name?e.Name:e.Address,Address:e.Address}})},_prepareMessageData:function(e){e&&(e.to=this._prepareAddresses(e.to),e.cc=this._prepareAddresses(e.cc),e.bcc=this._prepareAddresses(e.bcc))},_createContactDataSource:function(e,t){var i=t.contact;if(i.readListUrl){var n=new H(i.readListUrl,i.ajaxOptions.withCredentials);return e.length>0&&n.addToLocalStorage(n.createRawItems(e)),n}return new o({data:e})},onUpdateMessage:function(e,t,i){this._service.broadcast(pe,{oldMessageId:e,newMessageId:t,filter:i})},onRemoveMessage:function(e,t){this._service.broadcast(me,{messageId:e,filter:t})},_refreshMessages:function(){var e=this,t=function(){if(e.hasDraft()){var t=e.getDraft();e._service.command(f.RefreshMessages,{folderId:t.folderId,messageId:t.id}).exec()}};this._draftDeferred?this._draftDeferred.done(t).fail(t):t()},destroy:function(){this._remEditorEvents(this._editor),this.cancelSaveDraftTimer(),this.attachments.dispose(),this.msg.unbind(),this._service.removeBroadcast(p.COMPOSE_WND_FOCUS,this.onBroadcastComposeWndFocus),this.msg=this.attachments=null,this._wnd=null,this._editor=null,this._draftDeferred=null,this._saveDraftTimer=null}}),be=a.extend({init:function(e){a.fn.init.call(this),this._options=e,this.set("signature","")},fetch:function(){var e=this.parent().service,t=this;return e.getSettings().done(function(e){t._update(C(Q).get(G)),e.response&&!t.signature&&t.set("signature",e.response.MailSignature)})},_update:function(e){var t=this;e=e||{},Object.keys(e).forEach(function(i){t.set(i,e[i])})},shouldSerialize:function(e){return"_options"!==e&&a.fn.shouldSerialize.call(this,e)}}),xe=a.extend({init:function(e,t){a.fn.init.call(this),this._service=t,this._storage=C(Q),this._wnd=null,this._editor=null,this.dialogResult=!1,this.set("settings",e),this._notifyEditorChangedHandler=i.throttle(d(this._notifyEditorChanged,this),1e3)},initWnd:function(e){this._wnd=e,this._editor=this._findEditor()},save:function(){this._storage.open(),this._storage.set(G,this.settings.toJSON()),this._storage.save(!0)},onEditorKeyup:function(){this._notifyEditorChangedHandler()},onOK:function(){this.save(),this.dialogResult=!0},onCancel:function(){this.dialogResult=!1},onClose:function(){this.destroy()},close:function(){this.trigger(te)},_notifyEditorChanged:function(){this._editor&&this._editor.trigger(ee)},_findEditor:function(){return this._wnd?this._wnd.element.find(ae).data(oe):null},destroy:function(){this._wnd=null,this._editor=null}}),Me=a.extend({init:function(e){a.fn.init.call(this),this._options=e,this.compose=d(this.compose,this),this.refresh=d(this.refresh,this),this.settings=d(this.settings,this)},compose:function(){var e=this.parent().command(f.Compose);e.exec()},refresh:function(){var e=this.parent().command(f.Refresh);e.exec()},settings:function(){var e=this.parent(),t=e.command(f.EditSettings,{settings:e.settings});t.exec()}}),Re=a.extend({init:function(e){a.fn.init.call(this),this._options=e,this._saveDraftResult=d(this._saveDraftResult,this)},_getAccountId:function(){return this.parent().account.getCurrentId()},_getFolderId:function(){var e=this.parent().folderList.getCurrent();return e?e.id:null},command:function(e,t){return this.parent().command(e,t)},broadcast:function(e,t){this.parent().broadcast(e,t)},onBroadcast:function(e,t){this.parent().broadcaster.bind(e,t)},removeBroadcast:function(e,t){this.parent().broadcaster.unbind(e,t)},getAuth:function(){return this.parent().auth},getAuthToken:function(){var e=this.getAuth();return e.enabled()&&e.token?e.token:null},getAccountId:function(){return this._getAccountId()},getFolderId:function(){return this._getFolderId()},addFlag:function(e){return this._setFlag(e,!0)},removeFlag:function(e){return this._setFlag(e,!1)},moveTo:function(e,t,n){var s=this._options.message,r=i.format(s.moveToUrl,this._getAccountId(),n||this._getFolderId());return this._resourcePost(r,{Messages:t,Value:e},this.getAuthToken())},moveAll:function(e,t){var n=this._options.message,s=i.format(n.moveAllUrl,this._getAccountId(),e),r={Value:t};return this._resourcePost(s,r,this.getAuthToken())},markAsReadAll:function(e){var t=this._options.message,n=i.format(t.setReadAllUrl,this._getAccountId(),e),s={Value:!0};return this._resourcePost(n,s,this.getAuthToken())},markAsRead:function(e){return this._setRead(e,!0)},markAsUnread:function(e){return this._setRead(e,!1)},deleteAll:function(e){var t=this._options.message,n=i.format(t.deleteAllUrl,this._getAccountId(),e);return this._resourceDelete(n,null,this.getAuthToken())},deleteItems:function(e,t){var n=this._options.message,s=i.format(n.deleteItemsUrl,this._getAccountId(),e),r={Messages:t};return this._resourceDelete(s,r,this.getAuthToken())},saveDraft:function(e,t,i){return e?this.updateDraft(e,t,i):this.createDraft(i)},createDraft:function(e){var t=this._options.draft,n=i.format(t.createUrl,this._getAccountId()),s=this._createMsg(e);return this._resourcePost(n,s,this.getAuthToken()).then(this._saveDraftResult)},updateDraft:function(e,t,n){var s=this._options.draft,r=i.format(s.updateUrl,this._getAccountId(),t,e),o=this._createMsg(n);return this._resourcePut(r,o,this.getAuthToken()).then(this._saveDraftResult)},_saveDraftResult:function(e){var t=e.response||{};return{id:t.UniqueId||null,changedDate:t.Date||null,folderId:t.FolderId||null,files:t.Attachments||[]}},sendDraft:function(e,t){var n=this._options.draft,s=i.format(n.sendUrl,this._getAccountId(),t,e);return this._resourcePost(s,null,this.getAuthToken())},createFolder:function(e,t){var n=this._options.folder,s=i.format(n.createUrl,this._getAccountId()),r={Name:e,ParentId:t};return this._resourcePost(s,r,this.getAuthToken())},updateFolder:function(e,t,n){var s=this._options.folder,r=i.format(s.updateUrl,this._getAccountId(),e),o={Name:t,ParentId:n};return this._resourcePost(r,o,this.getAuthToken())},deleteFolder:function(e){var t=this._options.folder,n=i.format(t.deleteUrl,this._getAccountId(),e);return this._resourceDelete(n,null,this.getAuthToken())},getFolders:function(){var e=this._options.folder,t=i.format(e.readUrl,this._getAccountId());return this._resourceGet(t,null,this.getAuthToken())},getSettings:function(){var e=this._options.settings;return this._resourceGet(e.readUrl,null,null,e.ajaxOptions.withCredentials)},makeUploadFileUrl:function(e,t){var n=this._options.uploader,s=i.format(n.saveUrl,this._getAccountId(),t,e,this.getAuthToken());return s},makeRemoveFileUrl:function(e,t,n){var s=this._options.uploader,r=i.format(s.removeUrl,this._getAccountId(),n,e,t,this.getAuthToken());return r},makeContactImageUrl:function(e,t){var n=this._options.contact,s=n.imageUrl?i.format(n.imageUrl,encodeURIComponent(e),encodeURIComponent(t)):null;return s},makeContactPreviewUrl:function(e){var t=this._options.contact,n=t.previewUrl?i.format(t.previewUrl,encodeURIComponent(e)):null;return n},getMessageDetails:function(e){var t=this._options.message,i=t.readItemUrl,n=new V(this.getAuth(),i);return n.read({accountId:this.getAccountId(),folderId:this.getFolderId(),messageId:e}).then(function(){return w(n.data())})},_setRead:function(e,t){var n=this._options.message,s=i.format(n.setReadUrl,this._getAccountId(),this._getFolderId());return this._resourcePost(s,{Messages:e,Value:t},this.getAuthToken())},_setFlag:function(e,t){var n=this._options.message,s=i.format(n.setFlagUrl,this._getAccountId(),this._getFolderId());return this._resourcePost(s,{Messages:e,Value:t},this.getAuthToken())},_createMsg:function(e){return{To:e.to,Cc:e.cc,Bcc:e.bcc,Subject:e.subject,Body:e.body,IsHtmlBody:e.isHtml,HighPriority:!!e.highPriority,ConfirmRead:!!e.confirmRead,ConfirmDelivery:!!e.confirmDelivery,MessageAttachments:e.copyAttachments?{FolderId:e.copyAttachments.folderId,UniqueId:e.copyAttachments.messageId,Files:e.copyAttachments.files}:null}},_resourceGet:function(e,t,i,n){return this._resourceRequest(A,e,t,i,n)},_resourcePost:function(e,t,i,n){return this._resourceRequest(k,e,t,i,n)},_resourceDelete:function(e,t,i,n){return this._resourceRequest(x,e,t,i,n)},_resourcePut:function(e,t,i,n){return this._resourceRequest(b,e,t,i,n)},_resourceRequest:function(t,i,n,s,r){var o=v.call(arguments,1);if(!s)return t.apply(null,o);var a=e.Deferred();return t.apply(null,o).done(a.resolve).fail(this._makeUnauthorizedHandler(a,t,[i,n,null,r])),a},_makeUnauthorizedHandler:function(e,t,i){var n=this;return function(s){n.getAuth().enabled()&&s.jqXHR&&s.jqXHR.status===g.UNAUTHORIZED?n.getAuth().refreshToken().done(function(n){try{i[2]=n,t.apply(null,i).done(e.resolve).fail(e.reject)}catch(t){D(t.toString()),e.reject(t)}return n}).fail(function(t){return e.reject(t),t}):e.reject(s)}}}),Ue=a.extend({init:function(e){a.fn.init.call(this),this.options=e,this.auth=new q(this),this.broadcaster=new Fe,this.eventManager=new z(this),this.runningCommands=new W,this.commandFactory=O(this,this.runningCommands),this.set("inProgress",!1),this.set("disabled",!1),this._inProgressCount=0,this._hideErrorTimer=y(500,d(this.hideError,this)),this._initViewModels(e),e.autoLoad&&this._load()},_initViewModels:function(e){this.set("account",new we(this.auth,e)),this.set("folderList",new ye(this.auth,this.broadcaster,e)),this.set("messageList",new Ie(this.auth,this.broadcaster,e)),this.set("messageDetails",new Se(this.auth,this.broadcaster,e)),this.set("toolbar",new Me(e)),this.set("service",new Re(e)),this.set("contactPreview",new Ee(e)),this.set("settings",new be(e))},load:function(){this._load()},_load:function(){var e=this;this.auth.enabled()?(this.set("disabled",!0),this.auth.getToken().done(function(){e.set("disabled",!1),e._fetch()})):this._fetch()},_fetch:function(){var e=this;this.set("disabled",!0),this.settings.fetch().done(function(){e.account.fetch().then(function(){e.set("disabled",!1),e.account.switchToCurrent(),e.eventManager.start()})})},showProgress:function(){this._inProgressCount++,this.set("inProgress",!0)},hideProgress:function(){this._inProgressCount--,this._inProgressCount<=0&&(this.set("inProgress",!1),this._inProgressCount=0)},showError:function(e){D(e),this.trigger(ie,{message:e}),this._hideErrorTimer.restart()},hideError:function(){this._hideErrorTimer.cancel(),this.trigger(ne)},broadcast:function(e,t){this.broadcaster.trigger(e,t)},command:function(e,t){return this.commandFactory(e,t)}});r(s,{AccountViewModel:we,FolderListViewModel:ye,MessageListViewModel:Ie,MessageDetailsViewModel:Se,SendMessageDataViewModel:Te,AttachmentUploadViewModel:Ae,NewMessageDlgViewModel:ke,ToolbarViewModel:Me,MailServiceViewModel:Re,MailClientViewModel:Ue,ContactPreviewViewModel:Ee,SettingsDlgViewModel:xe,SettingsViewModel:be})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient",["kendo.mailclient.ns","kendo.mailclient.view-models"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.Widget,r=n.mailclient,o=i.data.Model,a=e.proxy,d=".kendoMailClient",l=r.MailClientViewModel,h="SCRIPT",c="listViewSelectItem",u="listViewClearSelection",f="listViewSelectElement",m="findMessageIFrame",p="folder",g="message",_="showError",v="hideError",C="documentClick",F="kendoMailClientListView",w="<html><body>{0}</body></html>",y=s.extend({init:function(e,t){s.fn.init.call(this,e,t),this._element(),this._viewModel(),this._view(),this._document(),this._folderListView=null,this._messageListView=null,i.notify(this)},options:{name:"MailClient",template:"",templateId:"",autoLoad:!0,account:{readUrl:""},folder:{readUrl:"",createUrl:"",updateUrl:"",deleteUrl:""},message:{readUrl:"",readItemUrl:"",attachmentUrl:"",setReadUrl:"",setFlagUrl:"",moveToUrl:"",moveAllUrl:"",setReadAllUrl:"",deleteAllUrl:"",deleteItemsUrl:"",markAsReadTimeout:2e3,pageSize:20},draft:{sendUrl:"",createUrl:"",updateUrl:"",saveTimeout:2e3,notifyChangedTimeout:500,bodyWrap:w},uploader:{saveUrl:"",readUrl:"",removeUrl:""},dialogs:{newMessage:{template:"",windowId:""},editSettings:{template:"",windowId:""}},auth:{token:{createUrl:"",field:"",method:"POST",withCredentials:!1},tokenValidation:{readUrl:"",method:"GET",withCredentials:!1}},contact:{imageUrl:"",readListUrl:"",previewUrl:"",ajaxOptions:{withCredentials:!1}},events:{polling:!1,pollingInterval:2e4},settings:{readUrl:"",ajaxOptions:{withCredentials:!1}},localization:{unsavedCloseConfirm:"You have unsaved data. Close a window?",unsavedDataConfirm:"You have unsaved data.",deleteFolderConfirm:'Are you sure you want to permanently delete the "{0}" folder?',deleteFolderToTrashConfirm:'Are you sure you want to permanently delete the "{0}" folder to trash?',
deleteAllToTrashConfirm:"Are you sure you want delete all messages to trash?",deleteAllMessagesConfirm:'Are you sure you want to permanently delete all messages in "{0}" folder?',clearTrashFolderConfirm:"Clear trash folder?",deleteMessageConfirm:'Are you sure you want to permanently delete "{0}" message?',deleteMessagesConfirm:'Are you sure you want to permanently delete "{0}" messages?',deleteFolderConfirmDescr:"",deleteAllMessagesConfirmDescr:"",clearTrashFolderConfirmDescr:"",deleteMessageConfirmDescr:"",deleteMessagesConfirmDescr:"",noSubject:"No subject",draftTitle:"Draft",folders:{drafts:"Drafts",sent:"Sent",junk:"Junk",trash:"Trash",inbox:"INBOX"},dialogs:{okText:"Ok",cancel:"Cancel"},usavedDataDialog:{okText:"Save draft",cancel:"Delete draft"}}},events:[],_element:function(){this.element.addClass("mail-client").attr("role","mailclient")},_viewModel:function(){this.viewModel=new l(this.options),this.viewModel.bind(c,a(this._listViewSelectItem,this)),this.viewModel.bind(f,a(this._listViewSelectElement,this)),this.viewModel.bind(u,a(this._listViewClearSelection,this)),this.viewModel.bind(m,a(this._findMessageIFrame,this)),this.viewModel.bind(_,a(this._showError,this)),this.viewModel.bind(v,a(this._hideError,this))},_view:function(){var e=this.options,t=e.templateId;if(!t){var n=this.element.children()[0];n&&n.tagName===h&&(t=n)}this.view=new i.View(t,{model:this.viewModel,evalTemplate:!1,wrap:!1}),this.view.render(this.element)},_document:function(){e(window.document).on("click"+d,a(this._handleDocumentClick,this))},_handleDocumentClick:function(){this.viewModel.trigger(C)},_listViewSelectItem:function(e){e.type===p&&this._getFolderListView()?e.item instanceof o&&this._getFolderListView().element.find('[data-uid="'+e.item.uid+'"]').addClass("k-state-selected"):e.type===g&&this._getMessageListView()&&e.item instanceof o&&this._getMessageListView().element.find('[data-uid="'+e.item.uid+'"]').addClass("k-state-selected")},_listViewSelectElement:function(t){if(t.type===p&&t.item instanceof Element){var i=e(t.item).closest(".k-listview").data(F);if(i){var n=this._getFolderListView();n.element.find(".k-listview").each(function(){var t=e(this).data(F);t&&t.select().length>0&&t.selectable.clear()}),n.select().length>0&&n.selectable.clear(),i.select(t.item)}}},_listViewClearSelection:function(e){e.type===g&&this._getMessageListView()?this._getMessageListView().clearSelection():e.type===p&&this._getFolderListView()&&this._getFolderListView().clearSelection()},_getFolderListView:function(){return this._folderListView||(this._folderListView=this.element.find(".folders-list.k-listview").first().data(F)),this._folderListView},_getMessageListView:function(){return this._messageListView||(this._messageListView=this.element.find(".letters-list.k-listview").data(F)),this._messageListView},_findMessageIFrame:function(e){var t=this.element.find(".letter-view .letter__body > iframe");e.result=t.length>0?t[0]:null},_showError:function(){this.element.find("> .mail-client__error").addClass("show")},_hideError:function(){this.element.find("> .mail-client__error").removeClass("show")},destroy:function(){s.fn.destroy.call(this),this.view.destroy(),e(window.document).off(d),this.element=null,this.viewModel=null,this.view=null}});i.ui.plugin(y)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.iframe",["kendo.mailclient.ns","kendo.mailclient.utils"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.Widget,r=e.proxy,o=n.mailclient,a=i.data.binders,d=i.data.Binder,l=o.createIframe,h=".kendoMailClientIFrame",c="contentUpdated",u="updated",f=s.extend({init:function(e,t){s.fn.init.call(this,e,t),this._element(),this._content(),this._iframeResizer(),i.notify(this)},options:{name:"MailClientIFrame",autoResize:!1,scrolling:!0},events:[u],_element:function(){this.element.addClass("mail-client-iframe").attr("role","mailclientiframe").attr("marginwidth","0").attr("marginheight","0").attr("frameborder","0"),this.options.scrolling?this.element.attr("scrolling","yes").css("overflow","auto"):this.element.attr("scrolling","no").css("overflow","hidden")},_content:function(){this.element.on(c+h,r(this._contentUpdated,this))},_iframeResizer:function(){this.options.autoResize&&this._defaultResizer()},_defaultResizer:function(){this._resizer=l(this.element[0],this.options.scrolling)},_contentUpdated:function(){this._resizer&&this._resizer.resize(),this.trigger(u)},destroy:function(){s.fn.destroy.call(this),this._resizer&&(this._resizer.destroy(),this._resizer=null),this.element.off(h),this.element=null}});a.widget.mailclientiframe={html:d.extend({init:function(e,t,i){d.fn.init.call(this,e.element[0],t,i),this.widget=e},refresh:function(){var e=this.widget.element[0],t=e.contentWindow?e.contentWindow.document:e.contentDocument,i=this.bindings.html.get();t.open(),t.write(i),t.close(),this._notifyContentUpdated()},_notifyContentUpdated:function(){this.widget.element.trigger(c+h)}})},i.ui.plugin(f)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.multitags",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.proxy,r=i.keys,o=i.data.binders,a=Array.isArray,d="keydown",l="change",h="requestEnd",c="sync",u="create",f=n.MultiSelect.extend({init:function(e,t){n.MultiSelect.fn.init.call(this,e,t),this._enter(),this._onDataFetchingHandler=s(this._onDataFetching,this),this._onDataFetchSuccessHandler=s(this._onDataFetchSuccess,this),this._onDataFetchErrorHandler=s(this._onDataFetchError,this),this._dataSourceEvents(),this._progressDataTemplate()},options:{name:"MailClientMultiTags",progressDataTemplate:""},_progressDataTemplate:function(){var e=this.options.progressDataTemplate;this.progressDataTemplate="function"!=typeof e?i.template(e):e},setDataSource:function(e){n.MultiSelect.fn.setDataSource.call(this,e),this._dataSourceEvents()},_dataSourceEvents:function(){this.dataSource.unbind("dataFetching",this._onDataFetchingHandler),this.dataSource.unbind("dataFetchSuccess",this._onDataFetchSuccessHandler),this.dataSource.unbind("dataFetchError",this._onDataFetchErrorHandler),this.dataSource.bind("dataFetching",this._onDataFetchingHandler),this.dataSource.bind("dataFetchSuccess",this._onDataFetchSuccessHandler),this.dataSource.bind("dataFetchError",this._onDataFetchErrorHandler)},_onDataFetching:function(e){this._updateProgress(e,!0)},_onDataFetchSuccess:function(e){this._updateProgress(e,!1)},_onDataFetchError:function(e){this._updateProgress(e,!1)},_updateProgress:function(e,t){t?this._showBusy(e):this._hideBusy(e),clearTimeout(this._renderProgressDataTimeout),clearTimeout(this._renderNoDataTimeout),this.listView._view&&0===this.listView._view.length&&(t?this._renderProgressDataTimeout=setTimeout(s(this._renderProgressData,this),100):this._renderNoDataTimeout=setTimeout(s(this._renderNoData,this),100))},_renderProgressData:function(){var e=this.noData;e&&(this._angularElement(e,"cleanup"),e.children(":first").html(this.progressDataTemplate({instance:this})),this._angularElement(e,"compile"))},_enter:function(){this.input.on(d+this.ns,s(this._inputEnter,this))},_inputEnter:function(e){e.keyCode===r.ENTER&&this._addVal(this.input.val())},_inputFocusout:function(){var e=this.input.val();n.MultiSelect.fn._inputFocusout.call(this),this._addVal(e)},_addVal:function(e){var t=this,i=this.dataSource,n=this.options,s=""!==e&&i&&n.dataTextField&&n.dataValueField;if(s){var r=i.data().filter(function(t){return t[n.dataValueField]===e});if(r.length>0)return void this._appendValue(r[0][n.dataValueField]);i.add(this._createItem(e)),i.one(h,function(e){if(e.type===u){var s=e.response,r=t._modelRawField(n.dataValueField),o=s&&a(s)?s[0]:s,d=o&&o[r]?o[r]:null;d&&i.one(c,function(){t._appendValue(d)})}}),i.sync()}},_appendValue:function(e){this.value(this.value().concat([e]))},_listChange:function(e){n.MultiSelect.fn._listChange.call(this,e),(e.added&&e.added.length>0||e.removed&&e.removed.length>0)&&this.trigger(l)},_modelRawField:function(e){var t=this.dataSource.reader.model;if(t){var i=t.fields[e];if(i)return i.field}return e},_createItem:function(e){var t={},i=this.options;return t[i.dataTextField]=e,t[i.dataValueField]=e,t},_onOpen:function(e){var t=e.sender.listView;t._view&&0===t._view.length&&e.preventDefault()}});o.widget.mailclientmultitags=o.widget.multiselect,i.ui.plugin(f)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.tooltip",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.proxy,r=".kendoMailClientTooltip",o="mouseenter",a="mouseleave",d="true",l="open",h="data-tooltip-invert",c="data-tooltip-title",u="data-tooltip-invert-title",f=n.Tooltip.extend({init:function(e,t){n.Tooltip.fn.init.call(this,e,t),this._targetContainer(),this._wrapContent()},options:{name:"MailClientTooltip",target:""},_targetContainer:function(){if(this.options.target){var t=e(this.options.target);t.on(this.options.showOn+r,this.options.filter,s(this._showOn,this)).on(o+r,this.options.filter,s(this._mouseenter,this)),this.options.autoHide&&t.on(a+r,this.options.filter,s(this._mouseleave,this))}},_wrapContent:function(){var i=this,n=this.options.content;this.options.content=function(s){var r=e(s.target);return r.attr(h)!==t?r.attr(h)===d?r.attr(u):r.attr(c):"function"==typeof n?n.call(i,s):void 0}},_initPopup:function(){n.Tooltip.fn._initPopup.apply(this,arguments),this.popup.bind(l,s(this._popupOpen,this))},_popupOpen:function(){var e=this.target();e&&e.attr("data-tooltip-invert")!==t&&this.refresh()},destroy:function(){this.options.target&&e(this.options.target).off(r),n.Tooltip.fn.destroy.call(this)}});i.ui.plugin(f)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.upload",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s="fileListCreated",r="fileListDestroyed",o=n.Upload.extend({init:function(e,t){n.Upload.fn.init.call(this,e,t)},options:{name:"MailClientUpload",cancelOnDestroy:!0},events:(n.Upload.fn.events||[]).concat([s,r]),uploadFileByUid:function(e){var t=this.findFileByUid(e);if(t){var i=this.isFileUploadStarted(t),n=this._filesContainValidationErrors(t.data("fileNames"));i||n||this._module.performUpload(t)}},hasFileByUid:function(e){return!!this.findFileByUid(e)},findFileByUid:function(t){var n=e(".k-file["+i.attr("uid")+'="'+t+'"]',this.wrapper);return n.length>0?n:null},findFileDataByUid:function(e){var t=this.findFileByUid(e);return t.length>0?(t.data("fileNames")||[])[0]:null},clearUploadedFiles:function(){var e=this,t=e.wrapper.find(".k-file.k-file-success");t.each(function(t,i){e._removeFileByDomElement(i,!1)})},addUploadedFiles:function(e){this._renderInitialFiles(e)},isFileUploadedByUid:function(e){var t=this.findFileByUid(e);return!!t&&this.isFileUploaded(t)},isFileUploaded:function(e){return e.hasClass("k-file-success")},isFileUploadStarted:function(e){return e.is(".k-file-progress, .k-file-success, .k-file-error")},fileInProgress:function(e){return e.hasClass("k-file-progress")},fileListProgress:function(t){var i=e(".k-upload-files",this.wrapper);t?i.addClass("k-upload-progress"):i.removeClass("k-upload-progress")},isFileList:function(){var t=e(".k-upload-files",this.wrapper);return t.length>0},cancelAllUpload:function(t){var i=this,n=i.wrapper.find(".k-file");n.each(function(n,s){s=e(s),i.fileInProgress(s)&&i.cancelUpload(s,t)})},cancelUpload:function(t,i){if(i)this._module.onCancel({target:e(t,this.wrapper)});else{var n=t.find(".k-upload-action");n.length&&n.find(".k-i-cancel").length&&this._onFileAction({target:n})}},_enqueueFile:function(e,t){var i=n.Upload.fn._enqueueFile.call(this,e,t);return this.isFileList()&&this.trigger(s),i},_removeFileEntry:function(e){n.Upload.fn._removeFileEntry.call(this,e),this.isFileList()||this.trigger(r)},_onParentFormReset:function(){n.Upload.fn._onParentFormReset.call(this),this.trigger(r)},_onFileProgress:function(e,t){t>=100&&(t=99),n.Upload.fn._onFileProgress.call(this,e,t)},destroy:function(){this.options.cancelOnDestroy&&this.cancelAllUpload(!0),n.Upload.fn.destroy.call(this)}});i.ui.plugin(o)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.window",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.proxy,r=".MailClientWindow",o=".k-window-title",a=o+"bar",d="open",l=n.Window.extend({init:function(e,t){n.Window.fn.init.call(this,e,t),this.options.resizable||this._maximization(),this.bind(d,s(this._handleSnap,this))},options:{name:"MailClientWindow",snapToRightBottom:!1,maximizeVmargin:0,maximizeHmargin:0},_maximization:function(){this.wrapper.on("dblclick"+r,a,s(function(t){e(t.target).closest(".k-window-action").length||this.toggleMaximization()},this))},_handleSnap:function(){var t=this.options,i=t.snapToRightBottom,n=t.isMaximized;if(i&&!n){var s,r,o=t.position,a=this.wrapper,d=e(window),l=0,h=0,c=6,u=6,f=parseInt(a.css("paddingTop"),10);t.pinned||(l=d.scrollTop(),h=d.scrollLeft()),r=h+Math.max(0,d.width()-a.width()-c),s=l+Math.max(0,d.height()-a.height()-u-f),a.css({left:r,top:s}),o.top=s,o.left=r}},_onDocumentResize:function(){var t,n,s=this.options,r=s.maximizeHmargin||0,o=s.maximizeVmargin||0,a=this.wrapper,d=e(window),l=i.support.zoomLevel();this.options.isMaximized&&(t=d.width()/l-2*r,n=d.height()/l-2*o-parseInt(a.css("padding-top"),10),a.css({width:t,height:n,left:r,top:o}),this.options.width=t,this.options.height=n,this.resize())},destroy:function(){this.wrapper.off(r),n.Window.fn.destroy.call(this)}});i.ui.plugin(l)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.resize-handle",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.Widget,r=e.proxy,o="body",a="cursor",d=27,l="percent",h=s.extend({init:function(e,t){s.fn.init.call(this,e,t),this._element(),this._init(),this._position(),i.notify(this)},options:{name:"MailClientResizeHandle",left:"",right:"",leftMin:"0rem",rightMin:"0rem",unit:l},events:[],_element:function(){this.element.addClass("mail-client-resize-handle").attr("role","mailclientresizehandle")},_init:function(){this.parentElement=this.element.parent(),this.leftElement=this.parentElement.find(this.options.left),this.rightElement=this.parentElement.find(this.options.right),this.htmlElement=e(document.documentElement),this._draggable=new n.Draggable(this.element,{group:this.element.id+"-resizing",dragstart:r(this._dragstart,this),drag:r(this._drag,this),dragend:r(this._dragend,this)})},_position:function(){var e,t=this.leftElement.outerWidth(),i=this.leftElement[0].offsetLeft,n=this.rightElement[0].offsetLeft,s=this.element.outerWidth(),r=i+t,o=Math.abs(r-n);e=s>=o?r-(s-o)/2:r,this.element.css("left",this._toCssValue(e))},_minMax:function(){var e=this.options,t=parseInt(e.leftMin,10),i=parseInt(e.rightMin,10),n={leftMin:0,rightMin:0},s=this.htmlElement.css("font-size"),r=parseInt(s,10);return isNaN(r)||r<=0?n:(isNaN(t)||(n.leftMin=t*r),isNaN(i)||(n.rightMin=i*r),n)},_dragstart:function(t){this._initialSize={leftElement:{left:this.leftElement[0].offsetLeft,width:this.leftElement.outerWidth()},rightElement:{left:this.rightElement[0].offsetLeft,width:this.rightElement.outerWidth()},handleElement:{left:this.element[0].offsetLeft,width:this.element.outerWidth()},minMax:this._minMax()},this._initialParentPos={left:this.parentElement.offset().left},e(o).css(a,t.currentTarget.css(a))},_drag:function(e){var t,i,n,s,r=this._initialSize,o=this._initialParentPos,a=r.handleElement.left,d=r.handleElement.width,l=e.x.location-o.left,h=r.leftElement.left,c=r.rightElement.left+r.rightElement.width,u=r.leftElement.width+r.rightElement.width,f=!1,m=!1;l<h&&(f=!0),l+d>c&&(m=!0);var p=l-a;t=r.leftElement.width+p,t<0&&(t=0),t>u&&(t=u),s=f?h:m?c-d:l;var g=t-r.leftElement.width;i=Math.max(r.rightElement.width-g,0);var _=i-r.rightElement.width;n=Math.max(r.rightElement.left-_,0),this.leftElement.css("width",this._toCssValue(t)),this.rightElement.css("width",this._toCssValue(i)),this.rightElement.css("left",this._toCssValue(n)),this.element.css("left",this._toCssValue(s))},_dragend:function(t){return e(o).css(a,""),t.keyCode==d&&this._resetDrag(),this._initialSize=this._initialParentPos=null,!1},_resetDrag:function(){if(this._initialSize){var e=this._initialSize.leftElement.width,t=this._initialSize.rightElement.width,i=this._initialSize.rightElement.left,n=this._initialSize.handleElement.left;this.leftElement.css("width",this._toCssValue(e)),this.rightElement.css("width",this._toCssValue(t)),this.rightElement.css("left",this._toCssValue(i)),this.element.css("left",this._toCssValue(n))}},_toPercent:function(e){return 100*parseInt(e,10)/this.parentElement.width()},_toCssValue:function(e){return this.options.unit===l?this._toPercent(e)+"%":e+"px"},destroy:function(){s.fn.destroy.call(this),this._draggable&&this._draggable.destroy(),this._draggable=null,this.leftElement=this.rightElement=this.parentElement=this.htmlElement=null,this.element=null}});i.ui.plugin(h)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.preview",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.proxy,r=e.isPlainObject,o=e.isEmptyObject,a=".kendoMailClientPreview",d="config",l="mouseenter",h="mouseleave",c="requestStart",u="error",f="beforeContentLoad",m="contentLoad",p="beforeContentError",g="contentError",_="beforeContentAppend",v={top:{origin:"top left",position:"bottom left"}},C=n.Tooltip.extend({init:function(e,t){n.Tooltip.fn.init.call(this,e,t),this._filter(),this._targetContainer(),this._templates(),this._setupEvents(),this._cache={},this._ajaxJsonErrorHandler=s(this._ajaxJsonErrorHandler,this),this._ajaxJsonSuccessHandler=s(this._ajaxJsonSuccessHandler,this),this._popupMouseEnter=s(this._popupMouseEnter,this),this._popupMouseLeave=s(this._popupMouseLeave,this)},options:{name:"MailClientPreview",target:"",template:"",errorTemplate:"",caching:!1,iframe:!1,autoHide:!0,cssProgress:"",cssPopup:"",closeDelay:50},events:(n.Tooltip.fn.events||[]).concat([f,p,_,g]),_filter:function(){this.options.filter=(this.options.filter||"").replace(/\\/g,"")},_templates:function(){this.template=i.template(this.options.template),this.errorTemplate=i.template(this.options.errorTemplate)},_targetContainer:function(){if(this.options.target){var t=e(this.options.target);t.on(this.options.showOn+a,this.options.filter,s(this._showOn,this)).on(l+a,this.options.filter,s(this._mouseenter,this)),this.options.autoHide&&t.on(h+a,this.options.filter,s(this._mouseleave,this))}},_initPopup:function(){n.Tooltip.fn._initPopup.apply(this,arguments),this.popup.element.addClass(this.options.cssPopup).on(l+a,this._popupMouseEnter).on(h+a,this._popupMouseLeave);var e=v[this.options.position];e&&(e.origin&&(this.popup.options.origin=e.origin),e.position&&(this.popup.options.position=e.position))},_popupMouseEnter:function(){clearTimeout(this._closeTimeout)},_popupMouseLeave:function(){this.popup&&this.popup.close(),clearTimeout(this.timeout)},_mouseleave:function(){var e=this;return this.popup?(this._closeTimeout=setTimeout(function(){e.popup.close()},this.options.closeDelay),void clearTimeout(this.timeout)):void n.Tooltip.fn._mouseleave.apply(this,arguments)},_appendContent:function(e){var i=this.options.content,s=this.content;return this.trigger(_,{target:e}),r(i)&&i.url&&this.options.caching&&i.url!==d&&this._cache[i.url]!==t?void s.html(this._cache[i.url]):void n.Tooltip.fn._appendContent.apply(this,arguments)},_setupEvents:function(){this.bind(c,s(this._requestStart,this)),this.bind(m,s(this._requestEnd,this)),this.bind(u,s(this._requestFailed,this))},_requestStart:function(){var e=this.options,t=e.content,i=r(t)&&t.url;i&&"json"===t.dataType&&(t.success=this._ajaxJsonSuccessHandler,t.error=this._ajaxJsonErrorHandler),this._addProgressCss()},_requestEnd:function(){this._removeProgressCss()},_requestFailed:function(){this._removeProgressCss(),this._contentError()},_contentError:function(){if(this.options.errorTemplate){var e={data:{},template:null};this.trigger(p,e)||(this.content.html((e.template||this.errorTemplate)(e.data||{})),this.trigger(g))}},_addProgressCss:function(){this.options.cssProgress&&this.popup&&this.popup.element.addClass(this.options.cssProgress)},_removeProgressCss:function(){this.options.cssProgress&&this.popup&&this.popup.element.removeClass(this.options.cssProgress)},_ajaxJsonErrorHandler:function(e,t){i.ui.progress(this.content,!1),this.trigger(u,{status:t,xhr:e})},_ajaxJsonSuccessHandler:function(e){e=e||{},i.ui.progress(this.content,!1);var t={response:e};if(!this.trigger(f,t)){if(o(t.response))return this._contentError(),void this._requestEnd();var n=this.template(t.response||e);this.options.caching&&(this._cache[this.options.content.url]=n),this.content.html(n),this.trigger(m)}},destroy:function(){this.options.target&&e(this.options.target).off(a),this.popup&&this.popup.element.off(a),n.Tooltip.fn.destroy.call(this)}});i.ui.plugin(C)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.listview",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=i.keys,r=e.proxy,o="start",a="move",d="end",l=">*:not(.k-loading-mask)",h="draghint",c="dragstart",u="dragend",f="dragenter",m="dragleave",p="drop",g=".kendoMailClientListView",_=n.ListView.extend({init:function(e,t){n.ListView.fn.init.call(this,e,t),this._draggable(),this._hover()},options:{name:"MailClientListView",draggable:!1,draggableFilter:l,draggableGroup:"default",hintTemplate:"",dropArea:null,dropGroup:"default",dropFilter:null,preventDragEnd:!0,hintOnCenter:!0,cssDropTargetActive:"",cssHintOnDropTarget:"",cssHover:"",hoverFilter:"",autoRefresh:!1},events:(n.ListView.fn.events||[]).concat([h,p]),setDataSource:function(e){n.ListView.fn.setDataSource.call(this,e),this.options.autoRefresh&&this.refresh()},_templates:function(){n.ListView.fn._templates.call(this),this.hintTemplate=i.template(this.options.hintTemplate||"")},_hover:function(){var t=this.options;t.hoverFilter&&this.element.on("mouseenter"+g,t.hoverFilter,function(i){e(i.currentTarget).addClass(t.cssHover)}).on("mouseleave"+g,t.hoverFilter,function(i){e(i.currentTarget).removeClass(t.cssHover)})},_selectable:function(){n.ListView.fn._selectable.call(this);var e=this,t=this.options,i=this.selectable,r=i&&i.options.multiple&&t.draggable,l=this.options.navigatable;r&&i.userEvents.unbind(o).unbind(a).unbind(d),l&&e.element.on("keydown"+g,function(t){var i=t.keyCode,n=e.current();s.UP===i||s.LEFT===i?(t.target==t.currentTarget&&t.preventDefault(),e.selectable.clear(),e.selectable.value(n&&n[0]?n:e._item("last"))):s.DOWN!==i&&s.RIGHT!==i||(t.target==t.currentTarget&&t.preventDefault(),e.selectable.clear(),e.selectable.value(n&&n[0]?n:e._item("first")))})},_draggable:function(){var e=this.options;e.draggable&&(this.draggable=new n.Draggable(this.element,{filter:e.draggableFilter,group:e.draggableGroup,hint:r(this._dragHint,this),dragstart:r(this._dragStart,this),dragend:r(this._dragEnd,this)}),e.dropArea&&(this.dropArea=new n.DropTargetArea(e.dropArea,{group:e.dropGroup,filter:e.dropFilter,drop:r(this._drop,this),dragenter:r(this._dragEnter,this),dragleave:r(this._dragLeave,this)})))},_dragHint:function(t){var i={hintData:{},target:t};return this.trigger(h,i),this.options.hintTemplate?e(this.hintTemplate(i.hintData||{})):t.clone()},_dragStart:function(e){this.options.hintOnCenter&&this._hintCenter(e),this.trigger(c,{origin:e})},_dragEnd:function(e){this.trigger(u,{origin:e}),this.options.preventDragEnd&&e.preventDefault()},_dragEnter:function(e){this._dragEnterCss(e.dropTarget,e.draggable),this.trigger(f,{origin:e})},_dragLeave:function(e){this._dragLeaveCss(e.dropTarget,e.draggable),this.trigger(m,{origin:e})},_drop:function(e){this._dragLeaveCss(e.dropTarget,e.draggable),this.trigger(p,{origin:e})},_dragEnterCss:function(e,t){var i=this.options.cssDropTargetActive,n=this.options.cssHintOnDropTarget;i&&e&&e.addClass(i),n&&t&&t.hint&&t.hint.addClass(n)},_dragLeaveCss:function(e,t){var i=this.options.cssDropTargetActive,n=this.options.cssHintOnDropTarget;i&&e&&e.removeClass(i),n&&t&&t.hint&&t.hint.removeClass(n)},_hintCenter:function(e){var t=e.sender,i=t.hintOffset,n=t.hint,s=e.x.location,r=e.y.location;if(n&&i){var o=n.width()/2,a=n.height()/2,d=s-i.left-o,l=r-i.top-a;n.css({marginLeft:d,marginTop:l})}},destroy:function(){this.draggable&&(this.draggable.destroy(),this.draggable=null),this.dropArea&&(this.dropArea.destroy(),this.dropArea=null),this.element.off("keydown"+g).off("mouseenter"+g).off("mouseleave"+g),n.ListView.fn.destroy.call(this)}});i.ui.plugin(_)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.contextmenu",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=e.proxy,r=".kendoMenu",o="default",a="prevent",d="open",l="close",h=n.ContextMenu.extend({init:function(e,t){n.ContextMenu.fn.init.call(this,e,t),this.bind(d,s(this._onOpen,this)),this.bind(l,s(this._onClose,this))},options:{name:"MailClientContextMenu",withTarget:!1,ignore:"",openIgnore:o,cssOpenTarget:""},_onOpen:function(e){this._addCss(e.target)},_onClose:function(e){this._removeCss(e.target)},_addCss:function(t){t&&this.options.cssOpenTarget&&e(t).addClass(this.options.cssOpenTarget)},_popupTarget:function(){return this.popup.options.anchor},_removeCss:function(t){t&&this.options.cssOpenTarget&&e(t).removeClass(this.options.cssOpenTarget)},_wire:function(){n.ContextMenu.fn._wire.call(this);var e=this.options;e.filter&&this.target[0]&&e.withTarget&&this.target.on(e.showOn+r+this._marker,this._showProxy),this.target[0]&&e.ignore&&this.target.on(e.showOn+r+this._marker,e.ignore,s(this._ignoreHandler,this))},_ignoreHandler:function(e){this.options.openIgnore===a&&e.preventDefault(),e.stopImmediatePropagation()},_showHandler:function(e){var t=this.options,i=t.filter,s=e.currentTarget===this.target[0],r=t.withTarget&&i&&s,o=this._popupTarget(),a=e.currentTarget!==this._popupTarget();a&&this._removeCss(o),r&&(t.filter=null),n.ContextMenu.fn._showHandler.call(this,e),r&&(t.filter=i)}});i.ui.plugin(h)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.droptargetarea",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s="default",r="dragenter",o="dragleave",a="drop",d=n.Widget.extend({init:function(e,t){n.Widget.fn.init.call(this,e,t),this._dropTargetAreas()},options:{name:"MailClientDropTargetArea",target:"",filter:null,groups:[],group:s},_dropTargetAreas:function(){var t=this,i=this.options,s=i.groups.length?i.groups:[i.group],d=i.filter,l=i.target?e(i.target):this.element,h=d?n.DropTargetArea:n.DropTarget,c=[];s.forEach(function(e){c.push(new h(l,{filter:d,group:e,drop:t._eventProxy(a),dragenter:t._eventProxy(r),dragleave:t._eventProxy(o)}))}),this.dropTargetList=c},_eventProxy:function(e){var t=this;return function(i){t.trigger(e,i)}},destroy:function(){this.dropTargetList&&(this.dropTargetList.forEach(function(e){e.destroy(),e.element=null}),this.dropTargetList=null),n.Widget.fn.destroy.call(this)}});i.ui.plugin(d)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.modal",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.Confirm,r=n.Widget,o="k-confirm",a="ok",d="cancel",l=s.extend({_init:function(e,t){s.fn._init.call(this,e,t),this.wrapper.removeClass(o).addClass("mail-client-modal")},events:(n.Confirm.fn.events||[]).concat([a,d]),options:{name:"MailClientModal",modal:!0,actions:[{text:"#= messages.okText #",primary:!0,action:function(e){var t=!e.sender.trigger(a);return e.sender.result.resolve(),t}},{text:"#= messages.cancel #",action:function(e){var t=!e.sender.trigger(d);return e.sender.result.reject(),t}}]},_destroy:function(){s.fn._destroy.call(this),r.fn.destroy.call(this),i.destroy(this.wrapper)}});i.ui.plugin(l)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.commands",["kendo.mailclient.ns","kendo.mailclient.utils","kendo.mailclient.constants","kendo.mailclient.view-models","kendo.mailclient.data","kendo.mailclient.models","kendo.mailclient.commandutil"],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.ui,s=n.mailclient,r=e.proxy,o=e.extend,a=i.Class,d=i.data.ObservableObject,l=Array.isArray,h=s.CommandState,c=s.Commands,u=s.BroadcastEvents,f=s.FolderType,m=s.arrayCount,p=s.isFn,g=s.isDate,_=s.notNullFilter,v=s.filterByField,C=s.onlyUnique,F=s.registerCommand,w=s.first,y=s.NewMessageDlgViewModel,D=s.SettingsDlgViewModel,I=s.Recipient,S=s.createWndDialog,E="add",T="remove",A=a.extend({init:function(e){this.options=e,this.mailclient=e.mailclient,this.service=this.mailclient.service,this.widgetOpt=e.widgetOpt,this.noProgressBar=!!e.noProgressBar,this.type=e.commandType,this.runningCommands=e.runningCommands,this.state=h.Init,this.execDeferred=null,this.lastError=null,this._pending=r(this._pending,this),this._done=r(this._done,this),this._error=r(this._error,this)},isPending:function(){return this.state===h.Pending},isCompleted:function(){return this.state===h.Failed||this.state===h.Success},_showProgress:function(){this.noProgressBar||this.mailclient.showProgress()},_hideProgress:function(){this.noProgressBar||this.mailclient.hideProgress()},progressBar:function(e){this.noProgressBar=!e},_pending:function(){this.state=h.Pending,this._showProgress()},_done:function(){this._running(!1),this.state=h.Success,this._hideProgress(),this.execDeferred&&this.execDeferred.resolve()},_error:function(e,i){i=i===t||i,this._running(!1),this.state=h.Failed,this.lastError=e,i&&this._hideProgress(),this.mailclient.showError(e.toString()),this.execDeferred&&this.execDeferred.reject(e)},_deferred:function(t){return this.execDeferred&&!t||(this.execDeferred=e.Deferred()),this.execDeferred},_running:function(e){this.runningCommands&&(e?this.runningCommands.add(this):this.runningCommands.remove(this))},_baseExec:function(){this._running(!0)},exec:function(){throw new Error("Not implemented.")}}),k=A.extend({init:function(e){A.fn.init.call(this,e),this._handleMoveTo=r(this._handleMoveTo,this)},exec:function(){var e=this.options,t=e.messageIds,i=e.folderType,n=e.folderId,s=this.mailclient.folderList,r=e.srcFolder||s.getCurrent(),o=r?r.id:null;if(this._baseExec(),this._deferred(!0),!n&&i){var a=s.findByType(i);n=a?a.id:null}return n?(e.srcFolderId=o,e.destFolderId=n,this._pending(),this.service.moveTo(n,t,o).then(this._handleMoveTo).done(this._done).fail(this._error),this._deferred()):(this._error(new Error("Unknown folder id."),!1),this._deferred())},_handleMoveTo:function(){var e=this.options,t=this.mailclient.folderList,i=this.mailclient.messageDetails,n=this.mailclient.messageList,s=e.srcFolderId,r=e.destFolderId,o=e.messageIds,a=t.find(s),d=t.find(r),l=t.getCurrent(),h=i.getCurrent(),c=a&&l&&a.id===l.id,u=o.map(function(e){return n.find(e)}).filter(_),f=u.length,p=m(u,v("isRead",!1));
if(c){var g=h&&!!m(u,v("id",h.id));g&&i.close(),n.removeList(u),!g&&h&&n.select(h.id)}a&&(a.subTotalItemCount(f),a.subUnreadItemCount(p)),d&&(d.addTotalItemCount(f),d.addUnreadItemCount(p))}}),b=A.extend({init:function(e){A.fn.init.call(this,e),this._handleMoveAll=r(this._handleMoveAll,this)},exec:function(){var e=this.options,t=e.srcFolderId,i=e.destFolderId;return this._baseExec(),this._deferred(!0),t&&i?(this._pending(),this.service.moveAll(t,i).then(this._handleMoveAll).done(this._done).fail(this._error),this._deferred()):(this._error(new Error("srcFolderId and destFolderId parameters is required."),!1),this._deferred())},_handleMoveAll:function(){var e=this.options,t=this.mailclient.folderList,i=this.mailclient.messageList,n=e.srcFolderId,s=e.destFolderId,r=t.getCurrent(),o=t.find(n),a=t.find(s);if(r)if(r.id===n)i.clearAll();else if(r.id===s){var d=i.dataSource;d.inProgress()||this.mailclient.command(c.Refresh,{noRefreshFolders:!0}).exec()}o&&a&&(a.addUnreadItemCount(o.unreadItemCount),o.resetCounters())}}),x=A.extend({init:function(e){A.fn.init.call(this,e),this._handleDeleteAll=r(this._handleDeleteAll,this)},exec:function(){var e=this.options,t=e.folderId;return this._baseExec(),this._deferred(!0),t?(this._pending(),this.service.deleteAll(t).then(this._handleDeleteAll).done(this._done).fail(this._error),this._deferred()):(this._error(new Error("folderId parameter is required."),!1),this._deferred())},_handleDeleteAll:function(){var e=this.options,t=this.mailclient.folderList,i=this.mailclient.messageList,n=e.folderId,s=t.getCurrent(),r=t.find(n);s&&s.id===n&&i.clearAll(),r&&r.resetCounters()}}),M=A.extend({init:function(e){A.fn.init.call(this,e),this._handleDelete=r(this._handleDelete,this)},exec:function(){var e=this.options,t=e.messageIds||[],i=e.folderId;return this._baseExec(),this._deferred(!0),i&&0!==t.length?(this._pending(),this.service.deleteItems(i,t).then(this._handleDelete).done(this._done).fail(this._error),this._deferred()):(this._error(new Error("folderId and messageIds is required."),!1),this._deferred())},_handleDelete:function(){var e=this.options,t=this.mailclient.folderList,i=this.mailclient.messageDetails,n=this.mailclient.messageList,s=e.folderId,r=e.messageIds,o=t.find(s),a=t.getCurrent(),d=i.getCurrent(),l=o&&a&&o.id===a.id,h=r.map(function(e){return n.find(e)}).filter(_),c=h.length,u=m(h,v("isRead",!1));if(l){var f=d&&!!m(h,v("id",d.id));f&&i.close(),n.removeList(h),!f&&d&&n.select(d.id)}o&&(o.subTotalItemCount(c),o.subUnreadItemCount(u))}}),R=A.extend({init:function(e){A.fn.init.call(this,e)},_exec:function(e,t){var i=this.options,n=i.messageIds,s=i.action;if(this._baseExec(),this._deferred(!0),!e[s])return this._error(new Error("Unknown service function."),!1),this._deferred();var r=this._findMessages(n);return i.folderIds=this._findFolderIds(r),this._pending(),e[s].call(null,n).then(t).done(this._done).fail(this._error),this._deferred()},_handle:function(e,t){var i=this.options,n=i.messageIds,s=i.folderIds,r=i.action,o=r===E,a=this._findMessages(n),d=this.mailclient.messageDetails.getCurrent();if(a.forEach(function(t){p(t,e)&&t[e](o)}),d){var l=n.filter(function(e){return e===d.id}).length>0;l&&p(d,e)&&d[e](o)}t&&this._updateCounters(s||[],t[r],a.length)},_updateCounters:function(e,t,i){var n=this._findFolders(e);"string"==typeof t&&n.length>0&&n.forEach(function(e){p(e,t)&&e[t](i)})},_findFolderIds:function(e){return e.map(function(e){return e.folderId})},_findFolders:function(e){var t=this.mailclient.folderList;return e.filter(C).map(function(e){return t.find(e)}).filter(_)},_findMessages:function(e){var t=this.mailclient.messageList;return e.map(function(e){return t.find(e)}).filter(_)}}),U=R.extend({init:function(e){e.action=E,R.fn.init.call(this,e)},exec:function(){var e={},t=this.service,i=this;return e[E]=t.addFlag.bind(t),this._exec(e,function(){i._handle("setFlag")})}}),L=R.extend({init:function(e){e.action=T,R.fn.init.call(this,e)},exec:function(){var e={},t=this.service,i=this;return e[T]=t.removeFlag.bind(t),this._exec(e,function(){i._handle("setFlag")})}}),P=R.extend({init:function(e){e.action=E,R.fn.init.call(this,e)},exec:function(){var e={},t={},i=this.service,n=this;return e[E]=i.markAsRead.bind(i),t[E]="subUnreadItemCount",this._exec(e,function(){n._handle("setRead",t),i.broadcast(u.MARK_AS_READ)})}}),O=R.extend({init:function(e){e.action=T,R.fn.init.call(this,e)},exec:function(){var e={},t={},i=this.service,n=this;return e[T]=i.markAsUnread.bind(i),t[T]="addUnreadItemCount",this._exec(e,function(){n._handle("setRead",t),i.broadcast(u.MARK_AS_UNREAD)})}}),N=A.extend({init:function(e){A.fn.init.call(this,e),this.noProgressBar=!0,this.viewModel=null},exec:function(){var e=this,i=this.options,n=i.messageData||{},s=i.isSignature,r=i.title,a=this.service,d=this.widgetOpt,l=d.dialogs,h=i.isMaximize;this._baseExec(),this._deferred(!0),(s===t||s)&&(n.body=this._addBodySignature(n.body,!0)),this.viewModel=new y(d,a,n);var c=S(o({isMaximize:h},l.newMessage),this.viewModel);return c.onClose(function(){e._done(),e.viewModel=null}),c.show(),r&&c.getWnd().title(r),this.viewModel.setWnd(c.getWnd()),this._deferred()},_addBodySignature:function(e,t){var i=this.mailclient.settings,n=i.signature;if(n){var s=this._makeBodySignature(n,t);return this._appendToHtml(e,s)}return e},_makeBodySignature:function(e,t){var n;return n=t?"<br/><br/>-- <div>"+e+"</div>":"\r\n\r\n-- \r\n"+i.htmlEncode(e)},_appendToHtml:function(e,t){var i=/<\/body>/i,n=/<\/html>/i;return this._replaceText(e,null,[i,n],null,t)},_prependHtml:function(e,t){var i=/<html( [^>]+)?>/i,n=/<body( [^>]+)?>/i,s=/<\/head>/i;return this._replaceText(e,[n,s,i],null,t,null)},_replaceText:function(e,t,i,n,s){var r=e||"",o=!1,a=!1;if(n){t=t||[];for(var d=0;d<t.length;d++)if(t[d].test(r)){r=r.replace(t[d],"$&"+n),o=!0;break}o||(r=n+r)}if(s){i=i||[];for(var l=0;l<i.length;l++)if(i[l].test(r)){r=r.replace(i[l],s+"$&"),a=!0;break}a||(r+=s)}return r}}),B=N.extend({init:function(e){N.fn.init.call(this,this._prepareOptions(e)),this._handleGetMessage=r(this._handleGetMessage,this)},exec:function(){var e=this.options,t=this.service,i=e.messageId,n=e.messageDetails;return i?(this._deferred(!0),this.progressBar(!0),this._pending(),t.getMessageDetails(i).done(this._handleGetMessage).fail(this._error),this._deferred()):(n&&(this._extendMessageData(e,this._convertToMessageData(n)),this._prepareOptions(e)),N.fn.exec.call(this))},_handleGetMessage:function(e){var t=this.options,i=this._deferred();this._hideProgress(),this.progressBar(!1),this._extendMessageData(t,this._convertToMessageData(e)),this._prepareOptions(t),N.fn.exec.call(this).done(i.resolve).fail(i.reject)},_extendMessageData:function(e,t){o(e,{messageData:t})},_convertToMessageData:function(e){var t=e.toJSON(),i={from:t.from,to:t.to,cc:t.cc,subject:t.subject,body:t.body,sentDate:t.sentDate,isHtml:t.isHtml};return i},_prepareOptions:function(e){var t=e.messageData;if(t){var i=e.mailclient.account.getCurrent(),n=this._makeReplyTo(t.from),s=this._makeReplyCopyTo(i,t.to,t.cc,e.isAll),r=this._makeSubject(t.subject),o=this._makeBody(t);t.to=n,t.cc=s,t.subject=r,t.body=o,e.title=r}return e},_makeSubject:function(e){return"Re: "+e},_makeReplyTo:function(e){var t=l(e)?e:e?[e]:[];return t=this._normalizeRecipientForEditor(t)},_makeReplyCopyTo:function(e,t,i,n){if(!n)return[];var s=[],r=l(t)&&t.length>0,o=l(i)&&i.length>0;if(r){var a=t.filter(function(t){return!e||e.address!==t.Address});s=s.concat(a)}return o&&(s=s.concat(i)),s=this._normalizeRecipientForEditor(s)},_makeBody:function(e,t){var i=e.body,n=this._makeInfo(e);return this._makeHtmlBody(i,n,t)},_makeHtmlBody:function(e,t,i){var n="",s="",r=e||"";if(n=i?"<br/>":"<br/><br/>",t&&(n+="<div>"+t+"</div>"),i)n+="<br/><br/>";else{var o="margin: 10px;";o+="border-left: 1px solid #00a7e1;",o+="padding: 0 0 0 10px;",o='style="'+o+'"',n+="<blockquote "+o+">",s="</blockquote>"}return r=this._prependHtml(r,n),r=this._appendToHtml(r,s)},_makeInfo:function(e){var t=e.from?[e.from]:[],n=e.sentDate,s=e.isHtml,r=I.fromRaw(t),o=this._formatDate(n);return r.length>0&&(o+=" ",o+=r.map(function(e){return e.toString()}).join(", ")),o=o?o.trim()+":":"",s&&(o=i.htmlEncode(o)),o},_normalizeRecipientForEditor:function(e){return e=e||[],e.forEach(function(e){e&&!e.Name&&(e.Name=e.Address)}),e},_formatDate:function(e){return g(e)?i.toString(e,"dd MMM yyyy г., HH:mm"):""}}),j=B.extend({_prepareOptions:function(e){var t=e.messageData;if(t){var i=this._makeSubject(t.subject),n=this._makeBody(t,!0,!0);t.to=[],t.cc=[],t.subject=i,t.body=n,e.title=i}return e},_convertToMessageData:function(e){var t=B.fn._convertToMessageData.call(this,e),i=e.attachments?e.attachments.toJSON():[];return i&&i.length>0&&(t.attachments=i,t.copyAttachments={folderId:e.folderId,messageId:e.id}),t},_makeSubject:function(e){return"Fwd: "+e},_makeInfo:function(e){var t=e.from,n=e.to,s=e.cc,r=e.sentDate,o=e.subject,a={from:null,date:null,subject:null,to:null,cc:null},d="---------- Пересылаемое сообщение ----------<br/>#if (from) {#От кого: ${from}<br/>#}##if (date) {#Дата: ${date}<br/>#}##if (subject) {#Тема: ${subject}<br/>#}##if (to) {#Кому: ${to}<br/>#}##if (cc) {#Копия: ${cc}<br/>#}#",h=i.template(d);return a.from=t?I.fromRaw(t).toString():null,a.subject=o,a.date=this._formatDate(r),l(n)&&n.length>0&&(a.to=n.map(function(e){return e.Address}).join(", ")),l(s)&&s.length>0&&(a.cc=n.map(function(e){return e.Address}).join(", ")),h(a)}}),V=A.extend({init:function(e){A.fn.init.call(this,e),this.noProgressBar=!0},exec:function(){var t,i,n=this,s=this.options,r=this.mailclient,o=r.account.getCurrentId(),a=r.folderList,d=r.messageList,l=s.noRefreshFolders,h=s.noRefreshMessages;if(this._baseExec(),this._deferred(!0),!o)return this._error(new Error("Could not found current account id."),!1),this._deferred();this._pending();var c=a.dataSource.inProgress(),u=d.dataSource.inProgress();return c||l||(t=a.fetch(o).then(function(){a.reselect()})),u||h||(i=d.dataSource.read().then(function(){d.reselect(),n._maybeCloseViewedMessage()})),t||i?e.when(t,i).done(this._done).fail(this._error):this._done(),this._deferred()},_maybeCloseViewedMessage:function(){var e=this.mailclient,t=e.messageDetails.getCurrent();t&&!e.messageList.find(t.id)&&e.messageDetails.close()}}),H=A.extend({init:function(e){A.fn.init.call(this,e),this._handleSave=r(this._handleSave,this)},exec:function(){var e=this.options,i=e.model,n=i?i.id:e.folderId,s=i?i.parentId:e.parentId,r=i?i.displayName:e.displayName;return this._baseExec(),this._deferred(!0),this._pending(),r=r===t?null:r||"",s=s===t?null:s||"",n?this.service.updateFolder(n,r,s).then(this._handleSave).done(this._done).fail(this._error):this.service.createFolder(r,s).then(this._handleSave).done(this._done).fail(this._error),this._deferred()},_handleSave:function(e){var t=this.options,i=t.model,n=i?i.id:t.folderId,s=e?e.response:null,r=(s||{}).Current||s,o=(s||{}).SubFolders||[];r&&i?(i.id&&this._clearMessages(i),this._updateModel(i,r)):r&&n&&(i=this._findModel(n),i&&(this._clearMessages(i),this._updateSubtreeAndSelf(i,r,o)))},_findModel:function(e){return this.mailclient.folderList.find(e)},_updateModel:function(e,t){var i=this.mailclient.folderList,n=i.dataSource;n.updateIdentifiers(e,t)},_updateSubtreeAndSelf:function(e,t,i){i=i||[];var n=this.mailclient.folderList,s=n.dataSource;e&&t&&(s.updateIdentifiers(e,t),i.length>0&&s.updateSubtree(e,i))},_clearMessages:function(e){var t=this.mailclient.folderList,i=this.mailclient.messageList;t.isSubtreeOrSelfSelected(e)&&(t.clearSelection(),i.clearAll())}}),q=H.extend({init:function(e){H.fn.init.call(this,e)}}),z=H.extend({init:function(e){H.fn.init.call(this,e)}}),W=A.extend({init:function(e){A.fn.init.call(this,e),this._handleRemove=r(this._handleRemove,this)},exec:function(){var e=this,t=this.options,i=t.folderId;return this._baseExec(),this._deferred(!0),i?(this._pending(),this._removeSubFolders(i).done(function(){e.service.deleteFolder(i).then(e._handleRemove).done(e._done).fail(e._error)}).fail(this._error),this._deferred()):(this._error(new Error("Parameter folderId is required."),!1),this._deferred())},_removeSubFolders:function(t){var i=this,n=this.mailclient.folderList,s=n.find(t),r=s?n.dataSource.flattenArrayBy(s):[],o=r.reverse(),a=[];return o.forEach(function(e){a.push(i.service.deleteFolder(e.id).then(function(){n.remove(e)}))}),e.when.apply(null,a)},_handleRemove:function(){var e=this.options,t=e.folderId,i=this.mailclient.folderList,n=i.find(t);n&&i.remove(n)}}),Q=A.extend({init:function(e){A.fn.init.call(this,e),this._handleMoveFolder=r(this._handleMoveFolder,this),this._updateState=r(this._updateState,this)},exec:function(){var e=this.options,t=e.folderId;return this._baseExec(),this._deferred(!0),t?(this._pending(),this._fetchFolders().done(this._handleMoveFolder).fail(this._error),this._deferred()):(this._error(new Error("Parameter folderId is required."),!1),this._deferred())},_handleMoveFolder:function(e){var t=this,i=this.options,n=i.folderId,s=e.response||[],r=t._findFolder(n,s);if(r){var o=t._findFolderByType(f.Trash,s);if(!o)return void this._error(new Error("Trash folder not found."));if(r.FolderId===o.FolderId)return void this._error(new Error("Cannot move folder to Trash."));var a=t._createNewFolderName(r,o,s);this._moveFolderToTrash(r.FolderId,o.FolderId,a).done(this._done).fail(this._error)}else this._error(new Error("Folder not found with id: "+n))},_findFolder:function(e,t){return w(t.filter(v("FolderId",e)))},_findFolderByType:function(e,t){return w(t.filter(v("Type",e)))},_fetchFolders:function(){return this.service.getFolders()},_createNewFolderName:function(e,t,i){var n=e.Title||"",s=i.filter(v("ParentId",t.FolderId));if(!s.length)return n;var r=s.filter(function(e){return(e.Title||"").toUpperCase()===n.toUpperCase()});if(!r.length)return n;var o=new RegExp(n+"_(\\d+)","i"),a=s.map(function(e){var t=o.exec(e.Title||"");return null!==t&&t[1]?+t[1]:0}),d=Math.max.apply(null,a)||1;return n=n+"_"+(d+1)},_moveFolderToTrash:function(e,t,i){var n=this.mailclient.folderList,s=n.find(e),r=n.find(t),o=s?n.getParent(s):null,a=this.mailclient.command(c.UpdateFolder,{folderId:e,parentId:t,displayName:i});return a.exec().done(function(){s&&r&&o&&(s.setDisplayName(i),n.changeParent(s,r,o))})}}),J=A.extend({init:function(e){A.fn.init.call(this,e),this._handleClearAll=r(this._handleClearAll,this)},exec:function(){var e=this.options,t=e.folderId;return this._baseExec(),this._deferred(!0),t?(this._pending(),this._handleClearAll(),this._deferred()):(this._error(new Error("Parameter folderId is required."),!1),this._deferred())},_handleClearAll:function(){var t=this.options,i=t.folderId,n=this.mailclient.folderList,s=n.find(i),r=this.mailclient;if(s){var o=[],a=r.command(c.DeleteAll,{folderId:i});o.push(a.exec());var d=s.children;d&&d.data().forEach(function(e){var t=r.command(c.RemoveFolder,{folderId:e.id});o.push(t.exec())}),e.when.apply(null,o).done(this._done).fail(this._error)}else this._error(new Error("Error when clear all folder."),!0)}}),G=A.extend({init:function(e){A.fn.init.call(this,e),this._updateState=r(this._updateState,this)},exec:function(){var e=this.options,t=e.folderId;return this._baseExec(),this._deferred(!0),t?(this._pending(),this.service.markAsReadAll(t).then(this._updateState).done(this._done).fail(this._error),this._deferred()):(this._error(new Error("Parameter folderId is required."),!1),this._deferred())},_updateState:function(){var e=this.options,t=e.folderId,i=this.mailclient.folderList,n=this.mailclient.messageList,s=i.getCurrent();s&&s.id===t&&(n.dataSource.data().forEach(function(e){e.setRead(!0)}),s.setUnreadItemCount(0))}}),X=A.extend({init:function(e){A.fn.init.call(this,e),this.noProgressBar=!0},exec:function(){var e=this,t=this.options,i=t.folderId,n=t.messageId,s=this.mailclient,r=s.messageList,o=s.folderList.getCurrent(),a=!i||o&&o.id===i;return this._baseExec(),this._deferred(!0),a?(this._pending(),r.dataSource.read().then(function(){r.reselect();var t=e._refreshMessage(n);t?t.done(e._done).fail(e._error):e._done()}).fail(this._error)):this._done(),this._deferred()},_refreshMessage:function(e){var t=this.mailclient,i=t.messageDetails.isCurrent(e);return i?this._openMessage(e):null},_openMessage:function(e){var t=this.mailclient,i=this.service,n=i.getAccountId(),s=i.getFolderId();return n&&s&&e?t.messageDetails.show(n,s,e):null}}),Y=N.extend({init:function(e){e=o(e||{},{isSignature:!1,isMaximize:!0}),N.fn.init.call(this,e),this._handleEditDraft=r(this._handleEditDraft,this)},exec:function(){var e=this.options,t=e.messageId,i=e.messageDetails,n=this.service;return t?(this._deferred(!0),this.progressBar(!0),this._pending(),n.getMessageDetails(t).done(this._handleEditDraft).fail(this._error),this._deferred()):(i&&this._prepareOptions(i),N.fn.exec.call(this))},_handleEditDraft:function(e){var t=this._deferred();this._hideProgress(),this.progressBar(!1),this._prepareOptions(e),N.fn.exec.call(this).done(t.resolve).fail(t.reject)},_prepareOptions:function(e){var t=this.options,i=this.widgetOpt.localization;o(t,{title:e.subject||i.draftTitle,messageData:this._convertToMessageData(e)})},_convertToMessageData:function(e){var t=e.toJSON(),i={to:t.to,cc:t.cc,bcc:t.bcc,subject:t.subject,body:t.body,sentDate:t.sentDate,isHtml:t.isHtml,messageId:e.id,folderId:t.folderId,attachments:t.attachments,highPriority:t.highPriority,confirmRead:t.confirmRead,confirmDelivery:t.confirmDelivery};return i}}),K=Y.extend({init:function(e){Y.fn.init.call(this,e)},_prepareOptions:function(e){var t=this.options;o(t,{messageData:this._convertToMessageData(e)})},_convertToMessageData:function(e){var t=e.toJSON(),i=e.attachments?e.attachments.toJSON():[],n={to:t.to,cc:t.cc,bcc:t.bcc,subject:t.subject,body:t.body,sentDate:t.sentDate,isHtml:t.isHtml,highPriority:t.highPriority,confirmRead:t.confirmRead,confirmDelivery:t.confirmDelivery};return i&&i.length>0&&(n.attachments=i,n.copyAttachments={folderId:e.folderId,messageId:e.id}),n}}),$=A.extend({init:function(e){A.fn.init.call(this,e),this.noProgressBar=!0},exec:function(){var e=this,t=this.options,i=t.settings,n=this.service,s=this.widgetOpt,r=s.dialogs;if(this._baseExec(),this._deferred(!0),!i)return this._error(new Error("settings parameter is required."),!1),this._deferred();i instanceof d&&(i=i.toJSON());var o=new D(i,n),a=S(r.editSettings,o,!0);return a.onClose(function(i){if(i){var n=o.settings.toJSON();t.settings instanceof d?e._updateObservableObject(t.settings,n):e._updateObject(t.settings,n)}e._done()}),a.show(),o.initWnd(a.getWnd()),this._deferred()},_updateObservableObject:function(e,t){Object.keys(t).forEach(function(i){e.set(i,t[i])})},_updateObject:function(e,t){o(e,t)}});F(c.MoveTo,k),F(c.MoveAll,b),F(c.DeleteAll,x),F(c.Delete,M),F(c.AddFlag,U),F(c.RemoveFlag,L),F(c.MarkAsRead,P),F(c.MarkAsUnread,O),F(c.Compose,N),F(c.Reply,B),F(c.Forward,j),F(c.Refresh,V),F(c.NewFolder,q),F(c.UpdateFolder,z),F(c.RemoveFolder,W),F(c.RemoveFolderToTrash,Q),F(c.ClearAllFolder,J),F(c.MarkAsReadFolder,G),F(c.RefreshMessages,X),F(c.EditDraft,Y),F(c.EditSettings,$),F(c.EditAsNew,K)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.binders",[],e)}(function(){"use strict";return function(e,t){var i=window.kendo,n=i.data.Binder,s=i.data.binders;s.focus=n.extend({refresh:function(){var t=this.bindings.focus.get();t?e(this.element).focus():e(this.element).blur()}}),s.focusIn=n.extend({refresh:function(){var t=this.bindings.focusIn.get();t&&e(this.element).focus()}})}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()}),function(e,t){"use strict";t("kendo.mailclient.core",["kendo.mailclient","kendo.mailclient.ns","kendo.mailclient.utils","kendo.mailclient.constants","kendo.mailclient.iframe","kendo.mailclient.multitags","kendo.mailclient.tooltip","kendo.mailclient.upload","kendo.mailclient.window","kendo.mailclient.resize-handle","kendo.mailclient.preview","kendo.mailclient.listview","kendo.mailclient.contextmenu","kendo.mailclient.droptargetarea","kendo.mailclient.modal","kendo.mailclient.models","kendo.mailclient.data","kendo.mailclient.models","kendo.mailclient.view-models","kendo.mailclient.commands","kendo.mailclient.commandutil","kendo.mailclient.binders","kendo.mailclient.events"],e)}(function(){"use strict";return window.kendo},"function"==typeof define&&define.amd?define:function(e,t,i){"use strict";(i||t)()});